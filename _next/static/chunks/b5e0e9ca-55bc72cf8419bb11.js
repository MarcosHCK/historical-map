"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[841],{5882:(e,t,r)=>{let i;function o(e,t){let r=t[0],i=t[1];return[e[0]*r+e[2]*i+e[4],e[1]*r+e[3]*i+e[5]]}function s(e,t,r,i,o,s,n){let a=Math.sin(o),l=Math.cos(o);return[r*l,i*a,-r*a,i*l,s*r*l-n*r*a+e,s*i*a+n*i*l+t]}function n(e){var t;let r=(t=e)[0]*t[3]-t[1]*t[2],i=e[0],o=e[1],s=e[2],n=e[3],a=e[4],l=e[5];return[n/r,-o/r,-s/r,i/r,(s*l-n*a)/r,-(i*l-o*a)/r]}function a(e){let t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];return t[0]=e[0],t[1]=e[1],t[4]=e[2],t[5]=e[3],t[12]=e[4],t[13]=e[5],t}async function l(e,t,r){let i;if(!(i="function"==typeof r?await r(e,t):await fetch(e,t)).ok)throw Error(i.statusText);return i}async function h(e,t,r){return await (await l(e,t,r)).json()}async function u(e,t,r){return await h(`${e}/info.json`,t,r)}function c(e,t){if(0===e.length)return e;let r=[];for(let i=0;i<e.length;i++)r.push(function(e,t){let r=0,i=0;for(let t=0,o=e.length,s=o-1;t<o;s=t++){let o=(e[t][0]-e[s][0])*(e[s][1]+e[t][1]),n=r+o;i+=Math.abs(r)>=Math.abs(o)?r-n+o:o-n+r,r=n}return r+i>=0!=!!t?e.slice().reverse():e}(e[i],0===i?t:!t));return r}function d(e){return Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1]}function p(e){return Array.isArray(e)&&e.every(d)}function f(e){return Array.isArray(e)&&e.every(d)}function m(e){return Array.isArray(e)&&e.every(f)}function g(e){return Array.isArray(e)&&e.every(d)}function v(e){return Array.isArray(e)&&e.every(p)}function y(e){return Array.isArray(e)&&e.every(m)}function w(e){if((e=e.filter(function(e,t,r){return 0===t||!E(e,r[t-1])})).length<2)throw Error("LineString should contain at least 2 points");return e}function x(e){var t;if(Array.isArray(t=e=e.filter(function(e,t,r){return 0===t||!E(e,r[t-1])}))&&t.length>=2&&E(t[0],t[t.length-1])&&e.splice(-1),e.length<3)throw Error("Ring should contain at least 3 points");return e}function _(e){return e.map(e=>x(e))}function b(e){return{type:"Point",coordinates:e}}function M(e){return{type:"LineString",coordinates:e}}function T(e,t=!0){return function e(t,r=!1){switch(t.type){case"Polygon":return t.coordinates?{...t,coordinates:c(t.coordinates,r)}:t;case"MultiPolygon":return t.coordinates?{...t,coordinates:t.coordinates.map(e=>c(e,r))}:t;case"GeometryCollection":return{...t,geometries:t.geometries.map(t=>e(t,r))};default:return t}}({type:"Polygon",coordinates:t?e.map(e=>[...e,e[0]]):e})}function E(e,t){return e===t||null!==e&&null!==t&&e[0]===t[0]&&e[1]===t[1]}function P(e,t){if(e.length!=t.length)throw Error("Point arrays should be of same lenght");return e.map((e,r)=>[e,t[r]])}function S(e){return e.reduce((t,r,i)=>[...t,[r,e[(i+1)%e.length]]],[])}function R(e,t){return[(t[0]-e[0])/2+e[0],(t[1]-e[1])/2+e[1]]}r.d(t,{d:()=>am});function I(e,t,r){var i,o;return[(i=e[0],i*(1-r)+t[0]*r),(o=e[1],o*(1-r)+t[1]*r)]}function C(e,t){if(p(e)&&2===e.length)return C(e[0],e[1]);if(d(e)&&void 0===t)return C(e,[0,0]);if(d(e)&&d(t))return Math.sqrt(A(e,t));throw Error("Input type not supported")}function A(e,t){if(p(e)&&2===e.length)return A(e[0],e[1]);if(d(e)&&void 0===t)return A(e,[0,0]);if(d(e)&&d(t))return(t[0]-e[0])**2+(t[1]-e[1])**2;throw Error("Input type not supported")}function L(e){return"object"==typeof e&&null!==e&&"Point"===e.type&&d(e.coordinates)}function j(e){return"object"==typeof e&&null!==e&&"LineString"===e.type&&p(e.coordinates)}function k(e){return"object"==typeof e&&null!==e&&"Polygon"===e.type&&Array.isArray(e.coordinates)&&m(e.coordinates)}function F(e){return"object"==typeof e&&null!==e&&"MultiPoint"===e.type&&g(e.coordinates)}function O(e){return"object"==typeof e&&null!==e&&"MultiLineString"===e.type&&v(e.coordinates)}function D(e){return"object"==typeof e&&null!==e&&"MultiPolygon"===e.type&&Array.isArray(e.coordinates)&&y(e.coordinates)}function G(e){return e.coordinates}function N(e){return w(e.coordinates)}function z(e,t=!1){let r=e.coordinates;return r=_(r),t?r.map(e=>[...e,e[0]]):r}function B(e){return e.coordinates.map(e=>({type:"Point",coordinates:e}))}function U(e){return e.coordinates.map(e=>({type:"LineString",coordinates:e}))}function V(e){return e.coordinates.map(e=>({type:"Polygon",coordinates:e}))}function W(e){return{type:"MultiPoint",coordinates:e.map(e=>e.coordinates)}}function Z(e){return{type:"MultiLineString",coordinates:e.map(e=>e.coordinates)}}function q(e){return{type:"MultiPolygon",coordinates:e.map(e=>e.coordinates)}}function $(e){return e.geometry}function X(e){let t=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY;for(let i of e)void 0===t?i>=i&&(t=r=i):(t>i&&(t=i),r<i&&(r=i));return[t,r]}function H(e){if(d(e)&&(e=[e]),m(e)&&(e=e.flat()),function(e){let t="object"==typeof e&&null!==e,r=t&&"type"in e&&"string"==typeof e.type&&("Point"===e.type||"LineString"===e.type||"Polygon"===e.type||"MultiPoint"===e.type||"MultiLineString"===e.type||"MultiPolygon"===e.type),i=t&&"coordinates"in e&&Array.isArray(e.coordinates);return r&&i}(e))return H(function(e){if(L(e))return G(e);if(j(e))return N(e);if(k(e))return z(e);if(F(e))return e.coordinates;if(O(e))return e.coordinates.map(e=>w(e));if(D(e))return function(e,t=!1){let r=e.coordinates;return r=r.map(e=>_(e)),t?r.map(e=>e.map(e=>[...e,e[0]])):r}(e);throw Error("Geometry type not supported")}(e));let t=[],r=[];for(let i of e)t.push(i[0]),r.push(i[1]);let[i,o]=X(t),[s,n]=X(r);return[i,s,o,n]}function Y(e,t){return[Math.min(e[0],t[0]),Math.min(e[1],t[1]),Math.max(e[2],t[2]),Math.max(e[3],t[3])]}function K(e,t){if(0==t)return e;let r=et(e);return function(e,t,r){return void 0===r&&(r=t),[e[0]-t,e[1]-r,e[2]+t,e[3]+r]}(e,...r.map(e=>e*t/2))}function J(e){return[[e[0],e[1]],[e[2],e[1]],[e[2],e[3]],[e[0],e[3]]]}function Q(e){return[[e[0],e[1]],[e[2],e[3]]]}function ee(e){return[(e[0]+e[2])/2,(e[1]+e[3])/2]}function et(e){return[e[2]-e[0],e[3]-e[1]]}function er(e){return[.5*(C(e[0],e[1])+C(e[2],e[3])),.5*(C(e[1],e[2])+C(e[3],e[0]))]}function ei(e,t,r){return r?"contain"===r?t[0]>=t[1]?e[0]/t[0]:e[1]/t[1]:t[0]>=t[1]?e[1]/t[1]:e[0]/t[0]:Math.sqrt(e[0]*e[1]/(t[0]*t[1]))}function eo(e,t,r,i=!0){if(e.has(t)&&i)return e.get(t);{let i=r();return e.set(t,i),i}}function es(e,t,r,i,o=!0){if(e.get(t)?.has(r)&&o)return e.get(t)?.get(r);{let o=i();return e.get(t)||e.set(t,new Map),e.get(t)?.set(r,o),o}}function en(e){return(function(e){let t=parseInt(e.replace(/^#/,""),16);return[t>>16&255,t>>8&255,255&t]})(e).map(e=>e/255)}function ea(e,t){return void 0!==e&&void 0!==t?Math.max(e,t):void 0!==e?e:void 0!==t?t:void 0}function el(e,t){return t?{...e,...t}:e}var eh,eu,ec,ed,ep,ef,em=/[a-zA-Z0-9:_-]/,eg=/[\s\t\r\n]/,ev=/['"]/;function ey(e,t){return Number(e?.properties?.[t])||0}function ew(e){let t=e?.properties?.points;return t?String(t).trim().split(/\s+/).map(e=>{let t=e.split(",").map(e=>Number(e));return[t[0],t[1]]}):[]}function ex(e){return e.map(e=>e.join(",")).join(" ")}function e_(e){if("circle"===e.type)return eb("circle",{...e.attributes,cx:e.coordinates[0],cy:e.coordinates[1]});if("line"===e.type)return eb("line",{...e.attributes,x1:e.coordinates[0][0],y1:e.coordinates[0][1],x2:e.coordinates[1][0],y2:e.coordinates[1][1]});if("polyline"===e.type)return eb("polyline",{...e.attributes,points:ex(e.coordinates)});if("polygon"===e.type)return eb("polygon",{...e.attributes,points:ex(e.coordinates)});if("rect"===e.type)return eb("rect",{...e.attributes,x:e.coordinates[0][0],y:e.coordinates[0][1],width:e.coordinates[1][0]-e.coordinates[0][0],height:e.coordinates[2][1]-e.coordinates[0][1]});throw Error("Unknown SVG element")}function eb(e,t){let r=Object.entries(t).map(([e,t])=>`${e}="${t}"`);return`<${e} ${r.join(" ")} />`}function eM([e,t]){return[Math.PI/180*e*6378137,6378137*Math.log(Math.tan(Math.PI/4+Math.PI/180*t/2))]}function eT([e,t]){let r=6378137*Math.PI,i=t/r*180;return[e/r*180,i=180/Math.PI*(2*Math.atan(Math.exp(i*Math.PI/180))-Math.PI/2)]}let eE=class e{geoCenter;geoRectangle;geoSize;geoResolution;geoRectangleBbox;projectedGeoCenter;projectedGeoRectangle;projectedGeoSize;projectedGeoResolution;projectedGeoRectangleBbox;rotation;projectedGeoPerViewportScale;viewportCenter;viewportRectangle;viewportSize;viewportResolution;viewportBbox;devicePixelRatio;canvasCenter;canvasRectangle;canvasSize;canvasResolution;canvasBbox;projectedGeoPerCanvasScale;projectedGeoToViewportTransform=[1,0,0,1,0,0];projectedGeoToClipTransform=[1,0,0,1,0,0];viewportToClipTransform=[1,0,0,1,0,0];constructor(e,t,r,i,o=1){this.projectedGeoCenter=t,this.projectedGeoPerViewportScale=r,this.rotation=i,this.viewportSize=e,this.devicePixelRatio=o,this.projectedGeoRectangle=this.computeProjectedGeoRectangle(this.projectedGeoCenter,this.projectedGeoPerViewportScale,this.rotation,this.viewportSize),this.projectedGeoRectangleBbox=H(this.projectedGeoRectangle),this.projectedGeoSize=[this.viewportSize[0]*r,this.viewportSize[1]*r],this.projectedGeoResolution=this.projectedGeoSize[0]*this.projectedGeoSize[1],this.geoCenter=eT(this.projectedGeoCenter),this.geoRectangle=this.projectedGeoRectangle.map(e=>eT(e)),this.geoRectangleBbox=H(this.geoRectangle),this.geoSize=et(this.geoRectangleBbox),this.geoResolution=this.geoSize[0]*this.geoSize[1],this.viewportResolution=this.viewportSize[0]*this.viewportSize[1],this.viewportCenter=[this.viewportSize[0]/2,this.viewportSize[1]/2],this.viewportBbox=[0,0,...this.viewportSize],this.viewportRectangle=J(this.viewportBbox),this.canvasCenter=[this.viewportCenter[0]*this.devicePixelRatio,this.viewportSize[1]*this.devicePixelRatio],this.canvasSize=[this.viewportSize[0]*this.devicePixelRatio,this.viewportSize[1]*this.devicePixelRatio],this.canvasResolution=this.canvasSize[0]*this.canvasSize[1],this.canvasBbox=[0,0,...this.canvasSize],this.canvasRectangle=J(this.canvasBbox),this.projectedGeoPerCanvasScale=this.projectedGeoPerViewportScale/this.devicePixelRatio,this.projectedGeoToViewportTransform=this.composeProjectedGeoToViewportTransform(),this.projectedGeoToClipTransform=this.composeProjectedGeoToClipTransform(),this.viewportToClipTransform=this.composeViewportToClipTransform()}static fromWarpedMapList(t,r,i,o="contain",s=1){let n=r.getProjectedCenter(),a=r.getProjectedBbox();if(!n||!a)throw Error("WarpedMapList has no projected center or bbox");let l=ei(et(a),t,o)*(1/s);return new e(t,n,l,0,i)}static fromProjectedGeoBbox(t,r,i,o="contain"){let s=ee(r),n=ei(et(r),t,o);return new e(t,s,n,0,i)}getProjectedGeoBufferedRectangle(e){return J(K(this.viewportBbox,e)).map(e=>o(n(this.projectedGeoToViewportTransform),e))}composeProjectedGeoToViewportTransform(){return s(this.viewportCenter[0],this.viewportCenter[1],1/this.projectedGeoPerViewportScale,-1/this.projectedGeoPerViewportScale,-this.rotation,-this.projectedGeoCenter[0],-this.projectedGeoCenter[1])}composeProjectedGeoToClipTransform(){return s(0,0,2/(this.projectedGeoPerViewportScale*this.viewportSize[0]),2/(this.projectedGeoPerViewportScale*this.viewportSize[1]),-this.rotation,-this.projectedGeoCenter[0],-this.projectedGeoCenter[1])}composeViewportToClipTransform(){return s(0,0,2/this.viewportSize[0],-2/this.viewportSize[1],0,-this.viewportCenter[0],-this.viewportCenter[1])}computeProjectedGeoRectangle(e,t,r,i){let o=t*i[0]/2,s=t*i[1]/2,n=Math.cos(r),a=Math.sin(r),l=o*n,h=o*a,u=s*n,c=s*a,d=e[0],p=e[1];return[[d-l+c,p-h-u],[d-l-c,p-h+u],[d+l-c,p+h+u],[d+l+c,p+h-u]]}};async function eP(e){return Array.from(new Uint8Array(await crypto.subtle.digest("SHA-1",new TextEncoder().encode(e)))).map(e=>e.toString(16).padStart(2,"0")).join("")}async function eS(e,t=16){return(await eP(String(e))).slice(0,t)}async function eR(e,t){return await eS(function e(t){return Array.isArray(t)?`[${t.map(t=>e(t)).join(",")}]`:"number"==typeof t?`${t}`:"string"==typeof t?`"${t}"`:"object"==typeof t&&null!==t?Object.keys(t).sort().map(r=>`${r}:${e(t[r])}`).join("|"):String(t)}(e),t)}!function(e){e.assertEqual=e=>e,e.assertIs=function(e){},e.assertNever=function(e){throw Error()},e.arrayToEnum=e=>{let t={};for(let r of e)t[r]=r;return t},e.getValidEnumValues=t=>{let r=e.objectKeys(t).filter(e=>"number"!=typeof t[t[e]]),i={};for(let e of r)i[e]=t[e];return e.objectValues(i)},e.objectValues=t=>e.objectKeys(t).map(function(e){return t[e]}),e.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{let t=[];for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.push(r);return t},e.find=(e,t)=>{for(let r of e)if(t(r))return r},e.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&isFinite(e)&&Math.floor(e)===e,e.joinValues=function(e,t=" | "){return e.map(e=>"string"==typeof e?`'${e}'`:e).join(t)},e.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t}(eh||(eh={})),(eu||(eu={})).mergeShapes=(e,t)=>({...e,...t});let eI=eh.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),eC=e=>{switch(typeof e){case"undefined":return eI.undefined;case"string":return eI.string;case"number":return isNaN(e)?eI.nan:eI.number;case"boolean":return eI.boolean;case"function":return eI.function;case"bigint":return eI.bigint;case"symbol":return eI.symbol;case"object":return Array.isArray(e)?eI.array:null===e?eI.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?eI.promise:"u">typeof Map&&e instanceof Map?eI.map:"u">typeof Set&&e instanceof Set?eI.set:"u">typeof Date&&e instanceof Date?eI.date:eI.object;default:return eI.unknown}},eA=eh.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class eL extends Error{constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};let t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){let t=e||function(e){return e.message},r={_errors:[]},i=e=>{for(let o of e.issues)if("invalid_union"===o.code)o.unionErrors.map(i);else if("invalid_return_type"===o.code)i(o.returnTypeError);else if("invalid_arguments"===o.code)i(o.argumentsError);else if(0===o.path.length)r._errors.push(t(o));else{let e=r,i=0;for(;i<o.path.length;){let r=o.path[i];i===o.path.length-1?(e[r]=e[r]||{_errors:[]},e[r]._errors.push(t(o))):e[r]=e[r]||{_errors:[]},e=e[r],i++}}};return i(this),r}static assert(e){if(!(e instanceof eL))throw Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,eh.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=e=>e.message){let t={},r=[];for(let i of this.issues)i.path.length>0?(t[i.path[0]]=t[i.path[0]]||[],t[i.path[0]].push(e(i))):r.push(e(i));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}}eL.create=e=>new eL(e);let ej=(e,t)=>{let r;switch(e.code){case eA.invalid_type:r=e.received===eI.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case eA.invalid_literal:r=`Invalid literal value, expected ${JSON.stringify(e.expected,eh.jsonStringifyReplacer)}`;break;case eA.unrecognized_keys:r=`Unrecognized key(s) in object: ${eh.joinValues(e.keys,", ")}`;break;case eA.invalid_union:r="Invalid input";break;case eA.invalid_union_discriminator:r=`Invalid discriminator value. Expected ${eh.joinValues(e.options)}`;break;case eA.invalid_enum_value:r=`Invalid enum value. Expected ${eh.joinValues(e.options)}, received '${e.received}'`;break;case eA.invalid_arguments:r="Invalid function arguments";break;case eA.invalid_return_type:r="Invalid function return type";break;case eA.invalid_date:r="Invalid date";break;case eA.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(r=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(r=`${r} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?r=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?r=`Invalid input: must end with "${e.validation.endsWith}"`:eh.assertNever(e.validation):r="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case eA.too_small:r="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case eA.too_big:r="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case eA.custom:r="Invalid input";break;case eA.invalid_intersection_types:r="Intersection results could not be merged";break;case eA.not_multiple_of:r=`Number must be a multiple of ${e.multipleOf}`;break;case eA.not_finite:r="Number must be finite";break;default:r=t.defaultError,eh.assertNever(e)}return{message:r}},ek=ej;function eF(){return ek}let eO=e=>{let{data:t,path:r,errorMaps:i,issueData:o}=e,s=[...r,...o.path||[]],n={...o,path:s};if(void 0!==o.message)return{...o,path:s,message:o.message};let a="";for(let e of i.filter(e=>!!e).slice().reverse())a=e(n,{data:t,defaultError:a}).message;return{...o,path:s,message:a}};function eD(e,t){let r=eF(),i=eO({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,r,r===ej?void 0:ej].filter(e=>!!e)});e.common.issues.push(i)}class eG{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){let r=[];for(let i of t){if("aborted"===i.status)return eN;"dirty"===i.status&&e.dirty(),r.push(i.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){let r=[];for(let e of t){let t=await e.key,i=await e.value;r.push({key:t,value:i})}return eG.mergeObjectSync(e,r)}static mergeObjectSync(e,t){let r={};for(let i of t){let{key:t,value:o}=i;if("aborted"===t.status||"aborted"===o.status)return eN;"dirty"===t.status&&e.dirty(),"dirty"===o.status&&e.dirty(),"__proto__"!==t.value&&("u">typeof o.value||i.alwaysSet)&&(r[t.value]=o.value)}return{status:e.value,value:r}}}let eN=Object.freeze({status:"aborted"}),ez=e=>({status:"dirty",value:e}),eB=e=>({status:"valid",value:e}),eU=e=>"aborted"===e.status,eV=e=>"dirty"===e.status,eW=e=>"valid"===e.status,eZ=e=>"u">typeof Promise&&e instanceof Promise;function eq(e,t,r,i){if("function"==typeof t?e!==t||!i:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return t.get(e)}function e$(e,t,r,i,o){if("function"==typeof t?e!==t||!o:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return t.set(e,r),r}!function(e){e.errToObj=e=>"string"==typeof e?{message:e}:e||{},e.toString=e=>"string"==typeof e?e:e?.message}(ec||(ec={}));class eX{constructor(e,t,r,i){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=i}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}let eH=(e,t)=>{if(eW(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;let t=new eL(e.common.issues);return this._error=t,this._error}}};function eY(e){if(!e)return{};let{errorMap:t,invalid_type_error:r,required_error:i,description:o}=e;if(t&&(r||i))throw Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');return t?{errorMap:t,description:o}:{errorMap:(t,o)=>{var s,n;let{message:a}=e;return"invalid_enum_value"===t.code?{message:a??o.defaultError}:typeof o.data>"u"?{message:null!=(s=a??i)?s:o.defaultError}:"invalid_type"!==t.code?{message:o.defaultError}:{message:null!=(n=a??r)?n:o.defaultError}},description:o}}class eK{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return eC(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:eC(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new eG,ctx:{common:e.parent.common,data:e.data,parsedType:eC(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){let t=this._parse(e);if(eZ(t))throw Error("Synchronous parse encountered promise.");return t}_parseAsync(e){return Promise.resolve(this._parse(e))}parse(e,t){let r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){var r;let i={common:{issues:[],async:null!=(r=t?.async)&&r,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:eC(e)},o=this._parseSync({data:e,path:i.path,parent:i});return eH(i,o)}async parseAsync(e,t){let r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){let r={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:eC(e)},i=this._parse({data:e,path:r.path,parent:r});return eH(r,await (eZ(i)?i:Promise.resolve(i)))}refine(e,t){let r=e=>"string"==typeof t||typeof t>"u"?{message:t}:"function"==typeof t?t(e):t;return this._refinement((t,i)=>{let o=e(t),s=()=>i.addIssue({code:eA.custom,...r(t)});return"u">typeof Promise&&o instanceof Promise?o.then(e=>!!e||(s(),!1)):!!o||(s(),!1)})}refinement(e,t){return this._refinement((r,i)=>!!e(r)||(i.addIssue("function"==typeof t?t(r,i):t),!1))}_refinement(e){return new tA({schema:this,typeName:ef.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return tL.create(this,this._def)}nullable(){return tj.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return tf.create(this,this._def)}promise(){return tC.create(this,this._def)}or(e){return tg.create([this,e],this._def)}and(e){return tw.create(this,e,this._def)}transform(e){return new tA({...eY(this._def),schema:this,typeName:ef.ZodEffects,effect:{type:"transform",transform:e}})}default(e){return new tk({...eY(this._def),innerType:this,defaultValue:"function"==typeof e?e:()=>e,typeName:ef.ZodDefault})}brand(){return new tG({typeName:ef.ZodBranded,type:this,...eY(this._def)})}catch(e){return new tF({...eY(this._def),innerType:this,catchValue:"function"==typeof e?e:()=>e,typeName:ef.ZodCatch})}describe(e){return new this.constructor({...this._def,description:e})}pipe(e){return tN.create(this,e)}readonly(){return tz.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}let eJ=/^c[^\s-]{8,}$/i,eQ=/^[0-9a-z]+$/,e0=/^[0-9A-HJKMNP-TV-Z]{26}$/,e1=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,e2=/^[a-z0-9_-]{21}$/i,e3=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,e4=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,e5=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,e9=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,e6=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,e8="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",e7=RegExp(`^${e8}$`);function te(e){let t="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`),t}function tt(e){let t=`${e8}T${te(e)}`,r=[];return r.push(e.local?"Z?":"Z"),e.offset&&r.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${r.join("|")})`,RegExp(`^${t}$`)}class tr extends eK{_parse(e){let t;if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==eI.string){let t=this._getOrReturnCtx(e);return eD(t,{code:eA.invalid_type,expected:eI.string,received:t.parsedType}),eN}let r=new eG;for(let n of this._def.checks)if("min"===n.kind)e.data.length<n.value&&(eD(t=this._getOrReturnCtx(e,t),{code:eA.too_small,minimum:n.value,type:"string",inclusive:!0,exact:!1,message:n.message}),r.dirty());else if("max"===n.kind)e.data.length>n.value&&(eD(t=this._getOrReturnCtx(e,t),{code:eA.too_big,maximum:n.value,type:"string",inclusive:!0,exact:!1,message:n.message}),r.dirty());else if("length"===n.kind){let i=e.data.length>n.value,o=e.data.length<n.value;(i||o)&&(t=this._getOrReturnCtx(e,t),i?eD(t,{code:eA.too_big,maximum:n.value,type:"string",inclusive:!0,exact:!0,message:n.message}):o&&eD(t,{code:eA.too_small,minimum:n.value,type:"string",inclusive:!0,exact:!0,message:n.message}),r.dirty())}else if("email"===n.kind)e4.test(e.data)||(eD(t=this._getOrReturnCtx(e,t),{validation:"email",code:eA.invalid_string,message:n.message}),r.dirty());else if("emoji"===n.kind)i||(i=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),i.test(e.data)||(eD(t=this._getOrReturnCtx(e,t),{validation:"emoji",code:eA.invalid_string,message:n.message}),r.dirty());else if("uuid"===n.kind)e1.test(e.data)||(eD(t=this._getOrReturnCtx(e,t),{validation:"uuid",code:eA.invalid_string,message:n.message}),r.dirty());else if("nanoid"===n.kind)e2.test(e.data)||(eD(t=this._getOrReturnCtx(e,t),{validation:"nanoid",code:eA.invalid_string,message:n.message}),r.dirty());else if("cuid"===n.kind)eJ.test(e.data)||(eD(t=this._getOrReturnCtx(e,t),{validation:"cuid",code:eA.invalid_string,message:n.message}),r.dirty());else if("cuid2"===n.kind)eQ.test(e.data)||(eD(t=this._getOrReturnCtx(e,t),{validation:"cuid2",code:eA.invalid_string,message:n.message}),r.dirty());else if("ulid"===n.kind)e0.test(e.data)||(eD(t=this._getOrReturnCtx(e,t),{validation:"ulid",code:eA.invalid_string,message:n.message}),r.dirty());else if("url"===n.kind)try{new URL(e.data)}catch{eD(t=this._getOrReturnCtx(e,t),{validation:"url",code:eA.invalid_string,message:n.message}),r.dirty()}else{var o,s;"regex"===n.kind?(n.regex.lastIndex=0,n.regex.test(e.data)||(eD(t=this._getOrReturnCtx(e,t),{validation:"regex",code:eA.invalid_string,message:n.message}),r.dirty())):"trim"===n.kind?e.data=e.data.trim():"includes"===n.kind?e.data.includes(n.value,n.position)||(eD(t=this._getOrReturnCtx(e,t),{code:eA.invalid_string,validation:{includes:n.value,position:n.position},message:n.message}),r.dirty()):"toLowerCase"===n.kind?e.data=e.data.toLowerCase():"toUpperCase"===n.kind?e.data=e.data.toUpperCase():"startsWith"===n.kind?e.data.startsWith(n.value)||(eD(t=this._getOrReturnCtx(e,t),{code:eA.invalid_string,validation:{startsWith:n.value},message:n.message}),r.dirty()):"endsWith"===n.kind?e.data.endsWith(n.value)||(eD(t=this._getOrReturnCtx(e,t),{code:eA.invalid_string,validation:{endsWith:n.value},message:n.message}),r.dirty()):"datetime"===n.kind?tt(n).test(e.data)||(eD(t=this._getOrReturnCtx(e,t),{code:eA.invalid_string,validation:"datetime",message:n.message}),r.dirty()):"date"===n.kind?e7.test(e.data)||(eD(t=this._getOrReturnCtx(e,t),{code:eA.invalid_string,validation:"date",message:n.message}),r.dirty()):"time"===n.kind?RegExp(`^${te(n)}$`).test(e.data)||(eD(t=this._getOrReturnCtx(e,t),{code:eA.invalid_string,validation:"time",message:n.message}),r.dirty()):"duration"===n.kind?e3.test(e.data)||(eD(t=this._getOrReturnCtx(e,t),{validation:"duration",code:eA.invalid_string,message:n.message}),r.dirty()):"ip"===n.kind?(o=e.data,("v4"===(s=n.version)||!s)&&e5.test(o)||("v6"===s||!s)&&e9.test(o)||(eD(t=this._getOrReturnCtx(e,t),{validation:"ip",code:eA.invalid_string,message:n.message}),r.dirty())):"base64"===n.kind?e6.test(e.data)||(eD(t=this._getOrReturnCtx(e,t),{validation:"base64",code:eA.invalid_string,message:n.message}),r.dirty()):eh.assertNever(n)}return{status:r.value,value:e.data}}_regex(e,t,r){return this.refinement(t=>e.test(t),{validation:t,code:eA.invalid_string,...ec.errToObj(r)})}_addCheck(e){return new tr({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...ec.errToObj(e)})}url(e){return this._addCheck({kind:"url",...ec.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...ec.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...ec.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...ec.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...ec.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...ec.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...ec.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...ec.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...ec.errToObj(e)})}datetime(e){var t,r;return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof e?.precision>"u"?null:e?.precision,offset:null!=(t=e?.offset)&&t,local:null!=(r=e?.local)&&r,...ec.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof e?.precision>"u"?null:e?.precision,...ec.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...ec.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...ec.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...ec.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...ec.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...ec.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...ec.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...ec.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...ec.errToObj(t)})}nonempty(e){return this.min(1,ec.errToObj(e))}trim(){return new tr({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new tr({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new tr({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>"datetime"===e.kind)}get isDate(){return!!this._def.checks.find(e=>"date"===e.kind)}get isTime(){return!!this._def.checks.find(e=>"time"===e.kind)}get isDuration(){return!!this._def.checks.find(e=>"duration"===e.kind)}get isEmail(){return!!this._def.checks.find(e=>"email"===e.kind)}get isURL(){return!!this._def.checks.find(e=>"url"===e.kind)}get isEmoji(){return!!this._def.checks.find(e=>"emoji"===e.kind)}get isUUID(){return!!this._def.checks.find(e=>"uuid"===e.kind)}get isNANOID(){return!!this._def.checks.find(e=>"nanoid"===e.kind)}get isCUID(){return!!this._def.checks.find(e=>"cuid"===e.kind)}get isCUID2(){return!!this._def.checks.find(e=>"cuid2"===e.kind)}get isULID(){return!!this._def.checks.find(e=>"ulid"===e.kind)}get isIP(){return!!this._def.checks.find(e=>"ip"===e.kind)}get isBase64(){return!!this._def.checks.find(e=>"base64"===e.kind)}get minLength(){let e=null;for(let t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(let t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}tr.create=e=>{var t;return new tr({checks:[],typeName:ef.ZodString,coerce:null!=(t=e?.coerce)&&t,...eY(e)})};class ti extends eK{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){let t;if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==eI.number){let t=this._getOrReturnCtx(e);return eD(t,{code:eA.invalid_type,expected:eI.number,received:t.parsedType}),eN}let r=new eG;for(let i of this._def.checks)"int"===i.kind?eh.isInteger(e.data)||(eD(t=this._getOrReturnCtx(e,t),{code:eA.invalid_type,expected:"integer",received:"float",message:i.message}),r.dirty()):"min"===i.kind?(i.inclusive?e.data<i.value:e.data<=i.value)&&(eD(t=this._getOrReturnCtx(e,t),{code:eA.too_small,minimum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),r.dirty()):"max"===i.kind?(i.inclusive?e.data>i.value:e.data>=i.value)&&(eD(t=this._getOrReturnCtx(e,t),{code:eA.too_big,maximum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),r.dirty()):"multipleOf"===i.kind?0!==function(e,t){let r=(e.toString().split(".")[1]||"").length,i=(t.toString().split(".")[1]||"").length,o=r>i?r:i;return parseInt(e.toFixed(o).replace(".",""))%parseInt(t.toFixed(o).replace(".",""))/Math.pow(10,o)}(e.data,i.value)&&(eD(t=this._getOrReturnCtx(e,t),{code:eA.not_multiple_of,multipleOf:i.value,message:i.message}),r.dirty()):"finite"===i.kind?Number.isFinite(e.data)||(eD(t=this._getOrReturnCtx(e,t),{code:eA.not_finite,message:i.message}),r.dirty()):eh.assertNever(i);return{status:r.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,ec.toString(t))}gt(e,t){return this.setLimit("min",e,!1,ec.toString(t))}lte(e,t){return this.setLimit("max",e,!0,ec.toString(t))}lt(e,t){return this.setLimit("max",e,!1,ec.toString(t))}setLimit(e,t,r,i){return new ti({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:ec.toString(i)}]})}_addCheck(e){return new ti({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:ec.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:ec.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:ec.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:ec.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:ec.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:ec.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:ec.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:ec.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:ec.toString(e)})}get minValue(){let e=null;for(let t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>"int"===e.kind||"multipleOf"===e.kind&&eh.isInteger(e.value))}get isFinite(){let e=null,t=null;for(let r of this._def.checks){if("finite"===r.kind||"int"===r.kind||"multipleOf"===r.kind)return!0;"min"===r.kind?(null===t||r.value>t)&&(t=r.value):"max"===r.kind&&(null===e||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}}ti.create=e=>new ti({checks:[],typeName:ef.ZodNumber,coerce:e?.coerce||!1,...eY(e)});class to extends eK{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){let t;if(this._def.coerce&&(e.data=BigInt(e.data)),this._getType(e)!==eI.bigint){let t=this._getOrReturnCtx(e);return eD(t,{code:eA.invalid_type,expected:eI.bigint,received:t.parsedType}),eN}let r=new eG;for(let i of this._def.checks)"min"===i.kind?(i.inclusive?e.data<i.value:e.data<=i.value)&&(eD(t=this._getOrReturnCtx(e,t),{code:eA.too_small,type:"bigint",minimum:i.value,inclusive:i.inclusive,message:i.message}),r.dirty()):"max"===i.kind?(i.inclusive?e.data>i.value:e.data>=i.value)&&(eD(t=this._getOrReturnCtx(e,t),{code:eA.too_big,type:"bigint",maximum:i.value,inclusive:i.inclusive,message:i.message}),r.dirty()):"multipleOf"===i.kind?e.data%i.value!==BigInt(0)&&(eD(t=this._getOrReturnCtx(e,t),{code:eA.not_multiple_of,multipleOf:i.value,message:i.message}),r.dirty()):eh.assertNever(i);return{status:r.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,ec.toString(t))}gt(e,t){return this.setLimit("min",e,!1,ec.toString(t))}lte(e,t){return this.setLimit("max",e,!0,ec.toString(t))}lt(e,t){return this.setLimit("max",e,!1,ec.toString(t))}setLimit(e,t,r,i){return new to({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:ec.toString(i)}]})}_addCheck(e){return new to({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:ec.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:ec.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:ec.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:ec.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:ec.toString(t)})}get minValue(){let e=null;for(let t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}to.create=e=>{var t;return new to({checks:[],typeName:ef.ZodBigInt,coerce:null!=(t=e?.coerce)&&t,...eY(e)})};class ts extends eK{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==eI.boolean){let t=this._getOrReturnCtx(e);return eD(t,{code:eA.invalid_type,expected:eI.boolean,received:t.parsedType}),eN}return eB(e.data)}}ts.create=e=>new ts({typeName:ef.ZodBoolean,coerce:e?.coerce||!1,...eY(e)});class tn extends eK{_parse(e){let t;if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==eI.date){let t=this._getOrReturnCtx(e);return eD(t,{code:eA.invalid_type,expected:eI.date,received:t.parsedType}),eN}if(isNaN(e.data.getTime()))return eD(this._getOrReturnCtx(e),{code:eA.invalid_date}),eN;let r=new eG;for(let i of this._def.checks)"min"===i.kind?e.data.getTime()<i.value&&(eD(t=this._getOrReturnCtx(e,t),{code:eA.too_small,message:i.message,inclusive:!0,exact:!1,minimum:i.value,type:"date"}),r.dirty()):"max"===i.kind?e.data.getTime()>i.value&&(eD(t=this._getOrReturnCtx(e,t),{code:eA.too_big,message:i.message,inclusive:!0,exact:!1,maximum:i.value,type:"date"}),r.dirty()):eh.assertNever(i);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new tn({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:ec.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:ec.toString(t)})}get minDate(){let e=null;for(let t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(let t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}tn.create=e=>new tn({checks:[],coerce:e?.coerce||!1,typeName:ef.ZodDate,...eY(e)});class ta extends eK{_parse(e){if(this._getType(e)!==eI.symbol){let t=this._getOrReturnCtx(e);return eD(t,{code:eA.invalid_type,expected:eI.symbol,received:t.parsedType}),eN}return eB(e.data)}}ta.create=e=>new ta({typeName:ef.ZodSymbol,...eY(e)});class tl extends eK{_parse(e){if(this._getType(e)!==eI.undefined){let t=this._getOrReturnCtx(e);return eD(t,{code:eA.invalid_type,expected:eI.undefined,received:t.parsedType}),eN}return eB(e.data)}}tl.create=e=>new tl({typeName:ef.ZodUndefined,...eY(e)});class th extends eK{_parse(e){if(this._getType(e)!==eI.null){let t=this._getOrReturnCtx(e);return eD(t,{code:eA.invalid_type,expected:eI.null,received:t.parsedType}),eN}return eB(e.data)}}th.create=e=>new th({typeName:ef.ZodNull,...eY(e)});class tu extends eK{constructor(){super(...arguments),this._any=!0}_parse(e){return eB(e.data)}}tu.create=e=>new tu({typeName:ef.ZodAny,...eY(e)});class tc extends eK{constructor(){super(...arguments),this._unknown=!0}_parse(e){return eB(e.data)}}tc.create=e=>new tc({typeName:ef.ZodUnknown,...eY(e)});class td extends eK{_parse(e){let t=this._getOrReturnCtx(e);return eD(t,{code:eA.invalid_type,expected:eI.never,received:t.parsedType}),eN}}td.create=e=>new td({typeName:ef.ZodNever,...eY(e)});class tp extends eK{_parse(e){if(this._getType(e)!==eI.undefined){let t=this._getOrReturnCtx(e);return eD(t,{code:eA.invalid_type,expected:eI.void,received:t.parsedType}),eN}return eB(e.data)}}tp.create=e=>new tp({typeName:ef.ZodVoid,...eY(e)});class tf extends eK{_parse(e){let{ctx:t,status:r}=this._processInputParams(e),i=this._def;if(t.parsedType!==eI.array)return eD(t,{code:eA.invalid_type,expected:eI.array,received:t.parsedType}),eN;if(null!==i.exactLength){let e=t.data.length>i.exactLength.value,o=t.data.length<i.exactLength.value;(e||o)&&(eD(t,{code:e?eA.too_big:eA.too_small,minimum:o?i.exactLength.value:void 0,maximum:e?i.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:i.exactLength.message}),r.dirty())}if(null!==i.minLength&&t.data.length<i.minLength.value&&(eD(t,{code:eA.too_small,minimum:i.minLength.value,type:"array",inclusive:!0,exact:!1,message:i.minLength.message}),r.dirty()),null!==i.maxLength&&t.data.length>i.maxLength.value&&(eD(t,{code:eA.too_big,maximum:i.maxLength.value,type:"array",inclusive:!0,exact:!1,message:i.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((e,r)=>i.type._parseAsync(new eX(t,e,t.path,r)))).then(e=>eG.mergeArray(r,e));let o=[...t.data].map((e,r)=>i.type._parseSync(new eX(t,e,t.path,r)));return eG.mergeArray(r,o)}get element(){return this._def.type}min(e,t){return new tf({...this._def,minLength:{value:e,message:ec.toString(t)}})}max(e,t){return new tf({...this._def,maxLength:{value:e,message:ec.toString(t)}})}length(e,t){return new tf({...this._def,exactLength:{value:e,message:ec.toString(t)}})}nonempty(e){return this.min(1,e)}}tf.create=(e,t)=>new tf({type:e,minLength:null,maxLength:null,exactLength:null,typeName:ef.ZodArray,...eY(t)});class tm extends eK{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;let e=this._def.shape(),t=eh.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==eI.object){let t=this._getOrReturnCtx(e);return eD(t,{code:eA.invalid_type,expected:eI.object,received:t.parsedType}),eN}let{status:t,ctx:r}=this._processInputParams(e),{shape:i,keys:o}=this._getCached(),s=[];if(!(this._def.catchall instanceof td&&"strip"===this._def.unknownKeys))for(let e in r.data)o.includes(e)||s.push(e);let n=[];for(let e of o){let t=i[e],o=r.data[e];n.push({key:{status:"valid",value:e},value:t._parse(new eX(r,o,r.path,e)),alwaysSet:e in r.data})}if(this._def.catchall instanceof td){let e=this._def.unknownKeys;if("passthrough"===e)for(let e of s)n.push({key:{status:"valid",value:e},value:{status:"valid",value:r.data[e]}});else if("strict"===e)s.length>0&&(eD(r,{code:eA.unrecognized_keys,keys:s}),t.dirty());else if("strip"!==e)throw Error("Internal ZodObject error: invalid unknownKeys value.")}else{let e=this._def.catchall;for(let t of s){let i=r.data[t];n.push({key:{status:"valid",value:t},value:e._parse(new eX(r,i,r.path,t)),alwaysSet:t in r.data})}}return r.common.async?Promise.resolve().then(async()=>{let e=[];for(let t of n){let r=await t.key,i=await t.value;e.push({key:r,value:i,alwaysSet:t.alwaysSet})}return e}).then(e=>eG.mergeObjectSync(t,e)):eG.mergeObjectSync(t,n)}get shape(){return this._def.shape()}strict(e){return ec.errToObj,new tm({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,r)=>{var i,o,s,n;let a=null!=(s=null==(o=(i=this._def).errorMap)?void 0:o.call(i,t,r).message)?s:r.defaultError;return"unrecognized_keys"===t.code?{message:null!=(n=ec.errToObj(e).message)?n:a}:{message:a}}}:{}})}strip(){return new tm({...this._def,unknownKeys:"strip"})}passthrough(){return new tm({...this._def,unknownKeys:"passthrough"})}extend(e){return new tm({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new tm({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:ef.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new tm({...this._def,catchall:e})}pick(e){let t={};return eh.objectKeys(e).forEach(r=>{e[r]&&this.shape[r]&&(t[r]=this.shape[r])}),new tm({...this._def,shape:()=>t})}omit(e){let t={};return eh.objectKeys(this.shape).forEach(r=>{e[r]||(t[r]=this.shape[r])}),new tm({...this._def,shape:()=>t})}deepPartial(){return function e(t){if(!(t instanceof tm))return t instanceof tf?new tf({...t._def,type:e(t.element)}):t instanceof tL?tL.create(e(t.unwrap())):t instanceof tj?tj.create(e(t.unwrap())):t instanceof tx?tx.create(t.items.map(t=>e(t))):t;{let r={};for(let i in t.shape){let o=t.shape[i];r[i]=tL.create(e(o))}return new tm({...t._def,shape:()=>r})}}(this)}partial(e){let t={};return eh.objectKeys(this.shape).forEach(r=>{let i=this.shape[r];e&&!e[r]?t[r]=i:t[r]=i.optional()}),new tm({...this._def,shape:()=>t})}required(e){let t={};return eh.objectKeys(this.shape).forEach(r=>{if(e&&!e[r])t[r]=this.shape[r];else{let e=this.shape[r];for(;e instanceof tL;)e=e._def.innerType;t[r]=e}}),new tm({...this._def,shape:()=>t})}keyof(){return tS(eh.objectKeys(this.shape))}}tm.create=(e,t)=>new tm({shape:()=>e,unknownKeys:"strip",catchall:td.create(),typeName:ef.ZodObject,...eY(t)}),tm.strictCreate=(e,t)=>new tm({shape:()=>e,unknownKeys:"strict",catchall:td.create(),typeName:ef.ZodObject,...eY(t)}),tm.lazycreate=(e,t)=>new tm({shape:e,unknownKeys:"strip",catchall:td.create(),typeName:ef.ZodObject,...eY(t)});class tg extends eK{_parse(e){let{ctx:t}=this._processInputParams(e),r=this._def.options;if(t.common.async)return Promise.all(r.map(async e=>{let r={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:r}),ctx:r}})).then(function(e){for(let t of e)if("valid"===t.result.status)return t.result;for(let r of e)if("dirty"===r.result.status)return t.common.issues.push(...r.ctx.common.issues),r.result;let r=e.map(e=>new eL(e.ctx.common.issues));return eD(t,{code:eA.invalid_union,unionErrors:r}),eN});{let e,i=[];for(let o of r){let r={...t,common:{...t.common,issues:[]},parent:null},s=o._parseSync({data:t.data,path:t.path,parent:r});if("valid"===s.status)return s;"dirty"!==s.status||e||(e={result:s,ctx:r}),r.common.issues.length&&i.push(r.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;let o=i.map(e=>new eL(e));return eD(t,{code:eA.invalid_union,unionErrors:o}),eN}}get options(){return this._def.options}}tg.create=(e,t)=>new tg({options:e,typeName:ef.ZodUnion,...eY(t)});let tv=e=>e instanceof tE?tv(e.schema):e instanceof tA?tv(e.innerType()):e instanceof tP?[e.value]:e instanceof tR?e.options:e instanceof tI?eh.objectValues(e.enum):e instanceof tk?tv(e._def.innerType):e instanceof tl?[void 0]:e instanceof th?[null]:e instanceof tL?[void 0,...tv(e.unwrap())]:e instanceof tj?[null,...tv(e.unwrap())]:e instanceof tG||e instanceof tz?tv(e.unwrap()):e instanceof tF?tv(e._def.innerType):[];class ty extends eK{_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==eI.object)return eD(t,{code:eA.invalid_type,expected:eI.object,received:t.parsedType}),eN;let r=this.discriminator,i=t.data[r],o=this.optionsMap.get(i);return o?t.common.async?o._parseAsync({data:t.data,path:t.path,parent:t}):o._parseSync({data:t.data,path:t.path,parent:t}):(eD(t,{code:eA.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),eN)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,r){let i=new Map;for(let r of t){let t=tv(r.shape[e]);if(!t.length)throw Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(let o of t){if(i.has(o))throw Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);i.set(o,r)}}return new ty({typeName:ef.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:i,...eY(r)})}}class tw extends eK{_parse(e){let{status:t,ctx:r}=this._processInputParams(e),i=(e,i)=>{if(eU(e)||eU(i))return eN;let o=function e(t,r){let i=eC(t),o=eC(r);if(t===r)return{valid:!0,data:t};if(i===eI.object&&o===eI.object){let i=eh.objectKeys(r),o=eh.objectKeys(t).filter(e=>-1!==i.indexOf(e)),s={...t,...r};for(let i of o){let o=e(t[i],r[i]);if(!o.valid)return{valid:!1};s[i]=o.data}return{valid:!0,data:s}}if(i!==eI.array||o!==eI.array)return i===eI.date&&o===eI.date&&+t==+r?{valid:!0,data:t}:{valid:!1};{if(t.length!==r.length)return{valid:!1};let i=[];for(let o=0;o<t.length;o++){let s=e(t[o],r[o]);if(!s.valid)return{valid:!1};i.push(s.data)}return{valid:!0,data:i}}}(e.value,i.value);return o.valid?((eV(e)||eV(i))&&t.dirty(),{status:t.value,value:o.data}):(eD(r,{code:eA.invalid_intersection_types}),eN)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([e,t])=>i(e,t)):i(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}}tw.create=(e,t,r)=>new tw({left:e,right:t,typeName:ef.ZodIntersection,...eY(r)});class tx extends eK{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==eI.array)return eD(r,{code:eA.invalid_type,expected:eI.array,received:r.parsedType}),eN;if(r.data.length<this._def.items.length)return eD(r,{code:eA.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),eN;!this._def.rest&&r.data.length>this._def.items.length&&(eD(r,{code:eA.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());let i=[...r.data].map((e,t)=>{let i=this._def.items[t]||this._def.rest;return i?i._parse(new eX(r,e,r.path,t)):null}).filter(e=>!!e);return r.common.async?Promise.all(i).then(e=>eG.mergeArray(t,e)):eG.mergeArray(t,i)}get items(){return this._def.items}rest(e){return new tx({...this._def,rest:e})}}tx.create=(e,t)=>{if(!Array.isArray(e))throw Error("You must pass an array of schemas to z.tuple([ ... ])");return new tx({items:e,typeName:ef.ZodTuple,rest:null,...eY(t)})};class t_ extends eK{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==eI.object)return eD(r,{code:eA.invalid_type,expected:eI.object,received:r.parsedType}),eN;let i=[],o=this._def.keyType,s=this._def.valueType;for(let e in r.data)i.push({key:o._parse(new eX(r,e,r.path,e)),value:s._parse(new eX(r,r.data[e],r.path,e)),alwaysSet:e in r.data});return r.common.async?eG.mergeObjectAsync(t,i):eG.mergeObjectSync(t,i)}get element(){return this._def.valueType}static create(e,t,r){return new t_(t instanceof eK?{keyType:e,valueType:t,typeName:ef.ZodRecord,...eY(r)}:{keyType:tr.create(),valueType:e,typeName:ef.ZodRecord,...eY(t)})}}class tb extends eK{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==eI.map)return eD(r,{code:eA.invalid_type,expected:eI.map,received:r.parsedType}),eN;let i=this._def.keyType,o=this._def.valueType,s=[...r.data.entries()].map(([e,t],s)=>({key:i._parse(new eX(r,e,r.path,[s,"key"])),value:o._parse(new eX(r,t,r.path,[s,"value"]))}));if(r.common.async){let e=new Map;return Promise.resolve().then(async()=>{for(let r of s){let i=await r.key,o=await r.value;if("aborted"===i.status||"aborted"===o.status)return eN;("dirty"===i.status||"dirty"===o.status)&&t.dirty(),e.set(i.value,o.value)}return{status:t.value,value:e}})}{let e=new Map;for(let r of s){let i=r.key,o=r.value;if("aborted"===i.status||"aborted"===o.status)return eN;("dirty"===i.status||"dirty"===o.status)&&t.dirty(),e.set(i.value,o.value)}return{status:t.value,value:e}}}}tb.create=(e,t,r)=>new tb({valueType:t,keyType:e,typeName:ef.ZodMap,...eY(r)});class tM extends eK{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==eI.set)return eD(r,{code:eA.invalid_type,expected:eI.set,received:r.parsedType}),eN;let i=this._def;null!==i.minSize&&r.data.size<i.minSize.value&&(eD(r,{code:eA.too_small,minimum:i.minSize.value,type:"set",inclusive:!0,exact:!1,message:i.minSize.message}),t.dirty()),null!==i.maxSize&&r.data.size>i.maxSize.value&&(eD(r,{code:eA.too_big,maximum:i.maxSize.value,type:"set",inclusive:!0,exact:!1,message:i.maxSize.message}),t.dirty());let o=this._def.valueType;function s(e){let r=new Set;for(let i of e){if("aborted"===i.status)return eN;"dirty"===i.status&&t.dirty(),r.add(i.value)}return{status:t.value,value:r}}let n=[...r.data.values()].map((e,t)=>o._parse(new eX(r,e,r.path,t)));return r.common.async?Promise.all(n).then(e=>s(e)):s(n)}min(e,t){return new tM({...this._def,minSize:{value:e,message:ec.toString(t)}})}max(e,t){return new tM({...this._def,maxSize:{value:e,message:ec.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}tM.create=(e,t)=>new tM({valueType:e,minSize:null,maxSize:null,typeName:ef.ZodSet,...eY(t)});class tT extends eK{constructor(){super(...arguments),this.validate=this.implement}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==eI.function)return eD(t,{code:eA.invalid_type,expected:eI.function,received:t.parsedType}),eN;function r(e,r){return eO({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,eF(),ej].filter(e=>!!e),issueData:{code:eA.invalid_arguments,argumentsError:r}})}function i(e,r){return eO({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,eF(),ej].filter(e=>!!e),issueData:{code:eA.invalid_return_type,returnTypeError:r}})}let o={errorMap:t.common.contextualErrorMap},s=t.data;if(this._def.returns instanceof tC){let e=this;return eB(async function(...t){let n=new eL([]),a=await e._def.args.parseAsync(t,o).catch(e=>{throw n.addIssue(r(t,e)),n}),l=await Reflect.apply(s,this,a);return await e._def.returns._def.type.parseAsync(l,o).catch(e=>{throw n.addIssue(i(l,e)),n})})}{let e=this;return eB(function(...t){let n=e._def.args.safeParse(t,o);if(!n.success)throw new eL([r(t,n.error)]);let a=Reflect.apply(s,this,n.data),l=e._def.returns.safeParse(a,o);if(!l.success)throw new eL([i(a,l.error)]);return l.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new tT({...this._def,args:tx.create(e).rest(tc.create())})}returns(e){return new tT({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,r){return new tT({args:e||tx.create([]).rest(tc.create()),returns:t||tc.create(),typeName:ef.ZodFunction,...eY(r)})}}class tE extends eK{get schema(){return this._def.getter()}_parse(e){let{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}tE.create=(e,t)=>new tE({getter:e,typeName:ef.ZodLazy,...eY(t)});class tP extends eK{_parse(e){if(e.data!==this._def.value){let t=this._getOrReturnCtx(e);return eD(t,{received:t.data,code:eA.invalid_literal,expected:this._def.value}),eN}return{status:"valid",value:e.data}}get value(){return this._def.value}}function tS(e,t){return new tR({values:e,typeName:ef.ZodEnum,...eY(t)})}tP.create=(e,t)=>new tP({value:e,typeName:ef.ZodLiteral,...eY(t)});class tR extends eK{constructor(){super(...arguments),ed.set(this,void 0)}_parse(e){if("string"!=typeof e.data){let t=this._getOrReturnCtx(e),r=this._def.values;return eD(t,{expected:eh.joinValues(r),received:t.parsedType,code:eA.invalid_type}),eN}if(eq(this,ed)||e$(this,ed,new Set(this._def.values)),!eq(this,ed).has(e.data)){let t=this._getOrReturnCtx(e),r=this._def.values;return eD(t,{received:t.data,code:eA.invalid_enum_value,options:r}),eN}return eB(e.data)}get options(){return this._def.values}get enum(){let e={};for(let t of this._def.values)e[t]=t;return e}get Values(){let e={};for(let t of this._def.values)e[t]=t;return e}get Enum(){let e={};for(let t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return tR.create(e,{...this._def,...t})}exclude(e,t=this._def){return tR.create(this.options.filter(t=>!e.includes(t)),{...this._def,...t})}}ed=new WeakMap,tR.create=tS;class tI extends eK{constructor(){super(...arguments),ep.set(this,void 0)}_parse(e){let t=eh.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==eI.string&&r.parsedType!==eI.number){let e=eh.objectValues(t);return eD(r,{expected:eh.joinValues(e),received:r.parsedType,code:eA.invalid_type}),eN}if(eq(this,ep)||e$(this,ep,new Set(eh.getValidEnumValues(this._def.values))),!eq(this,ep).has(e.data)){let e=eh.objectValues(t);return eD(r,{received:r.data,code:eA.invalid_enum_value,options:e}),eN}return eB(e.data)}get enum(){return this._def.values}}ep=new WeakMap,tI.create=(e,t)=>new tI({values:e,typeName:ef.ZodNativeEnum,...eY(t)});class tC extends eK{unwrap(){return this._def.type}_parse(e){let{ctx:t}=this._processInputParams(e);return t.parsedType!==eI.promise&&!1===t.common.async?(eD(t,{code:eA.invalid_type,expected:eI.promise,received:t.parsedType}),eN):eB((t.parsedType===eI.promise?t.data:Promise.resolve(t.data)).then(e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap})))}}tC.create=(e,t)=>new tC({type:e,typeName:ef.ZodPromise,...eY(t)});class tA extends eK{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===ef.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){let{status:t,ctx:r}=this._processInputParams(e),i=this._def.effect||null,o={addIssue:e=>{eD(r,e),e.fatal?t.abort():t.dirty()},get path(){return r.path}};if(o.addIssue=o.addIssue.bind(o),"preprocess"===i.type){let e=i.transform(r.data,o);if(r.common.async)return Promise.resolve(e).then(async e=>{if("aborted"===t.value)return eN;let i=await this._def.schema._parseAsync({data:e,path:r.path,parent:r});return"aborted"===i.status?eN:"dirty"===i.status||"dirty"===t.value?ez(i.value):i});{if("aborted"===t.value)return eN;let i=this._def.schema._parseSync({data:e,path:r.path,parent:r});return"aborted"===i.status?eN:"dirty"===i.status||"dirty"===t.value?ez(i.value):i}}if("refinement"===i.type){let e=e=>{let t=i.refinement(e,o);if(r.common.async)return Promise.resolve(t);if(t instanceof Promise)throw Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1!==r.common.async)return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(r=>"aborted"===r.status?eN:("dirty"===r.status&&t.dirty(),e(r.value).then(()=>({status:t.value,value:r.value}))));{let i=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return"aborted"===i.status?eN:("dirty"===i.status&&t.dirty(),e(i.value),{status:t.value,value:i.value})}}if("transform"===i.type)if(!1!==r.common.async)return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(e=>eW(e)?Promise.resolve(i.transform(e.value,o)).then(e=>({status:t.value,value:e})):e);else{let e=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!eW(e))return e;let s=i.transform(e.value,o);if(s instanceof Promise)throw Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:s}}eh.assertNever(i)}}tA.create=(e,t,r)=>new tA({schema:e,typeName:ef.ZodEffects,effect:t,...eY(r)}),tA.createWithPreprocess=(e,t,r)=>new tA({schema:t,effect:{type:"preprocess",transform:e},typeName:ef.ZodEffects,...eY(r)});class tL extends eK{_parse(e){return this._getType(e)===eI.undefined?eB(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}tL.create=(e,t)=>new tL({innerType:e,typeName:ef.ZodOptional,...eY(t)});class tj extends eK{_parse(e){return this._getType(e)===eI.null?eB(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}tj.create=(e,t)=>new tj({innerType:e,typeName:ef.ZodNullable,...eY(t)});class tk extends eK{_parse(e){let{ctx:t}=this._processInputParams(e),r=t.data;return t.parsedType===eI.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}tk.create=(e,t)=>new tk({innerType:e,typeName:ef.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...eY(t)});class tF extends eK{_parse(e){let{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},i=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return eZ(i)?i.then(e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new eL(r.common.issues)},input:r.data})})):{status:"valid",value:"valid"===i.status?i.value:this._def.catchValue({get error(){return new eL(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}}tF.create=(e,t)=>new tF({innerType:e,typeName:ef.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...eY(t)});class tO extends eK{_parse(e){if(this._getType(e)!==eI.nan){let t=this._getOrReturnCtx(e);return eD(t,{code:eA.invalid_type,expected:eI.nan,received:t.parsedType}),eN}return{status:"valid",value:e.data}}}tO.create=e=>new tO({typeName:ef.ZodNaN,...eY(e)});let tD=Symbol("zod_brand");class tG extends eK{_parse(e){let{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}}class tN extends eK{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{let e=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return"aborted"===e.status?eN:"dirty"===e.status?(t.dirty(),ez(e.value)):this._def.out._parseAsync({data:e.value,path:r.path,parent:r})})();{let e=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return"aborted"===e.status?eN:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:r.path,parent:r})}}static create(e,t){return new tN({in:e,out:t,typeName:ef.ZodPipeline})}}class tz extends eK{_parse(e){let t=this._def.innerType._parse(e),r=e=>(eW(e)&&(e.value=Object.freeze(e.value)),e);return eZ(t)?t.then(e=>r(e)):r(t)}unwrap(){return this._def.innerType}}function tB(e,t={},r){return e?tu.create().superRefine((i,o)=>{var s,n;if(!e(i)){let e="function"==typeof t?t(i):"string"==typeof t?{message:t}:t,a=null==(n=null!=(s=e.fatal)?s:r)||n,l="string"==typeof e?{message:e}:e;o.addIssue({code:"custom",...l,fatal:a})}}):tu.create()}tz.create=(e,t)=>new tz({innerType:e,typeName:ef.ZodReadonly,...eY(t)});let tU={object:tm.lazycreate};!function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(ef||(ef={}));let tV=tr.create,tW=ti.create,tZ=tO.create,tq=to.create,t$=ts.create,tX=tn.create,tH=ta.create,tY=tl.create,tK=th.create,tJ=tu.create,tQ=tc.create,t0=td.create,t1=tp.create,t2=tf.create,t3=tm.create,t4=tm.strictCreate,t5=tg.create,t9=ty.create,t6=tw.create,t8=tx.create,t7=t_.create,re=tb.create,rt=tM.create,rr=tT.create,ri=tE.create,ro=tP.create,rs=tR.create,rn=tI.create,ra=tC.create,rl=tA.create,rh=tL.create,ru=tj.create,rc=tA.createWithPreprocess,rd=tN.create;var rp=Object.freeze({__proto__:null,defaultErrorMap:ej,setErrorMap:function(e){ek=e},getErrorMap:eF,makeIssue:eO,EMPTY_PATH:[],addIssueToContext:eD,ParseStatus:eG,INVALID:eN,DIRTY:ez,OK:eB,isAborted:eU,isDirty:eV,isValid:eW,isAsync:eZ,get util(){return eh},get objectUtil(){return eu},ZodParsedType:eI,getParsedType:eC,ZodType:eK,datetimeRegex:tt,ZodString:tr,ZodNumber:ti,ZodBigInt:to,ZodBoolean:ts,ZodDate:tn,ZodSymbol:ta,ZodUndefined:tl,ZodNull:th,ZodAny:tu,ZodUnknown:tc,ZodNever:td,ZodVoid:tp,ZodArray:tf,ZodObject:tm,ZodUnion:tg,ZodDiscriminatedUnion:ty,ZodIntersection:tw,ZodTuple:tx,ZodRecord:t_,ZodMap:tb,ZodSet:tM,ZodFunction:tT,ZodLazy:tE,ZodLiteral:tP,ZodEnum:tR,ZodNativeEnum:tI,ZodPromise:tC,ZodEffects:tA,ZodTransformer:tA,ZodOptional:tL,ZodNullable:tj,ZodDefault:tk,ZodCatch:tF,ZodNaN:tO,BRAND:tD,ZodBranded:tG,ZodPipeline:tN,ZodReadonly:tz,custom:tB,Schema:eK,ZodSchema:eK,late:tU,get ZodFirstPartyTypeKind(){return ef},coerce:{string:e=>tr.create({...e,coerce:!0}),number:e=>ti.create({...e,coerce:!0}),boolean:e=>ts.create({...e,coerce:!0}),bigint:e=>to.create({...e,coerce:!0}),date:e=>tn.create({...e,coerce:!0})},any:tJ,array:t2,bigint:tq,boolean:t$,date:tX,discriminatedUnion:t9,effect:rl,enum:rs,function:rr,instanceof:(e,t={message:`Input not instance of ${e.name}`})=>tB(t=>t instanceof e,t),intersection:t6,lazy:ri,literal:ro,map:re,nan:tZ,nativeEnum:rn,never:t0,null:tK,nullable:ru,number:tW,object:t3,oboolean:()=>t$().optional(),onumber:()=>tW().optional(),optional:rh,ostring:()=>tV().optional(),pipeline:rd,preprocess:rc,promise:ra,record:t7,set:rt,strictObject:t4,string:tV,symbol:tH,transformer:rl,tuple:t8,undefined:tY,union:t5,unknown:tQ,void:t1,NEVER:eN,ZodIssueCode:eA,quotelessJson:e=>JSON.stringify(e,null,2).replace(/"([^"]+)":/g,"$1:"),ZodError:eL});let rf=/^https?:\/\/library.stanford.edu\/iiif\/image-api\/1.1\/compliance.html#level(?<level>[012])$/,rm=rp.string().regex(rf),rg="http://library.stanford.edu/iiif/image-api/1.1/context.json",rv="http://iiif.io/api/image/1/context.json",ry=rp.literal(rg),rw=rp.object({"@context":ry,"@id":rp.string().url(),profile:rm.optional(),width:rp.number().int(),height:rp.number().int(),scale_factors:rp.number().array().optional(),tile_width:rp.number().optional(),tile_height:rp.number().optional()}),rx=rp.object({width:rp.number().int(),height:rp.number().int()}),r_=rp.object({width:rp.number().int(),height:rp.number().int().optional(),scaleFactors:rp.array(rp.number().int())}),rb=rp.enum(["ImageService1","ImageService2","ImageService3"]),rM=/^https?:\/\/iiif.io\/api\/image\/2.*level(?<level>[012])(.json)?$/,rT=rp.string().regex(rM),rE=rp.object({formats:rp.string().array().optional(),maxArea:rp.number().int().optional(),maxHeight:rp.number().int().optional(),maxWidth:rp.number().int().optional(),qualities:rp.string().array().optional(),supports:rp.string().array().optional()}),rP=rT.or(rp.array(rp.union([rT,rE,rp.any()]))),rS="http://iiif.io/api/image/2/context.json",rR=rp.literal(rS).or(rp.literal("https://iiif.io/api/image/2/context.json")),rI=rp.object({"@id":rp.string().url(),"@type":rp.literal("iiif:Image").or(rp.literal("ImageService2")).optional(),"@context":rR,protocol:rp.literal("http://iiif.io/api/image"),width:rp.number().int(),height:rp.number().int(),profile:rP,sizes:rx.array().optional(),tiles:r_.array().optional()}),rC=rp.enum(["level0","level1","level2"]),rA=rp.object({id:rp.string().url(),type:rp.literal("ImageService3"),protocol:rp.literal("http://iiif.io/api/image"),profile:rC,width:rp.number().int(),height:rp.number().int(),maxWidth:rp.number().int().optional(),maxHeight:rp.number().int().optional(),maxArea:rp.number().int().optional(),sizes:rx.array().optional(),tiles:r_.array().optional(),extraFeatures:rp.string().array().optional()}),rL=rp.object({"@id":rp.string().url(),"@type":rb.optional(),profile:rm.or(rP).or(rC),width:rp.number().int().optional(),height:rp.number().int().optional(),"@context":ry.or(rp.literal("http://iiif.io/api/image/1/context.json")).or(rR).optional()}),rj=rp.object({id:rp.string().url(),type:rp.literal("ImageService2"),profile:rP}).or(rp.object({"@id":rp.string().url(),"@type":rp.literal("ImageService2"),profile:rP})),rk=rp.object({id:rp.string().url(),type:rb,profile:rp.enum(["level0","level1","level2"])}),rF=rp.union([rj,rk]),rO=rL.or(rF),rD=rp.string().or(rp.number()).or(rp.boolean()),rG=rD.or(rD.array()),rN=rp.object({"@language":rp.string().optional(),"@value":rG}),rz=rG.or(rN).or(rN.array()),rB=rp.union([rp.any(),rp.object({label:rz.optional(),value:rz.optional()})]).transform(e=>{if(e&&"object"==typeof e&&"label"in e&&"value"in e)return e}).array(),rU=rp.object({width:rp.number().int().optional(),height:rp.number().int().optional(),service:rO}),rV=rp.object({resource:rU}),rW=rp.object({"@id":rp.string().url(),"@type":rp.literal("sc:Canvas"),width:rp.number().int(),height:rp.number().int(),images:rV.array().length(1),label:rz.optional(),metadata:rB.optional()}),rZ=rp.object({canvases:rW.array().nonempty()}),rq=rp.object({"@id":rp.string().url(),"@type":rp.literal("sc:Manifest"),sequences:rZ.array().length(1),label:rz.optional(),description:rz.optional(),metadata:rB.optional()}),r$=rp.lazy(()=>rp.object({"@id":rp.string().url(),"@type":rp.literal("sc:Manifest"),label:rz.optional()})),rX=rp.lazy(()=>rp.object({"@id":rp.string().url(),"@type":rp.literal("sc:Collection"),label:rz.optional(),manifests:r$.array().optional(),collections:rX.array().optional(),members:r$.or(rX).array().optional()})),rH=rp.string().or(rp.number()).or(rp.boolean()),rY=rp.record(rp.string(),rH.array()),rK=rp.union([rp.any(),rp.object({label:rY.optional(),value:rY.optional()})]).transform(e=>{if(e&&"object"==typeof e&&"label"in e&&"value"in e)return e}).array(),rJ=rp.object({type:rp.literal("Image"),width:rp.number().int().optional(),height:rp.number().int().optional(),service:rO.array()}),rQ=rp.object({type:rp.literal("Annotation"),body:rJ.or(rJ.array().length(1))}),r0=rp.object({type:rp.literal("AnnotationPage"),items:rQ.array().length(1)}),r1=rp.object({id:rp.string().url(),type:rp.literal("Canvas"),width:rp.number().int(),height:rp.number().int(),items:r0.array().length(1),label:rY.optional(),metadata:rK.optional()}),r2=rp.object({id:rp.string().url(),type:rp.literal("Manifest"),items:r1.array().nonempty(),label:rY.optional(),description:rY.optional(),metadata:rK.optional()}),r3=rp.lazy(()=>rp.object({id:rp.string().url(),type:rp.literal("Manifest"),label:rY.optional()})),r4=rp.lazy(()=>rp.object({id:rp.string().url(),type:rp.literal("Collection"),label:rY.optional(),items:r3.or(r4).array()})),r5=rw.or(rI).or(rA);rW.or(r1);let r9=rq.or(r2);function r6({width:e,height:t},r,i,o){let s=i*r.originalWidth,n=o*r.originalHeight,a=i*r.originalWidth+r.width*r.scaleFactor>e?e-i*r.originalWidth:r.width*r.scaleFactor,l=o*r.originalHeight+r.height*r.scaleFactor>t?t-o*r.originalHeight:r.height*r.scaleFactor,h=r.width,u=r.height;return s+r.width*r.scaleFactor>e&&(h=Math.floor((e-s+r.scaleFactor-1)/r.scaleFactor)),n+r.height*r.scaleFactor>t&&(u=Math.floor((t-n+r.scaleFactor-1)/r.scaleFactor)),{region:{x:s,y:n,width:a,height:l},size:{width:h,height:u}}}function r8(e,t,r="cover",{sizes:i,tileZoomLevels:o,supportsAnyRegionAndSize:s,maxWidth:n,maxHeight:a,maxArea:l}){let{width:h,height:u}=function(e,t,r="cover"){if("cover"===r||"contain"===r){let i=t.width/e.width,o=t.height/e.height,s="cover"===r?Math.max(i,o):Math.min(i,o);return{width:e.width*s,height:e.height*s}}throw Error('Mode must be either "cover" or "contain"')}(e,t,r);if(n&&h>n&&(u=u/h*n,h=n),a&&u>a&&(h=h/u*a,u=a),l&&h*u>l){let e=u/h;u=(h=Math.floor(Math.floor(Math.sqrt(l/e))*e)/e)*e}let c=e.width/e.height;if(u=Math.round((h=Math.floor(h))/c),i){let e;for(let t of i){let r=t.width/h;if(r>=.8&&r<=1.5){e=t;break}}if(e)return{size:e}}if(s)return{size:{width:Math.round(h),height:Math.round(u)}};if(o){let t=e.width/h,r=o.map(({scaleFactor:e},r)=>({index:r,scaleFactor:e,diff:Math.abs(e-t)})).sort((e,t)=>e.diff-t.diff),i=o[r[0].index],s=Math.ceil(e.width/(i.scaleFactor*o[0].width)),n=Math.ceil(e.height/(i.scaleFactor*o[0].height)),a=[];for(let t=0;t<n;t++){let r=[];for(let o=0;o<s;o++){let s=r6(e,i,o,t);r.push(s)}a.push(r)}return a}throw Error("Unable to create thumbnail")}rX.or(r4),rq.or(rI),r2.or(rA),r9.or(r5);let r7=["regionByPx","sizeByWh"];function ie(e){let t=e.match(rM);if(t&&t.groups)return parseInt(t.groups.level)}function it(e){if("type"in e||"@type"in e){let t=e.profile,r=!1;return"level0"===t||"string"==typeof t&&t.endsWith("level0.json")?"extraFeatures"in e&&(r=r7.every(t=>e.extraFeatures&&e.extraFeatures.includes(t))):r=!0,{maxWidth:"maxWidth"in e?e.maxWidth:void 0,maxHeight:"maxHeight"in e?e.maxHeight:void 0,maxArea:"maxArea"in e?e.maxArea:void 0,supportsAnyRegionAndSize:r}}if(Array.isArray(e.profile)){let t=!1,r=Number.NEGATIVE_INFINITY,i=Number.NEGATIVE_INFINITY,o=Number.NEGATIVE_INFINITY;return e.profile.forEach(e=>{if("string"==typeof e){let r=ie(e);r&&(t=t||r>=1)}else{let{maxWidth:s,maxHeight:n,maxArea:a,supportsAnyRegionAndSize:l}={maxWidth:e?.maxWidth,maxHeight:e?.maxHeight,maxArea:e?.maxArea,supportsAnyRegionAndSize:r7.every(t=>e?.supports&&e?.supports?.includes(t))};void 0!==s&&(i=Math.max(s,i)),void 0!==n&&(r=Math.max(n,r)),void 0!==a&&(o=Math.max(a,o)),t=t||l}}),{maxWidth:i>=0?i:void 0,maxHeight:r>=0?r:void 0,maxArea:o>=0?o:void 0,supportsAnyRegionAndSize:t}}if("profile"in e&&e.profile){let t=function(e){let t=e.match(rf);if(t&&t.groups)return parseInt(t.groups.level)}(e.profile),r=ie(e.profile);return t?{supportsAnyRegionAndSize:t>=1}:r?{supportsAnyRegionAndSize:r>=1}:{supportsAnyRegionAndSize:!1}}throw Error("Invalid Image")}class ir{embedded=!0;uri;type="image";maxWidth;maxHeight;maxArea;supportsAnyRegionAndSize;width;height;majorVersion;constructor(e,t){if(t){let t,r;if(Array.isArray(e.service)?e.service.forEach(e=>{try{let i=function(e){if("type"in e&&"ImageService3"===e.type)return 3;if("type"in e&&"ImageService2"===e.type||"@type"in e&&"ImageService2"===e["@type"]||"@context"in e&&e["@context"]===rS)return 2;if("@context"in e&&(e["@context"]===rg||e["@context"]===rv))return 1;if("profile"in e){let t;return(t=Array.isArray(e.profile)?e.profile[0]:e.profile).match(rf)?1:t.match(rM)?2:3}throw Error("Unsupported IIIF Image Service")}(e);(!r||i>r)&&(r=i,t=e)}catch{}}):t=e.service,!t)throw Error("Unsupported IIIF Image Service");if("@id"in t)this.uri=t["@id"];else if("id"in t)this.uri=t.id;else throw Error("Unsupported IIIF Image Service");if("type"in t&&"ImageService3"===t.type)this.majorVersion=3;else if("type"in t&&"ImageService2"===t.type||"@type"in t&&"ImageService2"===t["@type"]||"@context"in t&&t["@context"]===rS)this.majorVersion=2;else if("@context"in t&&(t["@context"]===rg||t["@context"]===rv))this.majorVersion=1;else if("profile"in t){let e;(e=Array.isArray(t.profile)?t.profile[0]:t.profile).match(rf)?this.majorVersion=1:e.match(rM)?this.majorVersion=2:this.majorVersion=3}else throw Error("Unsupported IIIF Image Service");if("profile"in t){let e=it(t);this.supportsAnyRegionAndSize=e.supportsAnyRegionAndSize,this.maxWidth=e.maxWidth,this.maxHeight=e.maxHeight,this.maxArea=e.maxArea}else this.supportsAnyRegionAndSize=!1}else{if("@id"in e)this.uri=e["@id"];else if("id"in e)this.uri=e.id;else throw Error("Unsupported IIIF Image");if("type"in e&&"ImageService3"===e.type)this.majorVersion=3;else if("@type"in e&&"iiif:Image"===e["@type"]||"@context"in e&&e["@context"]===rS)this.majorVersion=2;else if("@context"in e&&e["@context"]===rg)this.majorVersion=1;else throw Error("Unsupported IIIF Image");if("profile"in e){let t=it(e);this.supportsAnyRegionAndSize=t.supportsAnyRegionAndSize,this.maxWidth=t.maxWidth,this.maxHeight=t.maxHeight,this.maxArea=t.maxArea}else this.supportsAnyRegionAndSize=!1}if(void 0!==e.width)this.width=e.width;else if(t)this.width=t.width;else throw Error("Width not present on either Canvas or Image Resource");if(void 0!==e.height)this.height=e.height;else if(t)this.height=t.height;else throw Error("Height not present on either Canvas or Image Resource")}getImageUrl(e){let t,r,i,o,s,n,{region:a,size:l}=e;if(a?(s=`${a.x},${a.y},${a.width},${a.height}`,i=a.height,o=a.width):(s="full",i=this.height,o=this.width),l){t=Math.round(l.width),r=Math.round(l.height);let e=String(t),s=String(r),a=o/i,h=r*a/a;r===Math.round(h)&&(s=""),n=`${e},${s}`}else t=this.width,r=this.height,n=2===this.majorVersion?"full":"max";let h=t*r;if(void 0!==this.maxWidth&&t>this.maxWidth)throw Error(`Width of requested image is too large: ${t} > ${this.maxWidth}`);if(void 0!==this.maxHeight&&r>this.maxHeight)throw Error(`Height of requested image is too large: ${r} > ${this.maxHeight}`);if(void 0!==this.maxArea&&h>this.maxArea)throw Error(`Area of requested image is too large: ${h} > ${this.maxArea}`);let u=1===this.majorVersion?"native":"default";return`${this.uri}/${s}/${n}/0/${u}.jpg`}getThumbnail(e,t="cover"){return r8({width:this.width,height:this.height},e,t,{supportsAnyRegionAndSize:this.supportsAnyRegionAndSize,maxWidth:this.maxWidth,maxHeight:this.maxHeight,maxArea:this.maxArea})}}class ii extends ir{tileZoomLevels;sizes;embedded=!1;constructor(e){let t;super(e);let r=it(e);"tiles"in e&&(t=e.tiles),this.tileZoomLevels=function(e,t,r){if(!t||!t.some(e=>e.width&&e.scaleFactors&&e.scaleFactors.length))if(r)t=[function({width:e,height:t},r=768){return{scaleFactors:Array.from({length:Math.ceil(Math.log(Math.max(e,t)/r)/Math.log(2))},(e,t)=>2**t),width:r}}(e)];else throw Error("Image does not support tiles or custom regions and sizes.");return t.map(t=>t.scaleFactors.map(r=>(function({width:e,height:t},r,i){let o=r.height||r.width,s=r.width*i,n=o*i;return{scaleFactor:i,width:r.width,height:o,originalWidth:s,originalHeight:n,columns:Math.ceil(e/s),rows:Math.ceil(t/n)}})(e,t,r))).flat()}({width:this.width,height:this.height},t,r.supportsAnyRegionAndSize),"sizes"in e&&(this.sizes=e.sizes)}static parse(e,t=null){let r;return new ii(1===t?rw.parse(e):2===t?rI.parse(e):3===t?rA.parse(e):r5.parse(e))}getIiifTile(e,t,r){return r6({width:this.width,height:this.height},e,t,r)}getThumbnail(e,t="cover"){return r8({width:this.width,height:this.height},e,t,{supportsAnyRegionAndSize:this.supportsAnyRegionAndSize,sizes:this.sizes,tileZoomLevels:this.tileZoomLevels,maxWidth:this.maxWidth,maxHeight:this.maxHeight,maxArea:this.maxArea})}}let io=rp.record(rp.string(),rp.string().array());rp.object({label:io.optional(),value:io.optional()});var is={centimeters:0x25f96350,centimetres:0x25f96350,degrees:57.22891354143274,feet:20902260.511392,inches:250826616.45599997,kilometers:6371.0088,kilometres:6371.0088,meters:6371008.8,metres:6371008.8,miles:3958.761333810546,millimeters:0x17bbde120,millimetres:0x17bbde120,nauticalmiles:6371008.8/1852,radians:1,yards:6967335.223679999};function ia(e){return e%(2*Math.PI)*180/Math.PI}function il(e){return e%360*Math.PI/180}function ih(e){return!isNaN(e)&&null!==e&&!Array.isArray(e)}function iu(e){if(!e)throw Error("coord is required");if(!Array.isArray(e)){if("Feature"===e.type&&null!==e.geometry&&"Point"===e.geometry.type)return e.geometry.coordinates;if("Point"===e.type)return e.coordinates}if(Array.isArray(e)&&e.length>=2&&!Array.isArray(e[0])&&!Array.isArray(e[1]))return e;throw Error("coord must be GeoJSON Point or an Array of numbers")}function ic(e,t,r){void 0===r&&(r={});var i=iu(e),o=iu(t),s=Math.pow(Math.sin(il(o[1]-i[1])/2),2)+Math.pow(Math.sin(il(o[0]-i[0])/2),2)*Math.cos(il(i[1]))*Math.cos(il(o[1]));return function(e,t){void 0===t&&(t="kilometers");var r=is[t];if(!r)throw Error(t+" units is invalid");return e*r}(2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)),r.units)}function id(e,t){var r,i,o,s,n,a,l,h,u=ic(e,t),c=function e(t,r,i){if(void 0===i&&(i={}),!0===i.final)return(e(r,t)+180)%360;var o=iu(t),s=iu(r),n=il(o[0]),a=il(s[0]),l=il(o[1]),h=il(s[1]);return ia(Math.atan2(Math.sin(a-n)*Math.cos(h),Math.cos(l)*Math.sin(h)-Math.sin(l)*Math.cos(h)*Math.cos(a-n)))}(e,t);return r=u/2,void 0===i&&(i={}),s=il((o=iu(e))[0]),n=il(o[1]),a=il(c),h=Math.asin(Math.sin(n)*Math.cos(l=function(e,t){void 0===t&&(t="kilometers");var r=is[t];if(!r)throw Error(t+" units is invalid");return e/r}(r,i.units))+Math.cos(n)*Math.sin(l)*Math.cos(a)),function(e,t,r){var i,o,s;if(void 0===r&&(r={}),!e)throw Error("coordinates is required");if(!Array.isArray(e))throw Error("coordinates must be an Array");if(e.length<2)throw Error("coordinates must be at least 2 numbers long");if(!ih(e[0])||!ih(e[1]))throw Error("coordinates must contain numbers");return i={type:"Point",coordinates:e},void 0===(o=r)&&(o={}),s={type:"Feature"},(0===o.id||o.id)&&(s.id=o.id),o.bbox&&(s.bbox=o.bbox),s.properties=t||{},s.geometry=i,s}([ia(s+Math.atan2(Math.sin(a)*Math.sin(l)*Math.cos(n),Math.cos(l)-Math.sin(n)*Math.sin(h))),ia(h)],i.properties)}function ip(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var r=function e(){return this instanceof e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};r.prototype=t.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(e).forEach(function(t){var i=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,i.get?i:{enumerable:!0,get:function(){return e[t]}})}),r}var im={};let ig=Object.prototype.toString;function iv(e){let t=ig.call(e);return t.endsWith("Array]")&&!t.includes("Big")}let iy=ip(Object.freeze(Object.defineProperty({__proto__:null,isAnyArray:iv},Symbol.toStringTag,{value:"Module"}))),iw=ip(Object.freeze(Object.defineProperty({__proto__:null,default:function(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(iv(e)){if(0===e.length)throw TypeError("input must not be empty")}else throw TypeError("input must be an array");if(void 0!==r.output){if(!iv(r.output))throw TypeError("output option must be an array if specified");t=r.output}else t=Array(e.length);var i=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!iv(e))throw TypeError("input must be an array");if(0===e.length)throw TypeError("input must not be empty");var r=t.fromIndex,i=void 0===r?0:r,o=t.toIndex,s=void 0===o?e.length:o;if(i<0||i>=e.length||!Number.isInteger(i))throw Error("fromIndex must be a positive integer smaller than length");if(s<=i||s>e.length||!Number.isInteger(s))throw Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var n=e[i],a=i+1;a<s;a++)e[a]<n&&(n=e[a]);return n}(e),o=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!iv(e))throw TypeError("input must be an array");if(0===e.length)throw TypeError("input must not be empty");var r=t.fromIndex,i=void 0===r?0:r,o=t.toIndex,s=void 0===o?e.length:o;if(i<0||i>=e.length||!Number.isInteger(i))throw Error("fromIndex must be a positive integer smaller than length");if(s<=i||s>e.length||!Number.isInteger(s))throw Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var n=e[i],a=i+1;a<s;a++)e[a]>n&&(n=e[a]);return n}(e);if(i===o)throw RangeError("minimum and maximum input values are equal. Cannot rescale a constant array");var s=r.min,n=void 0===s?r.autoMinMax?i:0:s,a=r.max,l=void 0===a?r.autoMinMax?o:1:a;if(n>=l)throw RangeError("min option must be smaller than max option");for(var h=(l-n)/(o-i),u=0;u<e.length;u++)t[u]=(e[u]-i)*h+n;return t}},Symbol.toStringTag,{value:"Module"})));Object.defineProperty(im,"__esModule",{value:!0});let ix=" ".repeat(2),i_=" ".repeat(4);function ib(e,t={}){let{maxRows:r=15,maxColumns:i=10,maxNumSize:o=8,padMinus:s="auto"}=t;return`${e.constructor.name} {
${ix}[
${i_}${function(e,t,r,i,o){let{rows:s,columns:n}=e,a=Math.min(s,t),l=Math.min(n,r),h=[];if("auto"===o){o=!1;e:for(let t=0;t<a;t++)for(let r=0;r<l;r++)if(0>e.get(t,r)){o=!0;break e}}for(let t=0;t<a;t++){let r=[];for(let s=0;s<l;s++){var u,c,d;r.push((u=e.get(t,s),c=i,d=o,(u>=0&&d?` ${iM(u,c-1)}`:iM(u,c)).padEnd(c)))}h.push(`${r.join(" ")}`)}return l!==n&&(h[h.length-1]+=` ... ${n-r} more columns`),a!==s&&h.push(`... ${s-t} more rows`),h.join(`
${i_}`)}(e,r,i,o,s)}
${ix}]
${ix}rows: ${e.rows}
${ix}columns: ${e.columns}
}`}function iM(e,t){let r=e.toString();if(r.length<=t)return r;let i=e.toFixed(t);if(i.length>t&&(i=e.toFixed(Math.max(0,t-(i.length-t)))),i.length<=t&&!i.startsWith("0.000")&&!i.startsWith("-0.000"))return i;let o=e.toExponential(t);return o.length>t&&(o=e.toExponential(Math.max(0,t-(o.length-t)))),o.slice(0)}function iT(e,t,r){let i=r?e.rows:e.rows-1;if(t<0||t>i)throw RangeError("Row index out of range")}function iE(e,t,r){let i=r?e.columns:e.columns-1;if(t<0||t>i)throw RangeError("Column index out of range")}function iP(e,t){if(t.to1DArray&&(t=t.to1DArray()),t.length!==e.columns)throw RangeError("vector size must be the same as the number of columns");return t}function iS(e,t){if(t.to1DArray&&(t=t.to1DArray()),t.length!==e.rows)throw RangeError("vector size must be the same as the number of rows");return t}function iR(e,t){if(!iy.isAnyArray(t))throw TypeError("row indices must be an array");for(let r=0;r<t.length;r++)if(t[r]<0||t[r]>=e.rows)throw RangeError("row indices are out of range")}function iI(e,t){if(!iy.isAnyArray(t))throw TypeError("column indices must be an array");for(let r=0;r<t.length;r++)if(t[r]<0||t[r]>=e.columns)throw RangeError("column indices are out of range")}function iC(e,t,r,i,o){if(5!=arguments.length)throw RangeError("expected 4 arguments");if(iL("startRow",t),iL("endRow",r),iL("startColumn",i),iL("endColumn",o),t>r||i>o||t<0||t>=e.rows||r<0||r>=e.rows||i<0||i>=e.columns||o<0||o>=e.columns)throw RangeError("Submatrix indices are out of range")}function iA(e,t=0){let r=[];for(let i=0;i<e;i++)r.push(t);return r}function iL(e,t){if("number"!=typeof t)throw TypeError(`${e} must be a number`)}function ij(e){if(e.isEmpty())throw Error("Empty matrix has no elements to index")}let ik=class e{static from1DArray(e,t,r){if(e*t!==r.length)throw RangeError("data length does not match given dimensions");let i=new iO(e,t);for(let o=0;o<e;o++)for(let e=0;e<t;e++)i.set(o,e,r[o*t+e]);return i}static rowVector(e){let t=new iO(1,e.length);for(let r=0;r<e.length;r++)t.set(0,r,e[r]);return t}static columnVector(e){let t=new iO(e.length,1);for(let r=0;r<e.length;r++)t.set(r,0,e[r]);return t}static zeros(e,t){return new iO(e,t)}static ones(e,t){return new iO(e,t).fill(1)}static rand(e,t,r={}){if("object"!=typeof r)throw TypeError("options must be an object");let{random:i=Math.random}=r,o=new iO(e,t);for(let r=0;r<e;r++)for(let e=0;e<t;e++)o.set(r,e,i());return o}static randInt(e,t,r={}){if("object"!=typeof r)throw TypeError("options must be an object");let{min:i=0,max:o=1e3,random:s=Math.random}=r;if(!Number.isInteger(i))throw TypeError("min must be an integer");if(!Number.isInteger(o))throw TypeError("max must be an integer");if(i>=o)throw RangeError("min must be smaller than max");let n=o-i,a=new iO(e,t);for(let r=0;r<e;r++)for(let e=0;e<t;e++){let t=i+Math.round(s()*n);a.set(r,e,t)}return a}static eye(e,t,r){void 0===t&&(t=e),void 0===r&&(r=1);let i=Math.min(e,t),o=this.zeros(e,t);for(let e=0;e<i;e++)o.set(e,e,r);return o}static diag(e,t,r){let i=e.length;void 0===t&&(t=i),void 0===r&&(r=t);let o=Math.min(i,t,r),s=this.zeros(t,r);for(let t=0;t<o;t++)s.set(t,t,e[t]);return s}static min(e,t){e=this.checkMatrix(e),t=this.checkMatrix(t);let r=e.rows,i=e.columns,o=new iO(r,i);for(let s=0;s<r;s++)for(let r=0;r<i;r++)o.set(s,r,Math.min(e.get(s,r),t.get(s,r)));return o}static max(e,t){e=this.checkMatrix(e),t=this.checkMatrix(t);let r=e.rows,i=e.columns,o=new this(r,i);for(let s=0;s<r;s++)for(let r=0;r<i;r++)o.set(s,r,Math.max(e.get(s,r),t.get(s,r)));return o}static checkMatrix(t){return e.isMatrix(t)?t:new iO(t)}static isMatrix(e){return null!=e&&"Matrix"===e.klass}get size(){return this.rows*this.columns}apply(e){if("function"!=typeof e)throw TypeError("callback must be a function");for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)e.call(this,t,r);return this}to1DArray(){let e=[];for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)e.push(this.get(t,r));return e}to2DArray(){let e=[];for(let t=0;t<this.rows;t++){e.push([]);for(let r=0;r<this.columns;r++)e[t].push(this.get(t,r))}return e}toJSON(){return this.to2DArray()}isRowVector(){return 1===this.rows}isColumnVector(){return 1===this.columns}isVector(){return 1===this.rows||1===this.columns}isSquare(){return this.rows===this.columns}isEmpty(){return 0===this.rows||0===this.columns}isSymmetric(){if(this.isSquare()){for(let e=0;e<this.rows;e++)for(let t=0;t<=e;t++)if(this.get(e,t)!==this.get(t,e))return!1;return!0}return!1}isDistance(){if(!this.isSymmetric())return!1;for(let e=0;e<this.rows;e++)if(0!==this.get(e,e))return!1;return!0}isEchelonForm(){let e=0,t=0,r=-1,i=!0,o=!1;for(;e<this.rows&&i;){for(t=0,o=!1;t<this.columns&&!1===o;)0===this.get(e,t)?t++:1===this.get(e,t)&&t>r?(o=!0,r=t):(i=!1,o=!0);e++}return i}isReducedEchelonForm(){let e=0,t=0,r=-1,i=!0,o=!1;for(;e<this.rows&&i;){for(t=0,o=!1;t<this.columns&&!1===o;)0===this.get(e,t)?t++:1===this.get(e,t)&&t>r?(o=!0,r=t):(i=!1,o=!0);for(let r=t+1;r<this.rows;r++)0!==this.get(e,r)&&(i=!1);e++}return i}echelonForm(){let e=this.clone(),t=0,r=0;for(;t<e.rows&&r<e.columns;){let i=t;for(let o=t;o<e.rows;o++)e.get(o,r)>e.get(i,r)&&(i=o);if(0===e.get(i,r))r++;else{e.swapRows(t,i);let o=e.get(t,r);for(let i=r;i<e.columns;i++)e.set(t,i,e.get(t,i)/o);for(let i=t+1;i<e.rows;i++){let o=e.get(i,r)/e.get(t,r);e.set(i,r,0);for(let s=r+1;s<e.columns;s++)e.set(i,s,e.get(i,s)-e.get(t,s)*o)}t++,r++}}return e}reducedEchelonForm(){let e=this.echelonForm(),t=e.columns,r=e.rows,i=r-1;for(;i>=0;)if(0===e.maxRow(i))i--;else{let o=0,s=!1;for(;o<r&&!1===s;)1===e.get(i,o)?s=!0:o++;for(let r=0;r<i;r++){let s=e.get(r,o);for(let n=o;n<t;n++){let t=e.get(r,n)-s*e.get(i,n);e.set(r,n,t)}}i--}return e}set(){throw Error("set method is unimplemented")}get(){throw Error("get method is unimplemented")}repeat(e={}){if("object"!=typeof e)throw TypeError("options must be an object");let{rows:t=1,columns:r=1}=e;if(!Number.isInteger(t)||t<=0)throw TypeError("rows must be a positive integer");if(!Number.isInteger(r)||r<=0)throw TypeError("columns must be a positive integer");let i=new iO(this.rows*t,this.columns*r);for(let e=0;e<t;e++)for(let t=0;t<r;t++)i.setSubMatrix(this,this.rows*e,this.columns*t);return i}fill(e){for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,e);return this}neg(){return this.mulS(-1)}getRow(e){iT(this,e);let t=[];for(let r=0;r<this.columns;r++)t.push(this.get(e,r));return t}getRowVector(e){return iO.rowVector(this.getRow(e))}setRow(e,t){iT(this,e),t=iP(this,t);for(let r=0;r<this.columns;r++)this.set(e,r,t[r]);return this}swapRows(e,t){iT(this,e),iT(this,t);for(let r=0;r<this.columns;r++){let i=this.get(e,r);this.set(e,r,this.get(t,r)),this.set(t,r,i)}return this}getColumn(e){iE(this,e);let t=[];for(let r=0;r<this.rows;r++)t.push(this.get(r,e));return t}getColumnVector(e){return iO.columnVector(this.getColumn(e))}setColumn(e,t){iE(this,e),t=iS(this,t);for(let r=0;r<this.rows;r++)this.set(r,e,t[r]);return this}swapColumns(e,t){iE(this,e),iE(this,t);for(let r=0;r<this.rows;r++){let i=this.get(r,e);this.set(r,e,this.get(r,t)),this.set(r,t,i)}return this}addRowVector(e){e=iP(this,e);for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)+e[r]);return this}subRowVector(e){e=iP(this,e);for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)-e[r]);return this}mulRowVector(e){e=iP(this,e);for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)*e[r]);return this}divRowVector(e){e=iP(this,e);for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)/e[r]);return this}addColumnVector(e){e=iS(this,e);for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)+e[t]);return this}subColumnVector(e){e=iS(this,e);for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)-e[t]);return this}mulColumnVector(e){e=iS(this,e);for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)*e[t]);return this}divColumnVector(e){e=iS(this,e);for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)/e[t]);return this}mulRow(e,t){iT(this,e);for(let r=0;r<this.columns;r++)this.set(e,r,this.get(e,r)*t);return this}mulColumn(e,t){iE(this,e);for(let r=0;r<this.rows;r++)this.set(r,e,this.get(r,e)*t);return this}max(e){if(this.isEmpty())return NaN;switch(e){case"row":{let e=Array(this.rows).fill(Number.NEGATIVE_INFINITY);for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.get(t,r)>e[t]&&(e[t]=this.get(t,r));return e}case"column":{let e=Array(this.columns).fill(Number.NEGATIVE_INFINITY);for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.get(t,r)>e[r]&&(e[r]=this.get(t,r));return e}case void 0:{let e=this.get(0,0);for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.get(t,r)>e&&(e=this.get(t,r));return e}default:throw Error(`invalid option: ${e}`)}}maxIndex(){ij(this);let e=this.get(0,0),t=[0,0];for(let r=0;r<this.rows;r++)for(let i=0;i<this.columns;i++)this.get(r,i)>e&&(e=this.get(r,i),t[0]=r,t[1]=i);return t}min(e){if(this.isEmpty())return NaN;switch(e){case"row":{let e=Array(this.rows).fill(Number.POSITIVE_INFINITY);for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.get(t,r)<e[t]&&(e[t]=this.get(t,r));return e}case"column":{let e=Array(this.columns).fill(Number.POSITIVE_INFINITY);for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.get(t,r)<e[r]&&(e[r]=this.get(t,r));return e}case void 0:{let e=this.get(0,0);for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.get(t,r)<e&&(e=this.get(t,r));return e}default:throw Error(`invalid option: ${e}`)}}minIndex(){ij(this);let e=this.get(0,0),t=[0,0];for(let r=0;r<this.rows;r++)for(let i=0;i<this.columns;i++)this.get(r,i)<e&&(e=this.get(r,i),t[0]=r,t[1]=i);return t}maxRow(e){if(iT(this,e),this.isEmpty())return NaN;let t=this.get(e,0);for(let r=1;r<this.columns;r++)this.get(e,r)>t&&(t=this.get(e,r));return t}maxRowIndex(e){iT(this,e),ij(this);let t=this.get(e,0),r=[e,0];for(let i=1;i<this.columns;i++)this.get(e,i)>t&&(t=this.get(e,i),r[1]=i);return r}minRow(e){if(iT(this,e),this.isEmpty())return NaN;let t=this.get(e,0);for(let r=1;r<this.columns;r++)this.get(e,r)<t&&(t=this.get(e,r));return t}minRowIndex(e){iT(this,e),ij(this);let t=this.get(e,0),r=[e,0];for(let i=1;i<this.columns;i++)this.get(e,i)<t&&(t=this.get(e,i),r[1]=i);return r}maxColumn(e){if(iE(this,e),this.isEmpty())return NaN;let t=this.get(0,e);for(let r=1;r<this.rows;r++)this.get(r,e)>t&&(t=this.get(r,e));return t}maxColumnIndex(e){iE(this,e),ij(this);let t=this.get(0,e),r=[0,e];for(let i=1;i<this.rows;i++)this.get(i,e)>t&&(t=this.get(i,e),r[0]=i);return r}minColumn(e){if(iE(this,e),this.isEmpty())return NaN;let t=this.get(0,e);for(let r=1;r<this.rows;r++)this.get(r,e)<t&&(t=this.get(r,e));return t}minColumnIndex(e){iE(this,e),ij(this);let t=this.get(0,e),r=[0,e];for(let i=1;i<this.rows;i++)this.get(i,e)<t&&(t=this.get(i,e),r[0]=i);return r}diag(){let e=Math.min(this.rows,this.columns),t=[];for(let r=0;r<e;r++)t.push(this.get(r,r));return t}norm(e="frobenius"){switch(e){case"max":return this.max();case"frobenius":return Math.sqrt(this.dot(this));default:throw RangeError(`unknown norm type: ${e}`)}}cumulativeSum(){let e=0;for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)e+=this.get(t,r),this.set(t,r,e);return this}dot(t){e.isMatrix(t)&&(t=t.to1DArray());let r=this.to1DArray();if(r.length!==t.length)throw RangeError("vectors do not have the same size");let i=0;for(let e=0;e<r.length;e++)i+=r[e]*t[e];return i}mmul(e){e=iO.checkMatrix(e);let t=this.rows,r=this.columns,i=e.columns,o=new iO(t,i),s=new Float64Array(r);for(let n=0;n<i;n++){for(let t=0;t<r;t++)s[t]=e.get(t,n);for(let e=0;e<t;e++){let t=0;for(let i=0;i<r;i++)t+=this.get(e,i)*s[i];o.set(e,n,t)}}return o}strassen2x2(e){e=iO.checkMatrix(e);let t=new iO(2,2),r=this.get(0,0),i=e.get(0,0),o=this.get(0,1),s=e.get(0,1),n=this.get(1,0),a=e.get(1,0),l=this.get(1,1),h=e.get(1,1),u=(r+l)*(i+h),c=(n+l)*i,d=r*(s-h),p=l*(a-i),f=(r+o)*h;return t.set(0,0,u+p-f+(o-l)*(a+h)),t.set(0,1,d+f),t.set(1,0,c+p),t.set(1,1,u-c+d+(n-r)*(i+s)),t}strassen3x3(e){e=iO.checkMatrix(e);let t=new iO(3,3),r=this.get(0,0),i=this.get(0,1),o=this.get(0,2),s=this.get(1,0),n=this.get(1,1),a=this.get(1,2),l=this.get(2,0),h=this.get(2,1),u=this.get(2,2),c=e.get(0,0),d=e.get(0,1),p=e.get(0,2),f=e.get(1,0),m=e.get(1,1),g=e.get(1,2),v=e.get(2,0),y=e.get(2,1),w=e.get(2,2),x=(r+i+o-s-n-h-u)*m,_=(r-s)*(-d+m),b=n*(-c+d+f-m-g-v+w),M=(-r+s+n)*(c-d+m),T=(s+n)*(-c+d),E=r*c,P=(-r+l+h)*(c-p+g),S=(-r+l)*(p-g),R=(l+h)*(-c+p),I=(r+i+o-n-a-l-h)*g,C=h*(-c+p+f-m-g-v+y),A=(-o+h+u)*(m+v-y),L=(o-u)*(m-y),j=o*v,k=(h+u)*(-v+y),F=(-o+n+a)*(g+v-w),O=(o-a)*(g-w),D=(n+a)*(-v+w),G=x+M+T+E+A+j+k,N=E+P+R+I+j+F+D,z=_+b+M+E+j+F+O,B=E+P+S+C+A+L+j;return t.set(0,0,E+j+i*f),t.set(0,1,G),t.set(0,2,N),t.set(1,0,z),t.set(1,1,_+M+T+E+a*y),t.set(1,2,j+F+O+D+s*p),t.set(2,0,B),t.set(2,1,A+L+j+k+l*d),t.set(2,2,E+P+S+R+u*w),t}mmulStrassen(t){t=iO.checkMatrix(t);let r=this.clone(),i=r.rows,o=r.columns,s=t.rows,n=t.columns;function a(t,r,i){let o=t.rows,s=t.columns;return o===r&&s===i?t:e.zeros(r,i).setSubMatrix(t,0,0)}o!==s&&console.warn(`Multiplying ${i} x ${o} and ${s} x ${n} matrix: dimensions do not match.`);let l=Math.max(i,s),h=Math.max(o,n);return r=a(r,l,h),function t(r,i,o,s){if(o<=512||s<=512)return r.mmul(i);o%2==1&&s%2==1?(r=a(r,o+1,s+1),i=a(i,o+1,s+1)):o%2==1?(r=a(r,o+1,s),i=a(i,o+1,s)):s%2==1&&(r=a(r,o,s+1),i=a(i,o,s+1));let n=parseInt(r.rows/2,10),l=parseInt(r.columns/2,10),h=r.subMatrix(0,n-1,0,l-1),u=i.subMatrix(0,n-1,0,l-1),c=r.subMatrix(0,n-1,l,r.columns-1),d=i.subMatrix(0,n-1,l,i.columns-1),p=r.subMatrix(n,r.rows-1,0,l-1),f=i.subMatrix(n,i.rows-1,0,l-1),m=r.subMatrix(n,r.rows-1,l,r.columns-1),g=i.subMatrix(n,i.rows-1,l,i.columns-1),v=t(e.add(h,m),e.add(u,g),n,l),y=t(e.add(p,m),u,n,l),w=t(h,e.sub(d,g),n,l),x=t(m,e.sub(f,u),n,l),_=t(e.add(h,c),g,n,l),b=t(e.sub(p,h),e.add(u,d),n,l),M=t(e.sub(c,m),e.add(f,g),n,l),T=e.add(v,x);T.sub(_),T.add(M);let E=e.add(w,_),P=e.add(y,x),S=e.sub(v,y);S.add(w),S.add(b);let R=e.zeros(2*T.rows,2*T.columns);return(R=(R=(R=(R=R.setSubMatrix(T,0,0)).setSubMatrix(E,T.rows,0)).setSubMatrix(P,0,T.columns)).setSubMatrix(S,T.rows,T.columns)).subMatrix(0,o-1,0,s-1)}(r,t=a(t,l,h),l,h)}scaleRows(e={}){if("object"!=typeof e)throw TypeError("options must be an object");let{min:t=0,max:r=1}=e;if(!Number.isFinite(t))throw TypeError("min must be a number");if(!Number.isFinite(r))throw TypeError("max must be a number");if(t>=r)throw RangeError("min must be smaller than max");let i=new iO(this.rows,this.columns);for(let e=0;e<this.rows;e++){let o=this.getRow(e);o.length>0&&iw(o,{min:t,max:r,output:o}),i.setRow(e,o)}return i}scaleColumns(e={}){if("object"!=typeof e)throw TypeError("options must be an object");let{min:t=0,max:r=1}=e;if(!Number.isFinite(t))throw TypeError("min must be a number");if(!Number.isFinite(r))throw TypeError("max must be a number");if(t>=r)throw RangeError("min must be smaller than max");let i=new iO(this.rows,this.columns);for(let e=0;e<this.columns;e++){let o=this.getColumn(e);o.length&&iw(o,{min:t,max:r,output:o}),i.setColumn(e,o)}return i}flipRows(){let e=Math.ceil(this.columns/2);for(let t=0;t<this.rows;t++)for(let r=0;r<e;r++){let e=this.get(t,r),i=this.get(t,this.columns-1-r);this.set(t,r,i),this.set(t,this.columns-1-r,e)}return this}flipColumns(){let e=Math.ceil(this.rows/2);for(let t=0;t<this.columns;t++)for(let r=0;r<e;r++){let e=this.get(r,t),i=this.get(this.rows-1-r,t);this.set(r,t,i),this.set(this.rows-1-r,t,e)}return this}kroneckerProduct(e){e=iO.checkMatrix(e);let t=this.rows,r=this.columns,i=e.rows,o=e.columns,s=new iO(t*i,r*o);for(let n=0;n<t;n++)for(let t=0;t<r;t++)for(let r=0;r<i;r++)for(let a=0;a<o;a++)s.set(i*n+r,o*t+a,this.get(n,t)*e.get(r,a));return s}kroneckerSum(e){if(e=iO.checkMatrix(e),!this.isSquare()||!e.isSquare())throw Error("Kronecker Sum needs two Square Matrices");let t=this.rows,r=e.rows,i=this.kroneckerProduct(iO.eye(r,r)),o=iO.eye(t,t).kroneckerProduct(e);return i.add(o)}transpose(){let e=new iO(this.columns,this.rows);for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)e.set(r,t,this.get(t,r));return e}sortRows(e=iF){for(let t=0;t<this.rows;t++)this.setRow(t,this.getRow(t).sort(e));return this}sortColumns(e=iF){for(let t=0;t<this.columns;t++)this.setColumn(t,this.getColumn(t).sort(e));return this}subMatrix(e,t,r,i){iC(this,e,t,r,i);let o=new iO(t-e+1,i-r+1);for(let s=e;s<=t;s++)for(let t=r;t<=i;t++)o.set(s-e,t-r,this.get(s,t));return o}subMatrixRow(e,t,r){if(void 0===t&&(t=0),void 0===r&&(r=this.columns-1),t>r||t<0||t>=this.columns||r<0||r>=this.columns)throw RangeError("Argument out of range");let i=new iO(e.length,r-t+1);for(let o=0;o<e.length;o++)for(let s=t;s<=r;s++){if(e[o]<0||e[o]>=this.rows)throw RangeError(`Row index out of range: ${e[o]}`);i.set(o,s-t,this.get(e[o],s))}return i}subMatrixColumn(e,t,r){if(void 0===t&&(t=0),void 0===r&&(r=this.rows-1),t>r||t<0||t>=this.rows||r<0||r>=this.rows)throw RangeError("Argument out of range");let i=new iO(r-t+1,e.length);for(let o=0;o<e.length;o++)for(let s=t;s<=r;s++){if(e[o]<0||e[o]>=this.columns)throw RangeError(`Column index out of range: ${e[o]}`);i.set(s-t,o,this.get(s,e[o]))}return i}setSubMatrix(e,t,r){if((e=iO.checkMatrix(e)).isEmpty())return this;let i=t+e.rows-1,o=r+e.columns-1;iC(this,t,i,r,o);for(let i=0;i<e.rows;i++)for(let o=0;o<e.columns;o++)this.set(t+i,r+o,e.get(i,o));return this}selection(e,t){iR(this,e),iI(this,t);let r=new iO(e.length,t.length);for(let i=0;i<e.length;i++){let o=e[i];for(let e=0;e<t.length;e++){let s=t[e];r.set(i,e,this.get(o,s))}}return r}trace(){let e=Math.min(this.rows,this.columns),t=0;for(let r=0;r<e;r++)t+=this.get(r,r);return t}clone(){return this.constructor.copy(this,new iO(this.rows,this.columns))}static copy(e,t){for(let[r,i,o]of e.entries())t.set(r,i,o);return t}sum(e){switch(e){case"row":return function(e){let t=iA(e.rows);for(let r=0;r<e.rows;++r)for(let i=0;i<e.columns;++i)t[r]+=e.get(r,i);return t}(this);case"column":return function(e){let t=iA(e.columns);for(let r=0;r<e.rows;++r)for(let i=0;i<e.columns;++i)t[i]+=e.get(r,i);return t}(this);case void 0:return function(e){let t=0;for(let r=0;r<e.rows;r++)for(let i=0;i<e.columns;i++)t+=e.get(r,i);return t}(this);default:throw Error(`invalid option: ${e}`)}}product(e){switch(e){case"row":return function(e){let t=iA(e.rows,1);for(let r=0;r<e.rows;++r)for(let i=0;i<e.columns;++i)t[r]*=e.get(r,i);return t}(this);case"column":return function(e){let t=iA(e.columns,1);for(let r=0;r<e.rows;++r)for(let i=0;i<e.columns;++i)t[i]*=e.get(r,i);return t}(this);case void 0:return function(e){let t=1;for(let r=0;r<e.rows;r++)for(let i=0;i<e.columns;i++)t*=e.get(r,i);return t}(this);default:throw Error(`invalid option: ${e}`)}}mean(e){let t=this.sum(e);switch(e){case"row":for(let e=0;e<this.rows;e++)t[e]/=this.columns;return t;case"column":for(let e=0;e<this.columns;e++)t[e]/=this.rows;return t;case void 0:return t/this.size;default:throw Error(`invalid option: ${e}`)}}variance(e,t={}){if("object"==typeof e&&(t=e,e=void 0),"object"!=typeof t)throw TypeError("options must be an object");let{unbiased:r=!0,mean:i=this.mean(e)}=t;if("boolean"!=typeof r)throw TypeError("unbiased must be a boolean");switch(e){case"row":if(!iy.isAnyArray(i))throw TypeError("mean must be an array");return function(e,t,r){let i=e.rows,o=e.columns,s=[];for(let n=0;n<i;n++){let i=0,a=0,l=0;for(let t=0;t<o;t++)i+=l=e.get(n,t)-r[n],a+=l*l;t?s.push((a-i*i/o)/(o-1)):s.push((a-i*i/o)/o)}return s}(this,r,i);case"column":if(!iy.isAnyArray(i))throw TypeError("mean must be an array");return function(e,t,r){let i=e.rows,o=e.columns,s=[];for(let n=0;n<o;n++){let o=0,a=0,l=0;for(let t=0;t<i;t++)o+=l=e.get(t,n)-r[n],a+=l*l;t?s.push((a-o*o/i)/(i-1)):s.push((a-o*o/i)/i)}return s}(this,r,i);case void 0:if("number"!=typeof i)throw TypeError("mean must be a number");return function(e,t,r){let i=e.rows,o=e.columns,s=i*o,n=0,a=0,l=0;for(let t=0;t<i;t++)for(let i=0;i<o;i++)n+=l=e.get(t,i)-r,a+=l*l;return t?(a-n*n/s)/(s-1):(a-n*n/s)/s}(this,r,i);default:throw Error(`invalid option: ${e}`)}}standardDeviation(e,t){"object"==typeof e&&(t=e,e=void 0);let r=this.variance(e,t);if(void 0===e)return Math.sqrt(r);for(let e=0;e<r.length;e++)r[e]=Math.sqrt(r[e]);return r}center(e,t={}){if("object"==typeof e&&(t=e,e=void 0),"object"!=typeof t)throw TypeError("options must be an object");let{center:r=this.mean(e)}=t;switch(e){case"row":if(!iy.isAnyArray(r))throw TypeError("center must be an array");return function(e,t){for(let r=0;r<e.rows;r++)for(let i=0;i<e.columns;i++)e.set(r,i,e.get(r,i)-t[r])}(this,r),this;case"column":if(!iy.isAnyArray(r))throw TypeError("center must be an array");return function(e,t){for(let r=0;r<e.rows;r++)for(let i=0;i<e.columns;i++)e.set(r,i,e.get(r,i)-t[i])}(this,r),this;case void 0:if("number"!=typeof r)throw TypeError("center must be a number");return function(e,t){for(let r=0;r<e.rows;r++)for(let i=0;i<e.columns;i++)e.set(r,i,e.get(r,i)-t)}(this,r),this;default:throw Error(`invalid option: ${e}`)}}scale(e,t={}){if("object"==typeof e&&(t=e,e=void 0),"object"!=typeof t)throw TypeError("options must be an object");let r=t.scale;switch(e){case"row":if(void 0===r)r=function(e){let t=[];for(let r=0;r<e.rows;r++){let i=0;for(let t=0;t<e.columns;t++)i+=Math.pow(e.get(r,t),2)/(e.columns-1);t.push(Math.sqrt(i))}return t}(this);else if(!iy.isAnyArray(r))throw TypeError("scale must be an array");return function(e,t){for(let r=0;r<e.rows;r++)for(let i=0;i<e.columns;i++)e.set(r,i,e.get(r,i)/t[r])}(this,r),this;case"column":if(void 0===r)r=function(e){let t=[];for(let r=0;r<e.columns;r++){let i=0;for(let t=0;t<e.rows;t++)i+=Math.pow(e.get(t,r),2)/(e.rows-1);t.push(Math.sqrt(i))}return t}(this);else if(!iy.isAnyArray(r))throw TypeError("scale must be an array");return function(e,t){for(let r=0;r<e.rows;r++)for(let i=0;i<e.columns;i++)e.set(r,i,e.get(r,i)/t[i])}(this,r),this;case void 0:if(void 0===r)r=function(e){let t=e.size-1,r=0;for(let i=0;i<e.columns;i++)for(let o=0;o<e.rows;o++)r+=Math.pow(e.get(o,i),2)/t;return Math.sqrt(r)}(this);else if("number"!=typeof r)throw TypeError("scale must be a number");return function(e,t){for(let r=0;r<e.rows;r++)for(let i=0;i<e.columns;i++)e.set(r,i,e.get(r,i)/t)}(this,r),this;default:throw Error(`invalid option: ${e}`)}}toString(e){return ib(this,e)}[Symbol.iterator](){return this.entries()}*entries(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)yield[e,t,this.get(e,t)]}*values(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)yield this.get(e,t)}};function iF(e,t){return e-t}ik.prototype.klass="Matrix","u">typeof Symbol&&(ik.prototype[Symbol.for("nodejs.util.inspect.custom")]=function(){return ib(this)}),ik.random=ik.rand,ik.randomInt=ik.randInt,ik.diagonal=ik.diag,ik.prototype.diagonal=ik.prototype.diag,ik.identity=ik.eye,ik.prototype.negate=ik.prototype.neg,ik.prototype.tensorProduct=ik.prototype.kroneckerProduct;let iO=class e extends ik{data;#e(e,t){if(this.data=[],Number.isInteger(t)&&t>=0)for(let r=0;r<e;r++)this.data.push(new Float64Array(t));else throw TypeError("nColumns must be a positive integer");this.rows=e,this.columns=t}constructor(t,r){if(super(),e.isMatrix(t))this.#e(t.rows,t.columns),e.copy(t,this);else if(Number.isInteger(t)&&t>=0)this.#e(t,r);else if(iy.isAnyArray(t)){let e=t;if("number"!=typeof(r=(t=e.length)?e[0].length:0))throw TypeError("Data must be a 2D array with at least one element");this.data=[];for(let i=0;i<t;i++){if(e[i].length!==r)throw RangeError("Inconsistent array dimensions");if(!e[i].every(e=>"number"==typeof e))throw TypeError("Input data contains non-numeric values");this.data.push(Float64Array.from(e[i]))}this.rows=t,this.columns=r}else throw TypeError("First argument must be a positive number or an array")}set(e,t,r){return this.data[e][t]=r,this}get(e,t){return this.data[e][t]}removeRow(e){return iT(this,e),this.data.splice(e,1),this.rows-=1,this}addRow(e,t){return void 0===t&&(t=e,e=this.rows),iT(this,e,!0),t=Float64Array.from(iP(this,t)),this.data.splice(e,0,t),this.rows+=1,this}removeColumn(e){iE(this,e);for(let t=0;t<this.rows;t++){let r=new Float64Array(this.columns-1);for(let i=0;i<e;i++)r[i]=this.data[t][i];for(let i=e+1;i<this.columns;i++)r[i-1]=this.data[t][i];this.data[t]=r}return this.columns-=1,this}addColumn(e,t){typeof t>"u"&&(t=e,e=this.columns),iE(this,e,!0),t=iS(this,t);for(let r=0;r<this.rows;r++){let i=new Float64Array(this.columns+1),o=0;for(;o<e;o++)i[o]=this.data[r][o];for(i[o++]=t[r];o<this.columns+1;o++)i[o]=this.data[r][o-1];this.data[r]=i}return this.columns+=1,this}};!function(e,t){e.prototype.add=function(e){return"number"==typeof e?this.addS(e):this.addM(e)},e.prototype.addS=function(e){for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)+e);return this},e.prototype.addM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw RangeError("Matrices dimensions must be equal");for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)+e.get(t,r));return this},e.add=function(e,r){return new t(e).add(r)},e.prototype.sub=function(e){return"number"==typeof e?this.subS(e):this.subM(e)},e.prototype.subS=function(e){for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)-e);return this},e.prototype.subM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw RangeError("Matrices dimensions must be equal");for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)-e.get(t,r));return this},e.sub=function(e,r){return new t(e).sub(r)},e.prototype.subtract=e.prototype.sub,e.prototype.subtractS=e.prototype.subS,e.prototype.subtractM=e.prototype.subM,e.subtract=e.sub,e.prototype.mul=function(e){return"number"==typeof e?this.mulS(e):this.mulM(e)},e.prototype.mulS=function(e){for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)*e);return this},e.prototype.mulM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw RangeError("Matrices dimensions must be equal");for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)*e.get(t,r));return this},e.mul=function(e,r){return new t(e).mul(r)},e.prototype.multiply=e.prototype.mul,e.prototype.multiplyS=e.prototype.mulS,e.prototype.multiplyM=e.prototype.mulM,e.multiply=e.mul,e.prototype.div=function(e){return"number"==typeof e?this.divS(e):this.divM(e)},e.prototype.divS=function(e){for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)/e);return this},e.prototype.divM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw RangeError("Matrices dimensions must be equal");for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)/e.get(t,r));return this},e.div=function(e,r){return new t(e).div(r)},e.prototype.divide=e.prototype.div,e.prototype.divideS=e.prototype.divS,e.prototype.divideM=e.prototype.divM,e.divide=e.div,e.prototype.mod=function(e){return"number"==typeof e?this.modS(e):this.modM(e)},e.prototype.modS=function(e){for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)%e);return this},e.prototype.modM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw RangeError("Matrices dimensions must be equal");for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)%e.get(t,r));return this},e.mod=function(e,r){return new t(e).mod(r)},e.prototype.modulus=e.prototype.mod,e.prototype.modulusS=e.prototype.modS,e.prototype.modulusM=e.prototype.modM,e.modulus=e.mod,e.prototype.and=function(e){return"number"==typeof e?this.andS(e):this.andM(e)},e.prototype.andS=function(e){for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)&e);return this},e.prototype.andM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw RangeError("Matrices dimensions must be equal");for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)&e.get(t,r));return this},e.and=function(e,r){return new t(e).and(r)},e.prototype.or=function(e){return"number"==typeof e?this.orS(e):this.orM(e)},e.prototype.orS=function(e){for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)|e);return this},e.prototype.orM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw RangeError("Matrices dimensions must be equal");for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)|e.get(t,r));return this},e.or=function(e,r){return new t(e).or(r)},e.prototype.xor=function(e){return"number"==typeof e?this.xorS(e):this.xorM(e)},e.prototype.xorS=function(e){for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)^e);return this},e.prototype.xorM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw RangeError("Matrices dimensions must be equal");for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)^e.get(t,r));return this},e.xor=function(e,r){return new t(e).xor(r)},e.prototype.leftShift=function(e){return"number"==typeof e?this.leftShiftS(e):this.leftShiftM(e)},e.prototype.leftShiftS=function(e){for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)<<e);return this},e.prototype.leftShiftM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw RangeError("Matrices dimensions must be equal");for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)<<e.get(t,r));return this},e.leftShift=function(e,r){return new t(e).leftShift(r)},e.prototype.signPropagatingRightShift=function(e){return"number"==typeof e?this.signPropagatingRightShiftS(e):this.signPropagatingRightShiftM(e)},e.prototype.signPropagatingRightShiftS=function(e){for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)>>e);return this},e.prototype.signPropagatingRightShiftM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw RangeError("Matrices dimensions must be equal");for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)>>e.get(t,r));return this},e.signPropagatingRightShift=function(e,r){return new t(e).signPropagatingRightShift(r)},e.prototype.rightShift=function(e){return"number"==typeof e?this.rightShiftS(e):this.rightShiftM(e)},e.prototype.rightShiftS=function(e){for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)>>>e);return this},e.prototype.rightShiftM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw RangeError("Matrices dimensions must be equal");for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,this.get(t,r)>>>e.get(t,r));return this},e.rightShift=function(e,r){return new t(e).rightShift(r)},e.prototype.zeroFillRightShift=e.prototype.rightShift,e.prototype.zeroFillRightShiftS=e.prototype.rightShiftS,e.prototype.zeroFillRightShiftM=e.prototype.rightShiftM,e.zeroFillRightShift=e.rightShift,e.prototype.not=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,~this.get(e,t));return this},e.not=function(e){return new t(e).not()},e.prototype.abs=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.abs(this.get(e,t)));return this},e.abs=function(e){return new t(e).abs()},e.prototype.acos=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.acos(this.get(e,t)));return this},e.acos=function(e){return new t(e).acos()},e.prototype.acosh=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.acosh(this.get(e,t)));return this},e.acosh=function(e){return new t(e).acosh()},e.prototype.asin=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.asin(this.get(e,t)));return this},e.asin=function(e){return new t(e).asin()},e.prototype.asinh=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.asinh(this.get(e,t)));return this},e.asinh=function(e){return new t(e).asinh()},e.prototype.atan=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.atan(this.get(e,t)));return this},e.atan=function(e){return new t(e).atan()},e.prototype.atanh=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.atanh(this.get(e,t)));return this},e.atanh=function(e){return new t(e).atanh()},e.prototype.cbrt=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.cbrt(this.get(e,t)));return this},e.cbrt=function(e){return new t(e).cbrt()},e.prototype.ceil=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.ceil(this.get(e,t)));return this},e.ceil=function(e){return new t(e).ceil()},e.prototype.clz32=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.clz32(this.get(e,t)));return this},e.clz32=function(e){return new t(e).clz32()},e.prototype.cos=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.cos(this.get(e,t)));return this},e.cos=function(e){return new t(e).cos()},e.prototype.cosh=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.cosh(this.get(e,t)));return this},e.cosh=function(e){return new t(e).cosh()},e.prototype.exp=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.exp(this.get(e,t)));return this},e.exp=function(e){return new t(e).exp()},e.prototype.expm1=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.expm1(this.get(e,t)));return this},e.expm1=function(e){return new t(e).expm1()},e.prototype.floor=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.floor(this.get(e,t)));return this},e.floor=function(e){return new t(e).floor()},e.prototype.fround=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.fround(this.get(e,t)));return this},e.fround=function(e){return new t(e).fround()},e.prototype.log=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.log(this.get(e,t)));return this},e.log=function(e){return new t(e).log()},e.prototype.log1p=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.log1p(this.get(e,t)));return this},e.log1p=function(e){return new t(e).log1p()},e.prototype.log10=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.log10(this.get(e,t)));return this},e.log10=function(e){return new t(e).log10()},e.prototype.log2=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.log2(this.get(e,t)));return this},e.log2=function(e){return new t(e).log2()},e.prototype.round=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.round(this.get(e,t)));return this},e.round=function(e){return new t(e).round()},e.prototype.sign=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.sign(this.get(e,t)));return this},e.sign=function(e){return new t(e).sign()},e.prototype.sin=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.sin(this.get(e,t)));return this},e.sin=function(e){return new t(e).sin()},e.prototype.sinh=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.sinh(this.get(e,t)));return this},e.sinh=function(e){return new t(e).sinh()},e.prototype.sqrt=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.sqrt(this.get(e,t)));return this},e.sqrt=function(e){return new t(e).sqrt()},e.prototype.tan=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.tan(this.get(e,t)));return this},e.tan=function(e){return new t(e).tan()},e.prototype.tanh=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.tanh(this.get(e,t)));return this},e.tanh=function(e){return new t(e).tanh()},e.prototype.trunc=function(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,Math.trunc(this.get(e,t)));return this},e.trunc=function(e){return new t(e).trunc()},e.pow=function(e,r){return new t(e).pow(r)},e.prototype.pow=function(e){return"number"==typeof e?this.powS(e):this.powM(e)},e.prototype.powS=function(e){for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,Math.pow(this.get(t,r),e));return this},e.prototype.powM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw RangeError("Matrices dimensions must be equal");for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)this.set(t,r,Math.pow(this.get(t,r),e.get(t,r)));return this}}(ik,iO);class iD extends ik{#e;get size(){return this.#e.size}get rows(){return this.#e.rows}get columns(){return this.#e.columns}get diagonalSize(){return this.rows}static isSymmetricMatrix(e){return iO.isMatrix(e)&&"SymmetricMatrix"===e.klassType}static zeros(e){return new this(e)}static ones(e){return new this(e).fill(1)}constructor(e){if(super(),iO.isMatrix(e)){if(!e.isSymmetric())throw TypeError("not symmetric data");this.#e=iO.copy(e,new iO(e.rows,e.rows))}else if(Number.isInteger(e)&&e>=0)this.#e=new iO(e,e);else if(this.#e=new iO(e),!this.isSymmetric())throw TypeError("not symmetric data")}clone(){let e=new iD(this.diagonalSize);for(let[t,r,i]of this.upperRightEntries())e.set(t,r,i);return e}toMatrix(){return new iO(this)}get(e,t){return this.#e.get(e,t)}set(e,t,r){return this.#e.set(e,t,r),this.#e.set(t,e,r),this}removeCross(e){return this.#e.removeRow(e),this.#e.removeColumn(e),this}addCross(e,t){void 0===t&&(t=e,e=this.diagonalSize);let r=t.slice();return r.splice(e,1),this.#e.addRow(e,r),this.#e.addColumn(e,t),this}applyMask(e){if(e.length!==this.diagonalSize)throw RangeError("Mask size do not match with matrix size");let t=[];for(let[r,i]of e.entries())i||t.push(r);for(let e of(t.reverse(),t))this.removeCross(e);return this}toCompact(){let{diagonalSize:e}=this,t=Array(e*(e+1)/2);for(let r=0,i=0,o=0;o<t.length;o++)t[o]=this.get(i,r),++r>=e&&(r=++i);return t}static fromCompact(e){let t=e.length,r=(Math.sqrt(8*t+1)-1)/2;if(!Number.isInteger(r))throw TypeError(`This array is not a compact representation of a Symmetric Matrix, ${JSON.stringify(e)}`);let i=new iD(r);for(let o=0,s=0,n=0;n<t;n++)i.set(o,s,e[n]),++o>=r&&(o=++s);return i}*upperRightEntries(){for(let e=0,t=0;e<this.diagonalSize;){let r=this.get(e,t);yield[e,t,r],++t>=this.diagonalSize&&(t=++e)}}*upperRightValues(){for(let e=0,t=0;e<this.diagonalSize;)yield this.get(e,t),++t>=this.diagonalSize&&(t=++e)}}iD.prototype.klassType="SymmetricMatrix";class iG extends iD{static isDistanceMatrix(e){return iD.isSymmetricMatrix(e)&&"DistanceMatrix"===e.klassSubType}constructor(e){if(super(e),!this.isDistance())throw TypeError("Provided arguments do no produce a distance matrix")}set(e,t,r){return e===t&&(r=0),super.set(e,t,r)}addCross(e,t){return void 0===t&&(t=e,e=this.diagonalSize),(t=t.slice())[e]=0,super.addCross(e,t)}toSymmetricMatrix(){return new iD(this)}clone(){let e=new iG(this.diagonalSize);for(let[t,r,i]of this.upperRightEntries())t!==r&&e.set(t,r,i);return e}toCompact(){let{diagonalSize:e}=this,t=Array((e-1)*e/2);for(let r=1,i=0,o=0;o<t.length;o++)t[o]=this.get(i,r),++r>=e&&(r=++i+1);return t}static fromCompact(e){let t=e.length,r=(Math.sqrt(8*t+1)+1)/2;if(!Number.isInteger(r))throw TypeError(`This array is not a compact representation of a DistanceMatrix, ${JSON.stringify(e)}`);let i=new this(r);for(let o=1,s=0,n=0;n<t;n++)i.set(o,s,e[n]),++o>=r&&(o=++s+1);return i}}iG.prototype.klassSubType="DistanceMatrix";class iN extends ik{constructor(e,t,r){super(),this.matrix=e,this.rows=t,this.columns=r}}class iz extends iN{constructor(e,t){iE(e,t),super(e,e.rows,1),this.column=t}set(e,t,r){return this.matrix.set(e,this.column,r),this}get(e){return this.matrix.get(e,this.column)}}class iB extends iN{constructor(e,t){iI(e,t),super(e,e.rows,t.length),this.columnIndices=t}set(e,t,r){return this.matrix.set(e,this.columnIndices[t],r),this}get(e,t){return this.matrix.get(e,this.columnIndices[t])}}class iU extends iN{constructor(e){super(e,e.rows,e.columns)}set(e,t,r){return this.matrix.set(e,this.columns-t-1,r),this}get(e,t){return this.matrix.get(e,this.columns-t-1)}}class iV extends iN{constructor(e){super(e,e.rows,e.columns)}set(e,t,r){return this.matrix.set(this.rows-e-1,t,r),this}get(e,t){return this.matrix.get(this.rows-e-1,t)}}class iW extends iN{constructor(e,t){iT(e,t),super(e,1,e.columns),this.row=t}set(e,t,r){return this.matrix.set(this.row,t,r),this}get(e,t){return this.matrix.get(this.row,t)}}class iZ extends iN{constructor(e,t){iR(e,t),super(e,t.length,e.columns),this.rowIndices=t}set(e,t,r){return this.matrix.set(this.rowIndices[e],t,r),this}get(e,t){return this.matrix.get(this.rowIndices[e],t)}}class iq extends iN{constructor(e,t,r){iR(e,t),iI(e,r),super(e,t.length,r.length),this.rowIndices=t,this.columnIndices=r}set(e,t,r){return this.matrix.set(this.rowIndices[e],this.columnIndices[t],r),this}get(e,t){return this.matrix.get(this.rowIndices[e],this.columnIndices[t])}}class i$ extends iN{constructor(e,t,r,i,o){iC(e,t,r,i,o),super(e,r-t+1,o-i+1),this.startRow=t,this.startColumn=i}set(e,t,r){return this.matrix.set(this.startRow+e,this.startColumn+t,r),this}get(e,t){return this.matrix.get(this.startRow+e,this.startColumn+t)}}class iX extends iN{constructor(e){super(e,e.columns,e.rows)}set(e,t,r){return this.matrix.set(t,e,r),this}get(e,t){return this.matrix.get(t,e)}}class iH extends ik{constructor(e,t={}){let{rows:r=1}=t;if(e.length%r!=0)throw Error("the data length is not divisible by the number of rows");super(),this.rows=r,this.columns=e.length/r,this.data=e}set(e,t,r){let i=this._calculateIndex(e,t);return this.data[i]=r,this}get(e,t){let r=this._calculateIndex(e,t);return this.data[r]}_calculateIndex(e,t){return e*this.columns+t}}let iY=class extends ik{constructor(e){super(),this.data=e,this.rows=e.length,this.columns=e[0].length}set(e,t,r){return this.data[e][t]=r,this}get(e,t){return this.data[e][t]}};class iK{constructor(e){let t=(e=iY.checkMatrix(e)).clone(),r=t.rows,i=t.columns,o=new Float64Array(r),s=1,n,a,l,h,u,c,d,p,f;for(n=0;n<r;n++)o[n]=n;for(p=new Float64Array(r),a=0;a<i;a++){for(n=0;n<r;n++)p[n]=t.get(n,a);for(n=0;n<r;n++){for(f=Math.min(n,a),u=0,l=0;l<f;l++)u+=t.get(n,l)*p[l];p[n]-=u,t.set(n,a,p[n])}for(h=a,n=a+1;n<r;n++)Math.abs(p[n])>Math.abs(p[h])&&(h=n);if(h!==a){for(l=0;l<i;l++)c=t.get(h,l),t.set(h,l,t.get(a,l)),t.set(a,l,c);d=o[h],o[h]=o[a],o[a]=d,s=-s}if(a<r&&0!==t.get(a,a))for(n=a+1;n<r;n++)t.set(n,a,t.get(n,a)/t.get(a,a))}this.LU=t,this.pivotVector=o,this.pivotSign=s}isSingular(){let e=this.LU,t=e.columns;for(let r=0;r<t;r++)if(0===e.get(r,r))return!0;return!1}solve(e){e=iO.checkMatrix(e);let t=this.LU;if(t.rows!==e.rows)throw Error("Invalid matrix dimensions");if(this.isSingular())throw Error("LU matrix is singular");let r=e.columns,i=e.subMatrixRow(this.pivotVector,0,r-1),o=t.columns,s,n,a;for(a=0;a<o;a++)for(s=a+1;s<o;s++)for(n=0;n<r;n++)i.set(s,n,i.get(s,n)-i.get(a,n)*t.get(s,a));for(a=o-1;a>=0;a--){for(n=0;n<r;n++)i.set(a,n,i.get(a,n)/t.get(a,a));for(s=0;s<a;s++)for(n=0;n<r;n++)i.set(s,n,i.get(s,n)-i.get(a,n)*t.get(s,a))}return i}get determinant(){let e=this.LU;if(!e.isSquare())throw Error("Matrix must be square");let t=this.pivotSign,r=e.columns;for(let i=0;i<r;i++)t*=e.get(i,i);return t}get lowerTriangularMatrix(){let e=this.LU,t=e.rows,r=e.columns,i=new iO(t,r);for(let o=0;o<t;o++)for(let t=0;t<r;t++)o>t?i.set(o,t,e.get(o,t)):o===t?i.set(o,t,1):i.set(o,t,0);return i}get upperTriangularMatrix(){let e=this.LU,t=e.rows,r=e.columns,i=new iO(t,r);for(let o=0;o<t;o++)for(let t=0;t<r;t++)o<=t?i.set(o,t,e.get(o,t)):i.set(o,t,0);return i}get pivotPermutationVector(){return Array.from(this.pivotVector)}}function iJ(e,t){let r=0;return Math.abs(e)>Math.abs(t)?(r=t/e,Math.abs(e)*Math.sqrt(1+r*r)):0!==t?(r=e/t,Math.abs(t)*Math.sqrt(1+r*r)):0}class iQ{constructor(e){let t=(e=iY.checkMatrix(e)).clone(),r=e.rows,i=e.columns,o=new Float64Array(i),s,n,a,l;for(a=0;a<i;a++){let e=0;for(s=a;s<r;s++)e=iJ(e,t.get(s,a));if(0!==e){for(0>t.get(a,a)&&(e=-e),s=a;s<r;s++)t.set(s,a,t.get(s,a)/e);for(t.set(a,a,t.get(a,a)+1),n=a+1;n<i;n++){for(l=0,s=a;s<r;s++)l+=t.get(s,a)*t.get(s,n);for(l=-l/t.get(a,a),s=a;s<r;s++)t.set(s,n,t.get(s,n)+l*t.get(s,a))}}o[a]=-e}this.QR=t,this.Rdiag=o}solve(e){e=iO.checkMatrix(e);let t=this.QR,r=t.rows;if(e.rows!==r)throw Error("Matrix row dimensions must agree");if(!this.isFullRank())throw Error("Matrix is rank deficient");let i=e.columns,o=e.clone(),s=t.columns,n,a,l,h;for(l=0;l<s;l++)for(a=0;a<i;a++){for(h=0,n=l;n<r;n++)h+=t.get(n,l)*o.get(n,a);for(h=-h/t.get(l,l),n=l;n<r;n++)o.set(n,a,o.get(n,a)+h*t.get(n,l))}for(l=s-1;l>=0;l--){for(a=0;a<i;a++)o.set(l,a,o.get(l,a)/this.Rdiag[l]);for(n=0;n<l;n++)for(a=0;a<i;a++)o.set(n,a,o.get(n,a)-o.get(l,a)*t.get(n,l))}return o.subMatrix(0,s-1,0,i-1)}isFullRank(){let e=this.QR.columns;for(let t=0;t<e;t++)if(0===this.Rdiag[t])return!1;return!0}get upperTriangularMatrix(){let e=this.QR,t=e.columns,r=new iO(t,t),i,o;for(i=0;i<t;i++)for(o=0;o<t;o++)i<o?r.set(i,o,e.get(i,o)):i===o?r.set(i,o,this.Rdiag[i]):r.set(i,o,0);return r}get orthogonalMatrix(){let e=this.QR,t=e.rows,r=e.columns,i=new iO(t,r),o,s,n,a;for(n=r-1;n>=0;n--){for(o=0;o<t;o++)i.set(o,n,0);for(i.set(n,n,1),s=n;s<r;s++)if(0!==e.get(n,n)){for(a=0,o=n;o<t;o++)a+=e.get(o,n)*i.get(o,s);for(a=-a/e.get(n,n),o=n;o<t;o++)i.set(o,s,i.get(o,s)+a*e.get(o,n))}}return i}}let i0=class{constructor(e,t={}){if((e=iY.checkMatrix(e)).isEmpty())throw Error("Matrix must be non-empty");let r=e.rows,i=e.columns,{computeLeftSingularVectors:o=!0,computeRightSingularVectors:s=!0,autoTranspose:n=!1}=t,a=!!o,l=!!s,h=!1,u;if(r<i)if(n){r=(u=e.transpose()).rows,i=u.columns,h=!0;let t=a;a=l,l=t}else u=e.clone(),console.warn("Computing SVD on a matrix with more columns than rows. Consider enabling autoTranspose");else u=e.clone();let c=Math.min(r,i),d=Math.min(r+1,i),p=new Float64Array(d),f=new iO(r,c),m=new iO(i,i),g=new Float64Array(i),v=new Float64Array(r),y=new Float64Array(d);for(let e=0;e<d;e++)y[e]=e;let w=Math.min(r-1,i),x=Math.max(0,Math.min(i-2,r)),_=Math.max(w,x);for(let e=0;e<_;e++){if(e<w){p[e]=0;for(let t=e;t<r;t++)p[e]=iJ(p[e],u.get(t,e));if(0!==p[e]){0>u.get(e,e)&&(p[e]=-p[e]);for(let t=e;t<r;t++)u.set(t,e,u.get(t,e)/p[e]);u.set(e,e,u.get(e,e)+1)}p[e]=-p[e]}for(let t=e+1;t<i;t++){if(e<w&&0!==p[e]){let i=0;for(let o=e;o<r;o++)i+=u.get(o,e)*u.get(o,t);i=-i/u.get(e,e);for(let o=e;o<r;o++)u.set(o,t,u.get(o,t)+i*u.get(o,e))}g[t]=u.get(e,t)}if(a&&e<w)for(let t=e;t<r;t++)f.set(t,e,u.get(t,e));if(e<x){g[e]=0;for(let t=e+1;t<i;t++)g[e]=iJ(g[e],g[t]);if(0!==g[e]){g[e+1]<0&&(g[e]=0-g[e]);for(let t=e+1;t<i;t++)g[t]/=g[e];g[e+1]+=1}if(g[e]=-g[e],e+1<r&&0!==g[e]){for(let t=e+1;t<r;t++)v[t]=0;for(let t=e+1;t<r;t++)for(let r=e+1;r<i;r++)v[t]+=g[r]*u.get(t,r);for(let t=e+1;t<i;t++){let i=-g[t]/g[e+1];for(let o=e+1;o<r;o++)u.set(o,t,u.get(o,t)+i*v[o])}}if(l)for(let t=e+1;t<i;t++)m.set(t,e,g[t])}}let b=Math.min(i,r+1);if(w<i&&(p[w]=u.get(w,w)),r<b&&(p[b-1]=0),x+1<b&&(g[x]=u.get(x,b-1)),g[b-1]=0,a){for(let e=w;e<c;e++){for(let t=0;t<r;t++)f.set(t,e,0);f.set(e,e,1)}for(let e=w-1;e>=0;e--)if(0!==p[e]){for(let t=e+1;t<c;t++){let i=0;for(let o=e;o<r;o++)i+=f.get(o,e)*f.get(o,t);i=-i/f.get(e,e);for(let o=e;o<r;o++)f.set(o,t,f.get(o,t)+i*f.get(o,e))}for(let t=e;t<r;t++)f.set(t,e,-f.get(t,e));f.set(e,e,1+f.get(e,e));for(let t=0;t<e-1;t++)f.set(t,e,0)}else{for(let t=0;t<r;t++)f.set(t,e,0);f.set(e,e,1)}}if(l)for(let e=i-1;e>=0;e--){if(e<x&&0!==g[e])for(let t=e+1;t<i;t++){let r=0;for(let o=e+1;o<i;o++)r+=m.get(o,e)*m.get(o,t);r=-r/m.get(e+1,e);for(let o=e+1;o<i;o++)m.set(o,t,m.get(o,t)+r*m.get(o,e))}for(let t=0;t<i;t++)m.set(t,e,0);m.set(e,e,1)}let M=b-1,T=Number.EPSILON;for(;b>0;){let e,t;for(e=b-2;e>=-1&&-1!==e;e--){let t=Number.MIN_VALUE+T*Math.abs(p[e]+Math.abs(p[e+1]));if(Math.abs(g[e])<=t||Number.isNaN(g[e])){g[e]=0;break}}if(e===b-2)t=4;else{let r;for(r=b-1;r>=e&&r!==e;r--){let t=(r!==b?Math.abs(g[r]):0)+(r!==e+1?Math.abs(g[r-1]):0);if(Math.abs(p[r])<=T*t){p[r]=0;break}}r===e?t=3:r===b-1?t=1:(t=2,e=r)}switch(e++,t){case 1:{let t=g[b-2];g[b-2]=0;for(let r=b-2;r>=e;r--){let o=iJ(p[r],t),s=p[r]/o,n=t/o;if(p[r]=o,r!==e&&(t=-n*g[r-1],g[r-1]=s*g[r-1]),l)for(let e=0;e<i;e++)o=s*m.get(e,r)+n*m.get(e,b-1),m.set(e,b-1,-n*m.get(e,r)+s*m.get(e,b-1)),m.set(e,r,o)}break}case 2:{let t=g[e-1];g[e-1]=0;for(let i=e;i<b;i++){let o=iJ(p[i],t),s=p[i]/o,n=t/o;if(p[i]=o,t=-n*g[i],g[i]=s*g[i],a)for(let t=0;t<r;t++)o=s*f.get(t,i)+n*f.get(t,e-1),f.set(t,e-1,-n*f.get(t,i)+s*f.get(t,e-1)),f.set(t,i,o)}break}case 3:{let t=Math.max(Math.abs(p[b-1]),Math.abs(p[b-2]),Math.abs(g[b-2]),Math.abs(p[e]),Math.abs(g[e])),o=p[b-1]/t,s=p[b-2]/t,n=g[b-2]/t,h=p[e]/t,u=g[e]/t,c=((s+o)*(s-o)+n*n)/2,d=o*n*(o*n),v=0;(0!==c||0!==d)&&(v=c<0?0-Math.sqrt(c*c+d):Math.sqrt(c*c+d),v=d/(c+v));let y=(h+o)*(h-o)+v,w=h*u;for(let t=e;t<b-1;t++){let o=iJ(y,w);0===o&&(o=Number.MIN_VALUE);let s=y/o,n=w/o;if(t!==e&&(g[t-1]=o),y=s*p[t]+n*g[t],g[t]=s*g[t]-n*p[t],w=n*p[t+1],p[t+1]=s*p[t+1],l)for(let e=0;e<i;e++)o=s*m.get(e,t)+n*m.get(e,t+1),m.set(e,t+1,-n*m.get(e,t)+s*m.get(e,t+1)),m.set(e,t,o);if(0===(o=iJ(y,w))&&(o=Number.MIN_VALUE),s=y/o,n=w/o,p[t]=o,y=s*g[t]+n*p[t+1],p[t+1]=-n*g[t]+s*p[t+1],w=n*g[t+1],g[t+1]=s*g[t+1],a&&t<r-1)for(let e=0;e<r;e++)o=s*f.get(e,t)+n*f.get(e,t+1),f.set(e,t+1,-n*f.get(e,t)+s*f.get(e,t+1)),f.set(e,t,o)}g[b-2]=y;break}case 4:if(p[e]<=0&&(p[e]=p[e]<0?-p[e]:0,l))for(let t=0;t<=M;t++)m.set(t,e,-m.get(t,e));for(;e<M&&!(p[e]>=p[e+1]);){let t=p[e];if(p[e]=p[e+1],p[e+1]=t,l&&e<i-1)for(let r=0;r<i;r++)t=m.get(r,e+1),m.set(r,e+1,m.get(r,e)),m.set(r,e,t);if(a&&e<r-1)for(let i=0;i<r;i++)t=f.get(i,e+1),f.set(i,e+1,f.get(i,e)),f.set(i,e,t);e++}b--}}if(h){let e=m;m=f,f=e}this.m=r,this.n=i,this.s=p,this.U=f,this.V=m}solve(e){let t=this.threshold,r=this.s.length,i=iO.zeros(r,r);for(let e=0;e<r;e++)Math.abs(this.s[e])<=t?i.set(e,e,0):i.set(e,e,1/this.s[e]);let o=this.U,s=this.rightSingularVectors,n=s.mmul(i),a=s.rows,l=o.rows,h=iO.zeros(a,l);for(let e=0;e<a;e++)for(let t=0;t<l;t++){let i=0;for(let s=0;s<r;s++)i+=n.get(e,s)*o.get(t,s);h.set(e,t,i)}return h.mmul(e)}solveForDiagonal(e){return this.solve(iO.diag(e))}inverse(){let e=this.V,t=this.threshold,r=e.rows,i=e.columns,o=new iO(r,this.s.length);for(let s=0;s<r;s++)for(let r=0;r<i;r++)Math.abs(this.s[r])>t&&o.set(s,r,e.get(s,r)/this.s[r]);let s=this.U,n=s.rows,a=s.columns,l=new iO(r,n);for(let e=0;e<r;e++)for(let t=0;t<n;t++){let r=0;for(let i=0;i<a;i++)r+=o.get(e,i)*s.get(t,i);l.set(e,t,r)}return l}get condition(){return this.s[0]/this.s[Math.min(this.m,this.n)-1]}get norm2(){return this.s[0]}get rank(){let e=Math.max(this.m,this.n)*this.s[0]*Number.EPSILON,t=0,r=this.s;for(let i=0,o=r.length;i<o;i++)r[i]>e&&t++;return t}get diagonal(){return Array.from(this.s)}get threshold(){return Number.EPSILON/2*Math.max(this.m,this.n)*this.s[0]}get leftSingularVectors(){return this.U}get rightSingularVectors(){return this.V}get diagonalMatrix(){return iO.diag(this.s)}};function i1(e,t,r=!1){return e=iY.checkMatrix(e),t=iY.checkMatrix(t),r?new i0(e).solve(t):e.isSquare()?new iK(e).solve(t):new iQ(e).solve(t)}class i2{constructor(e,t={}){let{assumeSymmetric:r=!1}=t;if(!(e=iY.checkMatrix(e)).isSquare())throw Error("Matrix is not a square matrix");if(e.isEmpty())throw Error("Matrix must be non-empty");let i=e.columns,o=new iO(i,i),s=new Float64Array(i),n=new Float64Array(i),a=e,l,h,u=!1;if(r||e.isSymmetric()){for(l=0;l<i;l++)for(h=0;h<i;h++)o.set(l,h,a.get(l,h));(function(e,t,r,i){let o,s,n,a,l,h,u,c;for(l=0;l<e;l++)r[l]=i.get(e-1,l);for(a=e-1;a>0;a--){for(c=0,n=0,h=0;h<a;h++)c+=Math.abs(r[h]);if(0===c)for(t[a]=r[a-1],l=0;l<a;l++)r[l]=i.get(a-1,l),i.set(a,l,0),i.set(l,a,0);else{for(h=0;h<a;h++)r[h]/=c,n+=r[h]*r[h];for(o=r[a-1],s=Math.sqrt(n),o>0&&(s=-s),t[a]=c*s,n-=o*s,r[a-1]=o-s,l=0;l<a;l++)t[l]=0;for(l=0;l<a;l++){for(o=r[l],i.set(l,a,o),s=t[l]+i.get(l,l)*o,h=l+1;h<=a-1;h++)s+=i.get(h,l)*r[h],t[h]+=i.get(h,l)*o;t[l]=s}for(o=0,l=0;l<a;l++)t[l]/=n,o+=t[l]*r[l];for(u=o/(n+n),l=0;l<a;l++)t[l]-=u*r[l];for(l=0;l<a;l++){for(o=r[l],s=t[l],h=l;h<=a-1;h++)i.set(h,l,i.get(h,l)-(o*t[h]+s*r[h]));r[l]=i.get(a-1,l),i.set(a,l,0)}}r[a]=n}for(a=0;a<e-1;a++){if(i.set(e-1,a,i.get(a,a)),i.set(a,a,1),0!==(n=r[a+1])){for(h=0;h<=a;h++)r[h]=i.get(h,a+1)/n;for(l=0;l<=a;l++){for(s=0,h=0;h<=a;h++)s+=i.get(h,a+1)*i.get(h,l);for(h=0;h<=a;h++)i.set(h,l,i.get(h,l)-s*r[h])}}for(h=0;h<=a;h++)i.set(h,a+1,0)}for(l=0;l<e;l++)r[l]=i.get(e-1,l),i.set(e-1,l,0);i.set(e-1,e-1,1),t[0]=0})(i,n,s,o),function(e,t,r,i){let o,s,n,a,l,h,u,c,d,p,f,m,g,v,y,w;for(n=1;n<e;n++)t[n-1]=t[n];t[e-1]=0;let x=0,_=0,b=Number.EPSILON;for(h=0;h<e;h++){for(_=Math.max(_,Math.abs(r[h])+Math.abs(t[h])),u=h;u<e&&!(Math.abs(t[u])<=b*_);)u++;if(u>h)do{for(o=r[h],d=iJ(c=(r[h+1]-o)/(2*t[h]),1),c<0&&(d=-d),r[h]=t[h]/(c+d),r[h+1]=t[h]*(c+d),p=r[h+1],s=o-r[h],n=h+2;n<e;n++)r[n]-=s;for(x+=s,c=r[u],m=f=1,g=f,v=t[h+1],y=0,w=0,n=u-1;n>=h;n--)for(g=m,m=f,w=y,o=f*t[n],s=f*c,d=iJ(c,t[n]),t[n+1]=y*d,y=t[n]/d,c=(f=c/d)*r[n]-y*o,r[n+1]=s+y*(f*o+y*r[n]),l=0;l<e;l++)s=i.get(l,n+1),i.set(l,n+1,y*i.get(l,n)+f*s),i.set(l,n,f*i.get(l,n)-y*s);c=-y*w*g*v*t[h]/p,t[h]=y*c,r[h]=f*c}while(Math.abs(t[h])>b*_);r[h]=r[h]+x,t[h]=0}for(n=0;n<e-1;n++){for(l=n,c=r[n],a=n+1;a<e;a++)r[a]<c&&(l=a,c=r[a]);if(l!==n)for(r[l]=r[n],r[n]=c,a=0;a<e;a++)c=i.get(a,n),i.set(a,n,i.get(a,l)),i.set(a,l,c)}}(i,n,s,o)}else{let e=new iO(i,i),t=new Float64Array(i);for(h=0;h<i;h++)for(l=0;l<i;l++)e.set(l,h,a.get(l,h));(function(e,t,r,i){let o=e-1,s,n,a,l,h,u,c;for(u=1;u<=o-1;u++){for(c=0,l=u;l<=o;l++)c+=Math.abs(t.get(l,u-1));if(0!==c){for(a=0,l=o;l>=u;l--)r[l]=t.get(l,u-1)/c,a+=r[l]*r[l];for(n=Math.sqrt(a),r[u]>0&&(n=-n),a-=r[u]*n,r[u]=r[u]-n,h=u;h<e;h++){for(s=0,l=o;l>=u;l--)s+=r[l]*t.get(l,h);for(s/=a,l=u;l<=o;l++)t.set(l,h,t.get(l,h)-s*r[l])}for(l=0;l<=o;l++){for(s=0,h=o;h>=u;h--)s+=r[h]*t.get(l,h);for(s/=a,h=u;h<=o;h++)t.set(l,h,t.get(l,h)-s*r[h])}r[u]=c*r[u],t.set(u,u-1,c*n)}}for(l=0;l<e;l++)for(h=0;h<e;h++)i.set(l,h,+(l===h));for(u=o-1;u>=1;u--)if(0!==t.get(u,u-1)){for(l=u+1;l<=o;l++)r[l]=t.get(l,u-1);for(h=u;h<=o;h++){for(n=0,l=u;l<=o;l++)n+=r[l]*i.get(l,h);for(n=n/r[u]/t.get(u,u-1),l=u;l<=o;l++)i.set(l,h,i.get(l,h)+n*r[l])}}})(i,e,t,o),function(e,t,r,i,o){let s=e-1,n=e-1,a=Number.EPSILON,l=0,h=0,u=0,c=0,d=0,p=0,f=0,m=0,g,v,y,w,x,_,b,M,T,E,P,S,R,I,C;for(g=0;g<e;g++)for((g<0||g>n)&&(r[g]=o.get(g,g),t[g]=0),v=Math.max(g-1,0);v<e;v++)h+=Math.abs(o.get(g,v));for(;s>=0;){for(w=s;w>0&&(0===(p=Math.abs(o.get(w-1,w-1))+Math.abs(o.get(w,w)))&&(p=h),!(Math.abs(o.get(w,w-1))<a*p));)w--;if(w===s)o.set(s,s,o.get(s,s)+l),r[s]=o.get(s,s),t[s]=0,s--,m=0;else if(w===s-1){if(b=o.get(s,s-1)*o.get(s-1,s),f=Math.sqrt(Math.abs(c=(u=(o.get(s-1,s-1)-o.get(s,s))/2)*u+b)),o.set(s,s,o.get(s,s)+l),o.set(s-1,s-1,o.get(s-1,s-1)+l),M=o.get(s,s),c>=0){for(f=u>=0?u+f:u-f,r[s-1]=M+f,r[s]=r[s-1],0!==f&&(r[s]=M-b/f),t[s-1]=0,t[s]=0,p=Math.abs(M=o.get(s,s-1))+Math.abs(f),d=Math.sqrt((u=M/p)*u+(c=f/p)*c),u/=d,c/=d,v=s-1;v<e;v++)f=o.get(s-1,v),o.set(s-1,v,c*f+u*o.get(s,v)),o.set(s,v,c*o.get(s,v)-u*f);for(g=0;g<=s;g++)f=o.get(g,s-1),o.set(g,s-1,c*f+u*o.get(g,s)),o.set(g,s,c*o.get(g,s)-u*f);for(g=0;g<=n;g++)f=i.get(g,s-1),i.set(g,s-1,c*f+u*i.get(g,s)),i.set(g,s,c*i.get(g,s)-u*f)}else r[s-1]=M+u,r[s]=M+u,t[s-1]=f,t[s]=-f;s-=2,m=0}else{if(M=o.get(s,s),T=0,b=0,w<s&&(T=o.get(s-1,s-1),b=o.get(s,s-1)*o.get(s-1,s)),10===m){for(l+=M,g=0;g<=s;g++)o.set(g,g,o.get(g,g)-M);M=T=.75*(p=Math.abs(o.get(s,s-1))+Math.abs(o.get(s-1,s-2))),b=-.4375*p*p}if(30===m&&(p=(p=(T-M)/2)*p+b)>0){for(p=Math.sqrt(p),T<M&&(p=-p),p=M-b/((T-M)/2+p),g=0;g<=s;g++)o.set(g,g,o.get(g,g)-p);l+=p,M=T=b=.964}for(m+=1,x=s-2;x>=w&&(u=((d=M-(f=o.get(x,x)))*(p=T-f)-b)/o.get(x+1,x)+o.get(x,x+1),p=Math.abs(u)+Math.abs(c=o.get(x+1,x+1)-f-d-p)+Math.abs(d=o.get(x+2,x+1)),u/=p,c/=p,d/=p,!(x===w||Math.abs(o.get(x,x-1))*(Math.abs(c)+Math.abs(d))<a*(Math.abs(u)*(Math.abs(o.get(x-1,x-1))+Math.abs(f)+Math.abs(o.get(x+1,x+1))))));)x--;for(g=x+2;g<=s;g++)o.set(g,g-2,0),g>x+2&&o.set(g,g-3,0);for(y=x;y<=s-1&&(I=y!==s-1,y!==x&&(u=o.get(y,y-1),0!==(M=Math.abs(u)+Math.abs(c=o.get(y+1,y-1))+Math.abs(d=I?o.get(y+2,y-1):0))&&(u/=M,c/=M,d/=M)),0!==M);y++)if(p=Math.sqrt(u*u+c*c+d*d),u<0&&(p=-p),0!==p){for(y!==x?o.set(y,y-1,-p*M):w!==x&&o.set(y,y-1,-o.get(y,y-1)),u+=p,M=u/p,T=c/p,f=d/p,c/=u,d/=u,v=y;v<e;v++)u=o.get(y,v)+c*o.get(y+1,v),I&&(u+=d*o.get(y+2,v),o.set(y+2,v,o.get(y+2,v)-u*f)),o.set(y,v,o.get(y,v)-u*M),o.set(y+1,v,o.get(y+1,v)-u*T);for(g=0;g<=Math.min(s,y+3);g++)u=M*o.get(g,y)+T*o.get(g,y+1),I&&(u+=f*o.get(g,y+2),o.set(g,y+2,o.get(g,y+2)-u*d)),o.set(g,y,o.get(g,y)-u),o.set(g,y+1,o.get(g,y+1)-u*c);for(g=0;g<=n;g++)u=M*i.get(g,y)+T*i.get(g,y+1),I&&(u+=f*i.get(g,y+2),i.set(g,y+2,i.get(g,y+2)-u*d)),i.set(g,y,i.get(g,y)-u),i.set(g,y+1,i.get(g,y+1)-u*c)}}}if(0!==h){for(s=e-1;s>=0;s--)if(u=r[s],0===(c=t[s]))for(w=s,o.set(s,s,1),g=s-1;g>=0;g--){for(b=o.get(g,g)-u,d=0,v=w;v<=s;v++)d+=o.get(g,v)*o.get(v,s);if(t[g]<0)f=b,p=d;else if(w=g,0===t[g]?o.set(g,s,0!==b?-d/b:-d/(a*h)):(M=o.get(g,g+1),T=o.get(g+1,g),_=(M*p-f*d)/(c=(r[g]-u)*(r[g]-u)+t[g]*t[g]),o.set(g,s,_),o.set(g+1,s,Math.abs(M)>Math.abs(f)?(-d-b*_)/M:(-p-T*_)/f)),a*(_=Math.abs(o.get(g,s)))*_>1)for(v=g;v<=s;v++)o.set(v,s,o.get(v,s)/_)}else if(c<0)for(w=s-1,Math.abs(o.get(s,s-1))>Math.abs(o.get(s-1,s))?(o.set(s-1,s-1,c/o.get(s,s-1)),o.set(s-1,s,-(o.get(s,s)-u)/o.get(s,s-1))):(C=i3(0,-o.get(s-1,s),o.get(s-1,s-1)-u,c),o.set(s-1,s-1,C[0]),o.set(s-1,s,C[1])),o.set(s,s-1,0),o.set(s,s,1),g=s-2;g>=0;g--){for(E=0,P=0,v=w;v<=s;v++)E+=o.get(g,v)*o.get(v,s-1),P+=o.get(g,v)*o.get(v,s);if(b=o.get(g,g)-u,t[g]<0)f=b,d=E,p=P;else if(w=g,0===t[g]?(C=i3(-E,-P,b,c),o.set(g,s-1,C[0]),o.set(g,s,C[1])):(M=o.get(g,g+1),T=o.get(g+1,g),S=(r[g]-u)*(r[g]-u)+t[g]*t[g]-c*c,R=(r[g]-u)*2*c,0===S&&0===R&&(S=a*h*(Math.abs(b)+Math.abs(c)+Math.abs(M)+Math.abs(T)+Math.abs(f))),C=i3(M*d-f*E+c*P,M*p-f*P-c*E,S,R),o.set(g,s-1,C[0]),o.set(g,s,C[1]),Math.abs(M)>Math.abs(f)+Math.abs(c)?(o.set(g+1,s-1,(-E-b*o.get(g,s-1)+c*o.get(g,s))/M),o.set(g+1,s,(-P-b*o.get(g,s)-c*o.get(g,s-1))/M)):(C=i3(-d-T*o.get(g,s-1),-p-T*o.get(g,s),f,c),o.set(g+1,s-1,C[0]),o.set(g+1,s,C[1]))),a*(_=Math.max(Math.abs(o.get(g,s-1)),Math.abs(o.get(g,s))))*_>1)for(v=g;v<=s;v++)o.set(v,s-1,o.get(v,s-1)/_),o.set(v,s,o.get(v,s)/_)}for(g=0;g<e;g++)if(g<0||g>n)for(v=g;v<e;v++)i.set(g,v,o.get(g,v));for(v=e-1;v>=0;v--)for(g=0;g<=n;g++){for(f=0,y=0;y<=Math.min(v,n);y++)f+=i.get(g,y)*o.get(y,v);i.set(g,v,f)}}}(i,n,s,o,e)}this.n=i,this.e=n,this.d=s,this.V=o}get realEigenvalues(){return Array.from(this.d)}get imaginaryEigenvalues(){return Array.from(this.e)}get eigenvectorMatrix(){return this.V}get diagonalMatrix(){let e=this.n,t=this.e,r=this.d,i=new iO(e,e),o,s;for(o=0;o<e;o++){for(s=0;s<e;s++)i.set(o,s,0);i.set(o,o,r[o]),t[o]>0?i.set(o,o+1,t[o]):t[o]<0&&i.set(o,o-1,t[o])}return i}}function i3(e,t,r,i){let o,s;return Math.abs(r)>Math.abs(i)?(o=i/r,s=r+o*i,[(e+o*t)/s,(t-o*e)/s]):(o=r/i,s=i+o*r,[(o*e+t)/s,(o*t-e)/s])}class i4{constructor(e){if(!(e=iY.checkMatrix(e)).isSymmetric())throw Error("Matrix is not symmetric");let t=e,r=t.rows,i=new iO(r,r),o=!0,s,n,a;for(n=0;n<r;n++){let e=0;for(a=0;a<n;a++){let r=0;for(s=0;s<a;s++)r+=i.get(a,s)*i.get(n,s);r=(t.get(n,a)-r)/i.get(a,a),i.set(n,a,r),e+=r*r}for(o&=(e=t.get(n,n)-e)>0,i.set(n,n,Math.sqrt(Math.max(e,0))),a=n+1;a<r;a++)i.set(n,a,0)}this.L=i,this.positiveDefinite=!!o}isPositiveDefinite(){return this.positiveDefinite}solve(e){e=iY.checkMatrix(e);let t=this.L,r=t.rows;if(e.rows!==r)throw Error("Matrix dimensions do not match");if(!1===this.isPositiveDefinite())throw Error("Matrix is not positive definite");let i=e.columns,o=e.clone(),s,n,a;for(a=0;a<r;a++)for(n=0;n<i;n++){for(s=0;s<a;s++)o.set(a,n,o.get(a,n)-o.get(s,n)*t.get(a,s));o.set(a,n,o.get(a,n)/t.get(a,a))}for(a=r-1;a>=0;a--)for(n=0;n<i;n++){for(s=a+1;s<r;s++)o.set(a,n,o.get(a,n)-o.get(s,n)*t.get(s,a));o.set(a,n,o.get(a,n)/t.get(a,a))}return o}get lowerTriangularMatrix(){return this.L}}class i5{constructor(e,t={}){let r;e=iY.checkMatrix(e);let{Y:i}=t,{scaleScores:o=!1,maxIterations:s=1e3,terminationCriteria:n=1e-10}=t;if(i){if((i=iy.isAnyArray(i)&&"number"==typeof i[0]?iO.columnVector(i):iY.checkMatrix(i)).rows!==e.rows)throw Error("Y should have the same number of rows as X");r=i.getColumnVector(0)}else r=e.getColumnVector(0);let a=1,l,h,u,c;for(let t=0;t<s&&a>n;t++)u=(u=e.transpose().mmul(r).div(r.transpose().mmul(r).get(0,0))).div(u.norm()),l=e.mmul(u).div(u.transpose().mmul(u).get(0,0)),t>0&&(a=l.clone().sub(c).pow(2).sum()),c=l.clone(),i?(h=(h=i.transpose().mmul(l).div(l.transpose().mmul(l).get(0,0))).div(h.norm()),r=i.mmul(h).div(h.transpose().mmul(h).get(0,0))):r=l;if(i){let t=e.transpose().mmul(l).div(l.transpose().mmul(l).get(0,0));t=t.div(t.norm());let o=e.clone().sub(l.clone().mmul(t.transpose())),s=r.transpose().mmul(l).div(l.transpose().mmul(l).get(0,0)),n=i.clone().sub(l.clone().mulS(s.get(0,0)).mmul(h.transpose()));this.t=l,this.p=t.transpose(),this.w=u.transpose(),this.q=h,this.u=r,this.s=l.transpose().mmul(l),this.xResidual=o,this.yResidual=n,this.betas=s}else this.w=u.transpose(),this.s=l.transpose().mmul(l).sqrt(),o?this.t=l.clone().div(this.s.get(0,0)):this.t=l,this.xResidual=e.sub(l.mmul(u.transpose()))}}im.AbstractMatrix=ik,im.CHO=i4,im.CholeskyDecomposition=i4,im.DistanceMatrix=iG,im.EVD=i2,im.EigenvalueDecomposition=i2,im.LU=iK,im.LuDecomposition=iK;var i9=im.Matrix=iO;im.MatrixColumnSelectionView=iB,im.MatrixColumnView=iz,im.MatrixFlipColumnView=iU,im.MatrixFlipRowView=iV,im.MatrixRowSelectionView=iZ,im.MatrixRowView=iW,im.MatrixSelectionView=iq,im.MatrixSubView=i$,im.MatrixTransposeView=iX,im.NIPALS=i5,im.Nipals=i5,im.QR=iQ,im.QrDecomposition=iQ,im.SVD=i0;var i6=im.SingularValueDecomposition=i0;im.SymmetricMatrix=iD,im.WrapperMatrix1D=iH,im.WrapperMatrix2D=iY,im.correlation=function(e,t=e,r={}){e=new iO(e);let i=!1;if("object"!=typeof t||iO.isMatrix(t)||iy.isAnyArray(t)?t=new iO(t):(r=t,t=e,i=!0),e.rows!==t.rows)throw TypeError("Both matrices must have the same number of rows");let{center:o=!0,scale:s=!0}=r;o&&(e.center("column"),i||t.center("column")),s&&(e.scale("column"),i||t.scale("column"));let n=e.standardDeviation("column",{unbiased:!0}),a=i?n:t.standardDeviation("column",{unbiased:!0}),l=e.transpose().mmul(t);for(let t=0;t<l.rows;t++)for(let r=0;r<l.columns;r++)l.set(t,r,l.get(t,r)*(1/(n[t]*a[r]))*(1/(e.rows-1)));return l},im.covariance=function(e,t=e,r={}){e=new iO(e);let i=!1;if("object"!=typeof t||iO.isMatrix(t)||iy.isAnyArray(t)?t=new iO(t):(r=t,t=e,i=!0),e.rows!==t.rows)throw TypeError("Both matrices must have the same number of rows");let{center:o=!0}=r;o&&(e=e.center("column"),i||(t=t.center("column")));let s=e.transpose().mmul(t);for(let t=0;t<s.rows;t++)for(let r=0;r<s.columns;r++)s.set(t,r,s.get(t,r)*(1/(e.rows-1)));return s};var i8=im.default=iO;im.determinant=function e(t){if((t=iO.checkMatrix(t)).isSquare()){let r,i,o;if(0===t.columns)return 1;if(2===t.columns)return r=t.get(0,0),i=t.get(0,1),o=t.get(1,0),r*t.get(1,1)-i*o;if(3!==t.columns)return new iK(t).determinant;{let s,n,a;return s=new iq(t,[1,2],[1,2]),n=new iq(t,[1,2],[0,2]),a=new iq(t,[1,2],[0,1]),r=t.get(0,0),i=t.get(0,1),o=t.get(0,2),r*e(s)-i*e(n)+o*e(a)}}throw Error("determinant can only be calculated for a square matrix")};var i7=im.inverse=function(e,t=!1){return e=iY.checkMatrix(e),t?new i0(e).inverse():i1(e,iO.eye(e.rows))};im.linearDependencies=function(e,t={}){let{thresholdValue:r=1e-9,thresholdError:i=1e-9}=t,o=(e=iO.checkMatrix(e)).rows,s=new iO(o,o);for(let t=0;t<o;t++){let n=iO.columnVector(e.getRow(t)),a=e.subMatrixRow(function(e,t){let r=[];for(let i=0;i<e;i++)i!==t&&r.push(i);return r}(o,t)).transpose(),l=new i0(a).solve(n),h=iO.sub(n,a.mmul(l)).abs().max();s.setRow(t,function(e,t,r,i=1e-9,o=1e-9){if(e>o)return Array(t.rows+1).fill(0);{let e=t.addRow(r,[0]);for(let t=0;t<e.rows;t++)Math.abs(e.get(t,0))<i&&e.set(t,0,0);return e.to1DArray()}}(h,l,t,r,i))}return s};var oe=im.pseudoInverse=function(e,t=Number.EPSILON){if((e=iO.checkMatrix(e)).isEmpty())return e.transpose();let r=new i0(e,{autoTranspose:!0}),i=r.leftSingularVectors,o=r.rightSingularVectors,s=r.diagonal;for(let e=0;e<s.length;e++)Math.abs(s[e])>t?s[e]=1/s[e]:s[e]=0;return o.mmul(iO.diag(s).mmul(i.transpose()))};im.solve=i1,im.wrap=function(e,t){if(iy.isAnyArray(e))return e[0]&&iy.isAnyArray(e[0])?new iY(e):new iH(e,t);throw Error("the argument is not an array")},i8.Matrix&&i8.Matrix;class ot{sourcePoints;destinationPoints;pointCount;pointCountMinimum;type;constructor(e,t,r,i){if(this.sourcePoints=e,this.destinationPoints=t,this.pointCount=this.sourcePoints.length,this.type=r,this.pointCountMinimum=i,this.pointCount<this.pointCountMinimum)throw Error("Not enough control points. A "+this.type+" transformation requires a minimum of "+this.pointCountMinimum+" points, but "+this.pointCount+" are given.")}evaluate(e,t="function"){if("function"==t)return this.evaluateFunction(e);if("partialDerivativeX"==t)return this.evaluatePartialDerivativeX(e);if("partialDerivativeY"==t)return this.evaluatePartialDerivativeY(e);throw Error("Evaluation of type "+t+" not supported")}}class or extends ot{helmertParametersMatrix;helmertParameters;scale;rotation;translation;constructor(e,t){super(e,t,"helmert",2);let r=i9.columnVector(t.flat()),i=i9.zeros(2*this.pointCount,4);for(let e=0;e<this.pointCount;e++)i.set(2*e,0,1),i.set(2*e,1,0),i.set(2*e,2,this.sourcePoints[e][0]),i.set(2*e,3,-this.sourcePoints[e][1]),i.set(2*e+1,0,0),i.set(2*e+1,1,1),i.set(2*e+1,2,this.sourcePoints[e][1]),i.set(2*e+1,3,this.sourcePoints[e][0]);let o=oe(i);this.helmertParametersMatrix=o.mmul(r),this.helmertParameters=this.helmertParametersMatrix.to1DArray(),this.scale=Math.sqrt(this.helmertParameters[2]**2+this.helmertParameters[3]**2),this.rotation=Math.atan2(this.helmertParameters[3],this.helmertParameters[2]),this.translation=[this.helmertParameters[0],this.helmertParameters[1]]}evaluateFunction(e){if(!this.helmertParameters)throw Error("Helmert parameters not computed");return[this.helmertParameters[0]+this.helmertParameters[2]*e[0]-this.helmertParameters[3]*e[1],this.helmertParameters[1]+this.helmertParameters[2]*e[1]+this.helmertParameters[3]*e[0]]}evaluatePartialDerivativeX(e){if(!this.helmertParameters)throw Error("Helmert parameters not computed");return[this.helmertParameters[2],this.helmertParameters[3]]}evaluatePartialDerivativeY(e){if(!this.helmertParameters)throw Error("Helmert parameters not computed");return[-this.helmertParameters[3],this.helmertParameters[2]]}}class oi extends ot{scale;sourcePointsCenter;destinationPointsCenter;translation;constructor(e,t){super(e,t,"straight",2);let r=new or(this.sourcePoints,this.destinationPoints);if(this.scale=r.scale,!this.scale)throw Error("Scale could not be computed");this.sourcePointsCenter=this.sourcePoints.reduce((e,t)=>[e[0]+t[0],e[1]+t[1]]).map(e=>e/this.pointCount),this.destinationPointsCenter=this.destinationPoints.reduce((e,t)=>[e[0]+t[0],e[1]+t[1]]).map(e=>e/this.pointCount);let i=this.scale;this.translation=this.destinationPointsCenter.map((e,t)=>e-this.sourcePointsCenter[t]*i)}evaluateFunction(e){if(!this.scale||!this.translation)throw Error("Straight parameters not computed");return[this.translation[0]+this.scale*e[0],this.translation[1]+this.scale*e[1]]}evaluatePartialDerivativeX(e){if(!this.scale||!this.translation)throw Error("Straight parameters not computed");return[this.scale,0]}evaluatePartialDerivativeY(e){if(!this.scale||!this.translation)throw Error("Straight parameters not computed");return[0,this.scale]}}class oo extends ot{polynomialParametersMatrices;polynomialParameters;order;pointCountMinimum;constructor(e,t,r){let i=((r=r||1)+1)*(r+2)/2;if(super(e,t,"polynomial"+r,i),this.order=r,this.pointCountMinimum=i,this.order<1||this.order>3)throw Error("Only polynomial transformations of order 1, 2 or 3 are supported");let o=[i9.columnVector(this.destinationPoints.map(e=>e[0])),i9.columnVector(this.destinationPoints.map(e=>e[1]))],s=i9.zeros(this.pointCount,this.pointCountMinimum);for(let e=0;e<this.pointCount;e++)switch(this.order){case 1:s.set(e,0,1),s.set(e,1,this.sourcePoints[e][0]),s.set(e,2,this.sourcePoints[e][1]);break;case 2:s.set(e,0,1),s.set(e,1,this.sourcePoints[e][0]),s.set(e,2,this.sourcePoints[e][1]),s.set(e,3,this.sourcePoints[e][0]**2),s.set(e,4,this.sourcePoints[e][1]**2),s.set(e,5,this.sourcePoints[e][0]*this.sourcePoints[e][1]);break;case 3:s.set(e,0,1),s.set(e,1,this.sourcePoints[e][0]),s.set(e,2,this.sourcePoints[e][1]),s.set(e,3,this.sourcePoints[e][0]**2),s.set(e,4,this.sourcePoints[e][1]**2),s.set(e,5,this.sourcePoints[e][0]*this.sourcePoints[e][1]),s.set(e,6,this.sourcePoints[e][0]**3),s.set(e,7,this.sourcePoints[e][1]**3),s.set(e,8,this.sourcePoints[e][0]**2*this.sourcePoints[e][1]),s.set(e,9,this.sourcePoints[e][0]*this.sourcePoints[e][1]**2)}let n=oe(s);this.polynomialParametersMatrices=[n.mmul(o[0]),n.mmul(o[1])],this.polynomialParameters=this.polynomialParametersMatrices.map(e=>e.to1DArray())}evaluateFunction(e){if(!this.polynomialParameters)throw Error("Polynomial parameters not computed");let t=[0,0];for(let r=0;r<2;r++)switch(this.order){case 1:t[r]+=this.polynomialParameters[r][0]+this.polynomialParameters[r][1]*e[0]+this.polynomialParameters[r][2]*e[1];break;case 2:t[r]+=this.polynomialParameters[r][0]+this.polynomialParameters[r][1]*e[0]+this.polynomialParameters[r][2]*e[1]+this.polynomialParameters[r][3]*e[0]**2+this.polynomialParameters[r][4]*e[1]**2+this.polynomialParameters[r][5]*e[0]*e[1];break;case 3:t[r]+=this.polynomialParameters[r][0]+this.polynomialParameters[r][1]*e[0]+this.polynomialParameters[r][2]*e[1]+this.polynomialParameters[r][3]*e[0]**2+this.polynomialParameters[r][4]*e[1]**2+this.polynomialParameters[r][5]*e[0]*e[1]+this.polynomialParameters[r][6]*e[0]**3+this.polynomialParameters[r][7]*e[1]**3+this.polynomialParameters[r][8]*e[0]**2*e[1]+this.polynomialParameters[r][9]*e[0]*e[1]**2}return t}evaluatePartialDerivativeX(e){if(!this.polynomialParameters)throw Error("Polynomial parameters not computed");let t=[0,0];for(let r=0;r<2;r++)switch(this.order){case 1:t[r]+=this.polynomialParameters[r][1];break;case 2:t[r]+=this.polynomialParameters[r][1]+2*this.polynomialParameters[r][3]*e[0]+this.polynomialParameters[r][5]*e[1];break;case 3:t[r]+=this.polynomialParameters[r][1]+2*this.polynomialParameters[r][3]*e[0]+this.polynomialParameters[r][5]*e[1]+3*this.polynomialParameters[r][6]*e[0]**2+2*this.polynomialParameters[r][8]*e[0]*e[1]+this.polynomialParameters[r][9]*e[1]**2}return t}evaluatePartialDerivativeY(e){if(!this.polynomialParameters)throw Error("Polynomial parameters not computed");let t=[0,0];for(let r=0;r<2;r++)switch(this.order){case 1:t[r]+=this.polynomialParameters[r][2];break;case 2:t[r]+=this.polynomialParameters[r][2]+2*this.polynomialParameters[r][4]*e[1]+this.polynomialParameters[r][5]*e[0];break;case 3:t[r]+=this.polynomialParameters[r][2]+2*this.polynomialParameters[r][4]*e[1]+this.polynomialParameters[r][5]*e[0]+3*this.polynomialParameters[r][7]*e[1]**2+this.polynomialParameters[r][8]*e[0]**2+2*this.polynomialParameters[r][9]*e[0]*e[1]}return t}}class os extends ot{projectiveParametersMatrix;projectiveParameters;constructor(e,t){super(e,t,"projective",4);let r=i9.zeros(2*this.pointCount,9);for(let i=0;i<this.pointCount;i++)r.set(2*i,0,-e[i][0]),r.set(2*i,1,-e[i][1]),r.set(2*i,2,-1),r.set(2*i,3,0),r.set(2*i,4,0),r.set(2*i,5,0),r.set(2*i,6,t[i][0]*e[i][0]),r.set(2*i,7,t[i][0]*e[i][1]),r.set(2*i,8,t[i][0]),r.set(2*i+1,0,0),r.set(2*i+1,1,0),r.set(2*i+1,2,0),r.set(2*i+1,3,-e[i][0]),r.set(2*i+1,4,-e[i][1]),r.set(2*i+1,5,-1),r.set(2*i+1,6,t[i][1]*e[i][0]),r.set(2*i+1,7,t[i][1]*e[i][1]),r.set(2*i+1,8,t[i][1]);let i=new i6(r);this.projectiveParametersMatrix=i9.from1DArray(3,3,i.rightSingularVectors.getColumn(8)).transpose(),this.projectiveParameters=this.projectiveParametersMatrix.to2DArray()}evaluateFunction(e){if(!this.projectiveParameters)throw Error("projective parameters not computed");let t=this.projectiveParameters[0][2]*e[0]+this.projectiveParameters[1][2]*e[1]+this.projectiveParameters[2][2];return[(this.projectiveParameters[0][0]*e[0]+this.projectiveParameters[1][0]*e[1]+this.projectiveParameters[2][0])/t,(this.projectiveParameters[0][1]*e[0]+this.projectiveParameters[1][1]*e[1]+this.projectiveParameters[2][1])/t]}evaluatePartialDerivativeX(e){if(!this.projectiveParameters)throw Error("projective parameters not computed");let t=this.projectiveParameters[0][2]*e[0]+this.projectiveParameters[1][2]*e[1]+this.projectiveParameters[2][2],r=this.projectiveParameters[0][0]*e[0]+this.projectiveParameters[1][0]*e[1]+this.projectiveParameters[2][0],i=this.projectiveParameters[0][1]*e[0]+this.projectiveParameters[1][1]*e[1]+this.projectiveParameters[2][1];return[(t*this.projectiveParameters[0][0]-this.projectiveParameters[0][2]*r)/t**2,(t*this.projectiveParameters[0][1]-this.projectiveParameters[0][2]*i)/t**2]}evaluatePartialDerivativeY(e){if(!this.projectiveParameters)throw Error("projective parameters not computed");let t=this.projectiveParameters[0][2]*e[0]+this.projectiveParameters[1][2]*e[1]+this.projectiveParameters[2][2],r=this.projectiveParameters[0][0]*e[0]+this.projectiveParameters[1][0]*e[1]+this.projectiveParameters[2][0],i=this.projectiveParameters[0][1]*e[0]+this.projectiveParameters[1][1]*e[1]+this.projectiveParameters[2][1];return[(t*this.projectiveParameters[1][0]-this.projectiveParameters[1][2]*r)/t**2,(t*this.projectiveParameters[1][1]-this.projectiveParameters[1][2]*i)/t**2]}}class on extends ot{kernelFunction;normFunction;weightsMatrices;rbfWeights;affineWeights;epsilon;constructor(e,t,r,i,o){super(e,t,"thinPlateSpline",3),this.kernelFunction=r,this.normFunction=i;let s=[i9.columnVector([...this.destinationPoints,[0,0],[0,0],[0,0]].map(e=>e[0])),i9.columnVector([...this.destinationPoints,[0,0],[0,0],[0,0]].map(e=>e[1]))],n=i9.zeros(this.pointCount,this.pointCount);for(let e=0;e<this.pointCount;e++)for(let t=0;t<this.pointCount;t++)n.set(e,t,i(this.sourcePoints[e],this.sourcePoints[t]));void 0===o&&(o=n.sum()/(Math.pow(this.pointCount,2)-this.pointCount)),this.epsilon=o;for(let e=0;e<this.pointCount;e++)for(let t=0;t<this.pointCount;t++)n.set(e,t,r(n.get(e,t),{epsilon:o}));let a=i9.zeros(this.pointCount,3),l=i9.zeros(this.pointCount+3,this.pointCount+3);for(let e=0;e<this.pointCount;e++)a.set(e,0,1),a.set(e,1,this.sourcePoints[e][0]),a.set(e,2,this.sourcePoints[e][1]);for(let e=0;e<this.pointCount+3;e++)for(let t=0;t<this.pointCount+3;t++)e<this.pointCount&&t<this.pointCount?l.set(e,t,n.get(e,t)):e>=this.pointCount&&t<this.pointCount?l.set(e,t,a.transpose().get(e-this.pointCount,t)):e<this.pointCount&&t>=this.pointCount&&l.set(e,t,a.get(e,t-this.pointCount));let h=i7(l);this.weightsMatrices=[h.mmul(s[0]),h.mmul(s[1])],this.rbfWeights=this.weightsMatrices.map(e=>e.selection([...Array(this.pointCount).keys()],[0]).to1DArray()),this.affineWeights=this.weightsMatrices.map(e=>e.selection([0,1,2].map(e=>e+this.pointCount),[0]).to1DArray())}evaluateFunction(e){if(!this.rbfWeights||!this.affineWeights)throw Error("Weights not computed");let t=this.sourcePoints.map(t=>this.normFunction(e,t)),r=[0,0];for(let i=0;i<2;i++)r[i]=t.reduce((e,t,r)=>e+this.kernelFunction(t,{epsilon:this.epsilon})*this.rbfWeights[i][r],0),r[i]+=this.affineWeights[i][0]+this.affineWeights[i][1]*e[0]+this.affineWeights[i][2]*e[1];return r}evaluatePartialDerivativeX(e){if(!this.rbfWeights||!this.affineWeights)throw Error("Weights not computed");let t=this.sourcePoints.map(t=>this.normFunction(e,t)),r=[0,0];for(let i=0;i<2;i++)r[i]=t.reduce((t,r,o)=>t+(0==r?0:this.kernelFunction(r,{derivative:1,epsilon:this.epsilon})*((e[0]-this.sourcePoints[o][0])/r)*this.rbfWeights[i][o]),0),r[i]+=this.affineWeights[i][1];return r}evaluatePartialDerivativeY(e){if(!this.rbfWeights||!this.affineWeights)throw Error("Weights not computed");let t=this.sourcePoints.map(t=>this.normFunction(e,t)),r=[0,0];for(let i=0;i<2;i++)r[i]=t.reduce((t,r,o)=>t+(0==r?0:this.kernelFunction(r,{derivative:1,epsilon:this.epsilon})*((e[1]-this.sourcePoints[o][1])/r)*this.rbfWeights[i][o]),0),r[i]+=this.affineWeights[i][2];return r}}function oa(e,t){if(!t.derivative)return 0===e?0:Math.pow(e,2)*Math.log(e);if(1==t.derivative)return 0===e?0:e+2*e*Math.log(e);throw Error("Derivate of order "+t.derivative+" not implemented")}function ol(e,t){let r=[t[0]-e[0],t[1]-e[1]];return Math.sqrt(r[0]**2+r[1]**2)}let oh={maxOffsetRatio:0,maxDepth:0,minOffsetDistance:1/0,minLineDistance:1/0,sourceMidPointFunction:R,destinationMidPointFunction:R,destinationDistanceFunction:C,returnDomain:"destination"};function ou(e,t,r){e=w(e);let i=el(oh,r);return of(op(e.map(e=>({source:e,destination:t(e)})),!1).map(e=>od(e,t,i,0)).flat(1),!0).map(e=>"destination"==i.returnDomain?e.destination:e.source)}function oc(e,t,r){e=x(e);let i=el(oh,r);return of(op(e.map(e=>({source:e,destination:t(e)})),!0).map(e=>od(e,t,i,0)).flat(1),!1).map(e=>"destination"==i.returnDomain?e.destination:e.source)}function od(e,t,r,i){if(i>=r.maxDepth||r.maxDepth<=0)return[e];let o=r.sourceMidPointFunction(e[0].source,e[1].source),s=r.destinationMidPointFunction(e[0].destination,e[1].destination),n=t(o),a=r.destinationDistanceFunction(e[0].destination,e[1].destination),l=r.destinationDistanceFunction(t(e[0].source),t(e[1].source)),h=r.destinationDistanceFunction(s,n);if(!(h/a>r.maxOffsetRatio)||!(h<r.minOffsetDistance)||!(l<r.minLineDistance))return[e];{let s={source:o,destination:n};return[od([e[0],s],t,r,i+1),od([s,e[1]],t,r,i+1)].flat(1)}}function op(e,t=!1){let r=e.length-!t,i=[];for(let t=0;t<r;t++)i.push([e[t],e[(t+1)%e.length]]);return i}function of(e,t=!1){let r=e.map(e=>e[0]);return t&&r.push(e[e.length-1][1]),r}let om={maxOffsetRatio:0,minOffsetDistance:1/0,minLineDistance:1/0,maxDepth:0,destinationIsGeographic:!1,sourceIsGeographic:!1,inputIsMultiGeometry:!1,differentHandedness:!1,evaluationType:"function",returnDomain:"normal"};function og(e){let t={maxOffsetRatio:e.maxOffsetRatio,minOffsetDistance:e.minOffsetDistance,minLineDistance:e.minLineDistance,maxDepth:e.maxDepth};return e.sourceIsGeographic&&(t.sourceMidPointFunction=(e,t)=>id(e,t).geometry.coordinates),e.destinationIsGeographic&&(t.destinationMidPointFunction=(e,t)=>id(e,t).geometry.coordinates,t.destinationDistanceFunction=ic),"inverse"==e.returnDomain&&(t.returnDomain="source"),t}function ov(e){let t={maxOffsetRatio:e.maxOffsetRatio,minOffsetDistance:e.minOffsetDistance,minLineDistance:e.minLineDistance,maxDepth:e.maxDepth};return e.destinationIsGeographic&&(t.sourceMidPointFunction=(e,t)=>id(e,t).geometry.coordinates),e.sourceIsGeographic&&(t.destinationMidPointFunction=(e,t)=>id(e,t).geometry.coordinates,t.destinationDistanceFunction=ic),"inverse"==e.returnDomain&&(t.returnDomain="source"),t}function oy(e,t,r){return ou(e,e=>t.transformForward(e),og(r))}function ow(e,t,r){return ou(e,e=>t.transformBackward(e),ov(r))}function ox(e,t,r){return e.map(e=>oc(e,e=>t.transformForward(e),og(r)))}function o_(e,t,r){return e.map(e=>oc(e,e=>t.transformBackward(e),ov(r)))}class ob{gcps;sourcePoints;destinationPoints;type;options;forwardTransformation;backwardTransformation;constructor(e,t="polynomial",r){if(this.options=el(om,r),0===e.length)throw Error("No control points");this.gcps=e.map(e=>{if("resource"in e&&"geo"in e)return{source:e.resource,destination:e.geo};if("source"in e&&"destination"in e)return e;throw Error("Unsupported GCP type")}),this.sourcePoints=this.gcps.map(e=>e.source),this.destinationPoints=this.gcps.map(e=>e.destination),this.type=t}createForwardTransformation(){this.forwardTransformation=this.computeTransformation(this.sourcePoints.map(e=>this.assureEqualHandedness(e)),this.destinationPoints)}createBackwardTransformation(){this.backwardTransformation=this.computeTransformation(this.destinationPoints,this.sourcePoints.map(e=>this.assureEqualHandedness(e)))}transformForward(e,t){let r=el(this.options,t);if(!r.inputIsMultiGeometry){if(d(e))return this.forwardTransformation||this.createForwardTransformation(),this.forwardTransformation.evaluate(this.assureEqualHandedness(e),r.evaluationType);if(L(e))return this.transformForward(G(e),r);if(p(e))return oy(e,this,r);if(j(e))return oy(N(e),this,el(r,{sourceIsGeographic:!0}));if(m(e))return ox(e,this,r);if(k(e))return ox(z(e),this,el(r,{sourceIsGeographic:!0}))}if(t&&(t.inputIsMultiGeometry=!1),g(e))return e.map(e=>this.transformForward(e,t));if(F(e))return B(e).map(e=>this.transformForward(e,t));if(v(e))return e.map(e=>this.transformForward(e,t));if(O(e))return U(e).map(e=>this.transformForward(e,t));if(y(e))return e.map(e=>this.transformForward(e,t));if(D(e))return V(e).map(e=>this.transformForward(e,t));throw Error("Input type not supported")}transformForwardAsGeojson(e,t){let r=el(this.options,t);if(!r.inputIsMultiGeometry){if(d(e))return b(this.transformForward(e));if(L(e))return b(this.transformForward(G(e)));if(p(e))return M(oy(e,this,el(r,{destinationIsGeographic:!0})));if(j(e))return M(oy(N(e),this,el(r,{sourceIsGeographic:!0,destinationIsGeographic:!0})));if(m(e))return T(ox(e,this,el(r,{destinationIsGeographic:!0})));if(k(e))return T(ox(z(e),this,el(r,{sourceIsGeographic:!0,destinationIsGeographic:!0})))}if(t&&(t.inputIsMultiGeometry=!1),g(e))return W(e.map(e=>this.transformForwardAsGeojson(e,t)));if(F(e))return W(B(e).map(e=>this.transformForwardAsGeojson(e,t)));if(v(e))return Z(e.map(e=>this.transformForwardAsGeojson(e,t)));if(O(e))return Z(U(e).map(e=>this.transformForwardAsGeojson(e,t)));if(y(e))return q(e.map(e=>this.transformForwardAsGeojson(e,t)));if(D(e))return q(V(e).map(e=>this.transformForwardAsGeojson(e,t)));throw Error("Input type not supported")}transformBackward(e,t){let r=el(this.options,t);if(!r.inputIsMultiGeometry){if(d(e))return this.backwardTransformation||this.createBackwardTransformation(),this.assureEqualHandedness(this.backwardTransformation.evaluate(e));if(L(e))return this.transformBackward(G(e));if(p(e))return ow(e,this,r);if(j(e))return ow(N(e),this,el(r,{destinationIsGeographic:!0}));if(m(e))return o_(e,this,r);if(k(e))return o_(z(e),this,el(r,{destinationIsGeographic:!0}))}if(t&&(t.inputIsMultiGeometry=!1),g(e))return e.map(e=>this.transformBackward(e,t));if(F(e))return B(e).map(e=>this.transformBackward(e,t));if(v(e))return e.map(e=>this.transformBackward(e,t));if(O(e))return U(e).map(e=>this.transformBackward(e,t));if(y(e))return e.map(e=>this.transformBackward(e,t));if(D(e))return V(e).map(e=>this.transformBackward(e,t));throw Error("Input type not supported")}transformBackwardAsGeojson(e,t){let r=el(this.options,t);if(!r.inputIsMultiGeometry){if(d(e))return b(this.transformBackward(e));if(L(e))return b(this.transformBackward(G(e)));if(p(e))return M(ow(e,this,el(r,{sourceIsGeographic:!0})));if(j(e))return M(ow(N(e),this,el(r,{sourceIsGeographic:!0,destinationIsGeographic:!0})));if(m(e))return T(o_(e,this,el(r,{sourceIsGeographic:!0})));if(k(e))return T(o_(z(e),this,el(r,{sourceIsGeographic:!0,destinationIsGeographic:!0})))}if(t&&(t.inputIsMultiGeometry=!1),g(e))return W(e.map(e=>this.transformBackwardAsGeojson(e,t)));if(F(e))return W(B(e).map(e=>this.transformBackwardAsGeojson(e,t)));if(v(e))return Z(e.map(e=>this.transformBackwardAsGeojson(e,t)));if(O(e))return Z(U(e).map(e=>this.transformBackwardAsGeojson(e,t)));if(y(e))return q(e.map(e=>this.transformBackwardAsGeojson(e,t)));if(D(e))return q(V(e).map(e=>this.transformBackwardAsGeojson(e,t)));throw Error("Input type not supported")}transformToGeo(e,t){if(!el(this.options,t).inputIsMultiGeometry&&(d(e)||L(e)||p(e)||j(e)||m(e)||k(e))||(t&&(t.inputIsMultiGeometry=!1),g(e)||F(e)||v(e)||O(e)||y(e)||D(e)))return this.transformForward(e,t);throw Error("Input type not supported")}transformToGeoAsGeojson(e,t){if(!el(this.options,t).inputIsMultiGeometry&&(d(e)||L(e)||p(e)||j(e)||m(e)||k(e))||(t&&(t.inputIsMultiGeometry=!1),g(e)||F(e)||v(e)||O(e)||y(e)||D(e)))return this.transformForwardAsGeojson(e,t);throw Error("Input type not supported")}transformToResource(e,t){if(!el(this.options,t).inputIsMultiGeometry&&(d(e)||L(e)||p(e)||j(e)||m(e)||k(e))||(t&&(t.inputIsMultiGeometry=!1),g(e)||F(e)||v(e)||O(e)||y(e)||D(e)))return this.transformBackward(e,t);throw Error("Input type not supported")}transformToResourceAsGeojson(e,t){if(!el(this.options,t).inputIsMultiGeometry&&(d(e)||L(e)||p(e)||j(e)||m(e)||k(e))||(t&&(t.inputIsMultiGeometry=!1),g(e)||F(e)||v(e)||O(e)||y(e)||D(e)))return this.transformBackwardAsGeojson(e,t);throw Error("Input type not supported")}transformSvgToGeojson(e,t){if("circle"===e.type)return this.transformForwardAsGeojson(e.coordinates);if("line"===e.type||"polyline"===e.type)return this.transformForwardAsGeojson(e.coordinates,t);if("rect"===e.type||"polygon"===e.type)return this.transformForwardAsGeojson([e.coordinates],t);throw Error("Unsupported SVG geometry")}transformSvgStringToGeojsonFeatureCollection(e,t){let r=[];for(let i of function*(e){for(let t of function* e(t){if("children"in t)for(let r of t.children)"string"!=typeof r&&(yield*e(r));yield t}(function(e){var t="",r=[],i=a,o=null,s=null;function n(t){var r,i,o,s,n,a,l,h,u,c=(r=m,(o=void 0,s=(o={}).offsetLine||0,n=o.offsetColumn||0,a=e.split(`
`),l=0,h=a.map(function(e,t){var r=l+e.length+1,i={start:l,end:r,line:t};return l=r,i}),u=0,function(t,r){"string"==typeof t&&(t=e.indexOf(t,r||0));for(var i,o,a,l,c=h[u],d=t>=c.end?1:-1;c;){if(i=c,o=t,i.start<=o&&o<i.end)return a=c,l=t,{line:s+a.line,column:n+l-a.start,character:l};u+=d,c=h[u]}})(r,i)),d=c.line,p=c.column,f=e.slice(0,m),g=/(^|\n).*$/.exec(f)[0].replace(/\t/g,"  "),v=e.slice(m);throw Error(t+" ("+d+":"+p+`). If this is valid SVG, it's probably a bug in svg-parser. Please raise an issue at https://github.com/Rich-Harris/svg-parser/issues – thanks!

`+(""+g+/.*(\n|$)/.exec(v)[0]+`
`+function(e,t){for(var r="";t--;)r+=" ";return r}(0,g.length))+"^")}function a(){for(;m<e.length&&"<"!==e[m]||!em.test(e[m+1]);)t+=e[m++];return l()}function l(){for(var t="";m<e.length&&"<"!==e[m];)t+=e[m++];return/\S/.test(t)&&o.children.push({type:"text",value:t}),"<"===e[m]?h:l}function h(){var t,i=e[m];if("?"===i)return l;if("!"===i){if("--"===e.slice(m+1,m+3))return u;if("[CDATA["===e.slice(m+1,m+8))return c;if(/doctype/i.test(e.slice(m+1,m+8)))return l}if("/"===i)return d;var a={type:"element",tagName:p(),properties:{},children:[]};for(o?o.children.push(a):s=a;m<e.length&&(t=function(){if(!eg.test(e[m]))return null;f();var t=p();if(!t)return null;var r=!0;return f(),"="===e[m]&&(m+=1,f(),isNaN(r=ev.test(e[m])?function(){for(var t=e[m++],r="",i=!1;m<e.length;){var o=e[m++];if(o===t&&!i)return r;"\\"!==o||i||(i=!0),r+=i?"\\"+o:o,i=!1}}():function(){var t="";do{var r=e[m];if(" "===r||">"===r||"/"===r)break;t+=r,m+=1}while(m<e.length);return t}())||""===r.trim()||(r*=1)),{name:t,value:r}}());)a.properties[t.name]=t.value;var h=!1;return"/"===e[m]&&(m+=1,h=!0),">"!==e[m]&&n("Expected >"),h||(o=a,r.push(a)),l}function u(){var t=e.indexOf("--\x3e",m);return~t||n("expected --\x3e"),m=t+2,l}function c(){var t=e.indexOf("]]>",m);return~t||n("expected ]]>"),o.children.push(e.slice(m+7,t)),m=t+2,l}function d(){var t=p();return t||n("Expected tag name"),t!==o.tagName&&n("Expected closing tag </"+t+"> to match opening tag <"+o.tagName+">"),f(),">"!==e[m]&&n("Expected >"),r.pop(),o=r[r.length-1],l}function p(){for(var t="";m<e.length&&em.test(e[m]);)t+=e[m++];return t}function f(){for(;m<e.length&&eg.test(e[m]);)m+=1}for(var m=a.length;m<e.length;)i||n("Unexpected character"),i=i(),m+=1;return i!==l&&n("Unexpected end of input"),"svg"===s.tagName&&(s.metadata=t),{type:"root",children:[s]}}(e)))if("tagName"in t&&"svg"!==t.tagName&&"g"!==t.tagName){let e=function(e){let t=e?.tagName?.toLowerCase();if("circle"===t)return{type:"circle",coordinates:[ey(e,"cx"),ey(e,"cy")]};if("line"===t)return{type:"line",coordinates:[[ey(e,"x1"),ey(e,"y1")],[ey(e,"x2"),ey(e,"y2")]]};if("polyline"===t)return{type:"polyline",coordinates:ew(e)};if("polygon"===t)return{type:"polygon",coordinates:ew(e)};if("rect"===t)return{type:"rect",coordinates:[[ey(e,"x"),ey(e,"y")],[ey(e,"x")+ey(e,"width"),ey(e,"y")],[ey(e,"x")+ey(e,"width"),ey(e,"y")+ey(e,"height")],[ey(e,"x"),ey(e,"y")+ey(e,"height")],[ey(e,"x"),ey(e,"y")]]};throw Error(`Unsupported SVG element: ${t}`)}(t);e&&(yield e)}}(e)){let e=this.transformSvgToGeojson(i,t);r.push(e)}return{type:"FeatureCollection",features:r.map((e,t)=>({type:"Feature",properties:{},geometry:e}))}}transformGeojsonToSvg(e,t){if("Point"===e.type)return{type:"circle",coordinates:this.transformBackward(e)};if("LineString"===e.type)return{type:"polyline",coordinates:this.transformBackward(e,t)};if("Polygon"===e.type)return{type:"polygon",coordinates:this.transformBackward(e,t)[0]};throw Error("Unsupported GeoJSON geometry")}transformGeojsonFeatureCollectionToSvgString(e,t){let r=[];for(let i of e.features.map($)){let e=this.transformGeojsonToSvg(i,t);r.push(e)}return`<svg xmlns="http://www.w3.org/2000/svg">
  ${r.map(e_).join(`
`)}
</svg>`}assureEqualHandedness(e){return this.options?.differentHandedness?[e[0],-e[1]]:e}computeTransformation(e,t){if("straight"===this.type)return new oi(e,t);if("helmert"===this.type)return new or(e,t);if("polynomial1"===this.type||"polynomial"===this.type)return new oo(e,t);if("polynomial2"===this.type)return new oo(e,t,2);if("polynomial3"===this.type)return new oo(e,t,3);if("projective"===this.type)return new os(e,t);if("thinPlateSpline"===this.type)return new on(e,t,oa,ol);throw Error(`Unsupported transformation type: ${this.type}`)}}let oM=["log2sigma","twoOmega","airyKavr","signDetJ","thetaa"];var oT=(e=>(e.GEOREFERENCEANNOTATIONADDED="georeferenceannotationadded",e.GEOREFERENCEANNOTATIONREMOVED="georeferenceannotationremoved",e.WARPEDMAPADDED="warpedmapadded",e.WARPEDMAPREMOVED="warpedmapremoved",e.WARPEDMAPENTER="warpedmapenter",e.WARPEDMAPLEAVE="warpedmapleave",e.IMAGEINFOLOADED="imageinfoloaded",e.TILEFETCHED="tilefetched",e.TILEFETCHERROR="tilefetcherror",e.MAPTILELOADED="maptileloaded",e.MAPTILEREMOVED="maptileremoved",e.FIRSTMAPTILELOADED="firstmaptileloaded",e.ALLREQUESTEDTILESLOADED="allrequestedtilesloaded",e.TEXTURESUPDATED="texturesupdated",e.PRECHANGE="prechange",e.ZINDICESCHANGED="zindiceschanged",e.RESOURCEMASKUPDATED="resourcemaskupdated",e.VISIBILITYCHANGED="visibilitychanged",e.TRANSFORMATIONCHANGED="transformationchanged",e.DISTORTIONCHANGED="distortionchanged",e.CHANGED="changed",e.CLEARED="cleared",e))(oT||{});let oE=class extends Event{data;constructor(e,t){super(e),this.data=t}},oP={maxOffsetRatio:.05,maxDepth:2,differentHandedness:!0},oS=class extends EventTarget{mapId;georeferencedMap;gcps;projectedGcps;projectedGeoPoints;projectedGeoPreviousTransformedResourcePoints;projectedGeoTransformedResourcePoints;resourcePreviousLongerMask;resourcePreviousMask;resourceLongerMask;resourceMask;resourceMaskBbox;resourceMaskRectangle;resourceFullMask;resourceFullMaskBbox;resourceFullMaskRectangle;imageInformations;imageId;parsedImage;loadingImageInfo;fetchFn;abortController;visible;transformationType;transformer;projectedPreviousTransformer;projectedTransformer;transformerByTransformationType=new Map;projectedTransformerByTransformationType=new Map;geoMask;geoMaskBbox;geoMaskRectangle;geoFullMask;geoFullMaskBbox;geoFullMaskRectangle;projectedGeoPreviousLongerMask;projectedGeoLongerMask;projectedGeoMask;projectedGeoMaskBbox;projectedGeoMaskRectangle;projectedGeoFullMask;projectedGeoFullMaskBbox;projectedGeoFullMaskRectangle;resourceToProjectedGeoScale;distortionMeasure;currentBestScaleFactor;currentTileZoomLevel;currentOverviewTileZoomLevel;currentResourceViewportRing=[];currentResourceViewportRingBbox;currentFetchableTiles=[];currentOverviewFetchableTiles=[];constructor(e,t,r){super(),r={visible:!0,...r},this.mapId=e,this.georeferencedMap=t,this.gcps=this.georeferencedMap.gcps,this.projectedGcps=this.gcps.map(({resource:e,geo:t})=>({resource:e,geo:eM(t)})),this.projectedGeoPoints=this.projectedGcps.map(e=>e.geo),this.resourceMask=this.georeferencedMap.resourceMask,this.updateResourceMaskProperties(),this.resourceFullMask=[[0,0],[this.georeferencedMap.resource.width,0],[this.georeferencedMap.resource.width,this.georeferencedMap.resource.height],[0,this.georeferencedMap.resource.height]],this.resourceFullMaskBbox=H(this.resourceFullMask),this.resourceFullMaskRectangle=J(this.resourceFullMaskBbox),this.imageInformations=r.imageInformations,this.loadingImageInfo=!1,this.visible=r.visible||!0,this.fetchFn=r.fetchFn,this.transformationType=r.transformation?.type||this.georeferencedMap.transformation?.type||"polynomial",this.updateTransformerProperties()}getViewportMask(e){return this.projectedGeoMask.map(t=>o(e.projectedGeoToViewportTransform,t))}getViewportMaskBbox(e){return H(this.getViewportMask(e))}getViewportMaskRectangle(e){return this.projectedGeoMaskRectangle.map(t=>o(e.projectedGeoToViewportTransform,t))}getViewportFullMask(e){return this.projectedGeoFullMask.map(t=>o(e.projectedGeoToViewportTransform,t))}getViewportFullMaskBbox(e){return H(this.getViewportFullMask(e))}getViewportFullMaskRectangle(e){return this.projectedGeoFullMaskRectangle.map(t=>o(e.projectedGeoToViewportTransform,t))}getResourceToViewportScale(e){var t,r;return t=this.resourceMaskRectangle,r=this.getViewportMaskRectangle(e),ei(er(t),er(r))}getResourceToCanvasScale(e){return this.getResourceToViewportScale(e)/e.devicePixelRatio}getReferenceScale(){let e=eo(this.projectedTransformerByTransformationType,"helmert",()=>new ob(this.projectedGcps,"helmert",oP));return e.forwardTransformation||e.createForwardTransformation(),e.forwardTransformation.scale}setResourceMask(e){this.resourceMask=e,this.updateResourceMaskProperties(),this.updateGeoMask(),this.updateProjectedGeoMask(),this.updateResourceToProjectedGeoScale()}setTransformationType(e){this.transformationType=e,this.updateTransformerProperties()}setDistortionMeasure(e){this.distortionMeasure=e,this.updateDistortionProperties()}setGcps(e){this.gcps=e,this.updateTransformerProperties(!1)}setCurrentBestScaleFactor(e){let t=this.currentBestScaleFactor!=e;return t&&(this.currentBestScaleFactor=e),t}setCurrentTileZoomLevel(e){this.currentTileZoomLevel=e}setCurrentOverviewTileZoomLevel(e){this.currentOverviewTileZoomLevel=e}setCurrentResourceViewportRing(e){this.currentResourceViewportRing=e,this.currentResourceViewportRingBbox=e?H(e):void 0}setCurrentFetchableTiles(e){this.currentFetchableTiles=e}setCurrentOverviewFetchableTiles(e){this.currentOverviewFetchableTiles=e}resetCurrent(){this.setCurrentTileZoomLevel(),this.setCurrentOverviewTileZoomLevel(),this.setCurrentResourceViewportRing(),this.setCurrentFetchableTiles([]),this.setCurrentOverviewFetchableTiles([])}resetPrevious(){this.projectedPreviousTransformer=this.projectedTransformer,this.projectedGeoPreviousTransformedResourcePoints=this.projectedGeoTransformedResourcePoints,this.resourcePreviousMask=this.resourceMask,this.resourcePreviousLongerMask=this.resourceLongerMask,this.projectedGeoPreviousLongerMask=this.projectedGeoLongerMask}mixPreviousAndNew(e){this.projectedGeoPreviousTransformedResourcePoints=this.projectedGeoTransformedResourcePoints.map((t,r)=>I(t,this.projectedGeoPreviousTransformedResourcePoints[r],e)),this.projectedGeoPreviousLongerMask=this.projectedGeoLongerMask.map((t,r)=>I(t,this.projectedGeoPreviousLongerMask[r],e))}hasImageInfo(){return void 0!==this.imageId&&void 0!==this.parsedImage}async loadImageInfo(){try{let e;this.loadingImageInfo=!0;let t=this.georeferencedMap.resource.id;if(this.imageInformations?.get(t))e=this.imageInformations.get(t);else{this.abortController=new AbortController;let r=this.abortController.signal;e=await u(t,{signal:r},this.fetchFn),this.abortController=void 0,this.imageInformations?.set(t,e)}this.parsedImage=ii.parse(e),this.imageId=await eS(t),this.dispatchEvent(new oE(oT.IMAGEINFOLOADED))}catch(e){throw this.loadingImageInfo=!1,e}finally{this.loadingImageInfo=!1}}updateResourceMaskProperties(){this.resourceMaskBbox=H(this.resourceMask),this.resourceMaskRectangle=J(this.resourceMaskBbox),this.resourcePreviousMask||(this.resourcePreviousMask=this.resourceMask)}updateTransformerProperties(e=!0){this.updateTransformer(e),this.updateProjectedTransformer(e),this.updateProjectedGeoTransformedResourcePoints(),this.updateGeoMask(),this.updateFullGeoMask(),this.updateProjectedGeoMask(),this.updateProjectedFullGeoMask(),this.updateResourceToProjectedGeoScale()}updateTransformer(e=!0){this.transformer=eo(this.transformerByTransformationType,this.transformationType,()=>new ob(this.gcps,this.transformationType,oP),e)}updateProjectedTransformer(e=!0){this.projectedTransformer=eo(this.projectedTransformerByTransformationType,this.transformationType,()=>new ob(this.projectedGcps,this.transformationType,oP),e),this.projectedPreviousTransformer||(this.projectedPreviousTransformer=this.projectedTransformer)}updateProjectedGeoTransformedResourcePoints(){this.projectedGeoTransformedResourcePoints=this.gcps.map(e=>this.projectedTransformer.transformForward(e.resource)),this.projectedGeoPreviousTransformedResourcePoints||(this.projectedGeoPreviousTransformedResourcePoints=this.projectedGeoTransformedResourcePoints)}updateGeoMask(){this.geoMask=this.transformer.transformForwardAsGeojson([this.resourceMask]),this.geoMaskBbox=H(this.geoMask),this.geoMaskRectangle=this.transformer.transformForward([this.resourceMaskRectangle],{maxDepth:0})[0]}updateFullGeoMask(){this.geoFullMask=this.transformer.transformForwardAsGeojson([this.resourceFullMask]),this.geoFullMaskBbox=H(this.geoFullMask),this.geoFullMaskRectangle=this.transformer.transformForward([this.resourceFullMaskRectangle],{maxDepth:0})[0]}updateProjectedGeoMask(){this.projectedGeoMask=this.projectedTransformer.transformForward([this.resourceMask])[0],this.projectedGeoMaskBbox=H(this.projectedGeoMask),this.projectedGeoMaskRectangle=this.projectedTransformer.transformForward([this.resourceMaskRectangle],{maxDepth:0})[0],this.resourceLongerMask=this.projectedTransformer.transformForward([this.resourceMask],{returnDomain:"inverse"})[0],this.resourcePreviousLongerMask||(this.resourcePreviousLongerMask=this.resourceLongerMask);let e=this.resourceLongerMask.length<this.resourcePreviousLongerMask.length,t=this.resourceLongerMask.length>this.resourcePreviousLongerMask.length;e&&(this.resourceLongerMask=this.resourcePreviousLongerMask),this.projectedGeoLongerMask=this.projectedTransformer.transformForward(this.resourceLongerMask,{inputIsMultiGeometry:!0}),(!this.projectedGeoPreviousLongerMask||t)&&(this.projectedGeoPreviousLongerMask=this.projectedPreviousTransformer.transformForward(this.resourceLongerMask,{inputIsMultiGeometry:!0}))}updateProjectedFullGeoMask(){this.projectedGeoFullMask=this.projectedTransformer.transformForward([this.resourceFullMask])[0],this.projectedGeoFullMaskBbox=H(this.projectedGeoFullMask),this.projectedGeoFullMaskRectangle=this.projectedTransformer.transformForward([this.resourceFullMaskRectangle],{maxDepth:0})[0]}updateResourceToProjectedGeoScale(){var e,t;this.resourceToProjectedGeoScale=(e=this.resourceMaskRectangle,t=this.projectedGeoMaskRectangle,ei(er(e),er(t)))}updateDistortionProperties(){}destroy(){this.abortController&&this.abortController.abort()}};var oR={exports:{}};function oI(e,t,r){var i=e*t,o=0x8000001*e,s=o-(o-e),n=e-s,a=0x8000001*t,l=a-(a-t),h=t-l,u=n*h-(i-s*l-n*l-s*h);return r?(r[0]=u,r[1]=i,r):[u,i]}function oC(e,t){var r=0|e.length,i=0|t.length;if(1===r&&1===i)return a=(n=(o=e[0])+(s=t[0]))-o,(l=o-(n-a)+(s-a))?[l,n]:[n];var o,s,n,a,l,h,u,c=Array(r+i),d=0,p=0,f=0,m=Math.abs,g=e[0],v=m(g),y=t[f],w=m(y);v<w?(u=g,(p+=1)<r&&(v=m(g=e[p]))):(u=y,(f+=1)<i&&(w=m(y=t[f]))),p<r&&v<w||f>=i?(h=g,(p+=1)<r&&(v=m(g=e[p]))):(h=y,(f+=1)<i&&(w=m(y=t[f])));for(var x,_,b,M,T,E=h+u,P=E-h,S=u-P,R=S,I=E;p<r&&f<i;)v<w?(h=g,(p+=1)<r&&(v=m(g=e[p]))):(h=y,(f+=1)<i&&(w=m(y=t[f]))),P=(E=h+(u=R))-h,(S=u-P)&&(c[d++]=S),_=(x=I+E)-I,R=I-(b=x-_)+(M=E-_),I=x;for(;p<r;)P=(E=(h=g)+(u=R))-h,(S=u-P)&&(c[d++]=S),_=(x=I+E)-I,R=I-(b=x-_)+(M=E-_),I=x,(p+=1)<r&&(g=e[p]);for(;f<i;)P=(E=(h=y)+(u=R))-h,(S=u-P)&&(c[d++]=S),_=(x=I+E)-I,R=I-(b=x-_)+(M=E-_),I=x,(f+=1)<i&&(y=t[f]);return R&&(c[d++]=R),I&&(c[d++]=I),d||(c[d++]=0),c.length=d,c}var oA=function(e,t,r){var i=e+t,o=i-e,s=t-o,n=e-(i-o);return r?(r[0]=n+s,r[1]=i,r):[n+s,i]};function oL(e,t){var r=e.length;if(1===r){var i=oI(e[0],t);return i[0]?i:[i[1]]}var o=Array(2*r),s=[.1,.1],n=[.1,.1],a=0;oI(e[0],t,s),s[0]&&(o[a++]=s[0]);for(var l=1;l<r;++l){oI(e[l],t,n),oA(s[1],n[0],s),s[0]&&(o[a++]=s[0]);var h=n[1],u=s[1],c=h+u,d=u-(c-h);s[1]=c,d&&(o[a++]=d)}return s[1]&&(o[a++]=s[1]),0===a&&(o[a++]=0),o.length=a,o}function oj(e,t){var r=0|e.length,i=0|t.length;if(1===r&&1===i)return a=(n=(o=e[0])+(s=-t[0]))-o,(l=o-(n-a)+(s-a))?[l,n]:[n];var o,s,n,a,l,h,u,c=Array(r+i),d=0,p=0,f=0,m=Math.abs,g=e[0],v=m(g),y=-t[f],w=m(y);v<w?(u=g,(p+=1)<r&&(v=m(g=e[p]))):(u=y,(f+=1)<i&&(w=m(y=-t[f]))),p<r&&v<w||f>=i?(h=g,(p+=1)<r&&(v=m(g=e[p]))):(h=y,(f+=1)<i&&(w=m(y=-t[f])));for(var x,_,b,M,T,E=h+u,P=E-h,S=u-P,R=S,I=E;p<r&&f<i;)v<w?(h=g,(p+=1)<r&&(v=m(g=e[p]))):(h=y,(f+=1)<i&&(w=m(y=-t[f]))),P=(E=h+(u=R))-h,(S=u-P)&&(c[d++]=S),_=(x=I+E)-I,R=I-(b=x-_)+(M=E-_),I=x;for(;p<r;)P=(E=(h=g)+(u=R))-h,(S=u-P)&&(c[d++]=S),_=(x=I+E)-I,R=I-(b=x-_)+(M=E-_),I=x,(p+=1)<r&&(g=e[p]);for(;f<i;)P=(E=(h=y)+(u=R))-h,(S=u-P)&&(c[d++]=S),_=(x=I+E)-I,R=I-(b=x-_)+(M=E-_),I=x,(f+=1)<i&&(y=-t[f]);return R&&(c[d++]=R),I&&(c[d++]=I),d||(c[d++]=0),c.length=d,c}!function(e){var t=(3+17763568394002505e-31)*11102230246251565e-32,r=(7+6217248937900877e-30)*11102230246251565e-32;function i(e){return(3===e?function(e,t,r,i){return function(r,o,s){var n=i(e(e(t(o[1],s[0]),t(-s[1],o[0])),e(t(r[1],o[0]),t(-o[1],r[0]))),e(t(r[1],s[0]),t(-s[1],r[0])));return n[n.length-1]}}:4===e?function(e,t,r,i){return function(o,s,n,a){var l=i(e(e(r(e(t(n[1],a[0]),t(-a[1],n[0])),s[2]),e(r(e(t(s[1],a[0]),t(-a[1],s[0])),-n[2]),r(e(t(s[1],n[0]),t(-n[1],s[0])),a[2]))),e(r(e(t(s[1],a[0]),t(-a[1],s[0])),o[2]),e(r(e(t(o[1],a[0]),t(-a[1],o[0])),-s[2]),r(e(t(o[1],s[0]),t(-s[1],o[0])),a[2])))),e(e(r(e(t(n[1],a[0]),t(-a[1],n[0])),o[2]),e(r(e(t(o[1],a[0]),t(-a[1],o[0])),-n[2]),r(e(t(o[1],n[0]),t(-n[1],o[0])),a[2]))),e(r(e(t(s[1],n[0]),t(-n[1],s[0])),o[2]),e(r(e(t(o[1],n[0]),t(-n[1],o[0])),-s[2]),r(e(t(o[1],s[0]),t(-s[1],o[0])),n[2])))));return l[l.length-1]}}:function(e,t,r,i){return function(o,s,n,a,l){var h=i(e(e(e(r(e(r(e(t(a[1],l[0]),t(-l[1],a[0])),n[2]),e(r(e(t(n[1],l[0]),t(-l[1],n[0])),-a[2]),r(e(t(n[1],a[0]),t(-a[1],n[0])),l[2]))),s[3]),e(r(e(r(e(t(a[1],l[0]),t(-l[1],a[0])),s[2]),e(r(e(t(s[1],l[0]),t(-l[1],s[0])),-a[2]),r(e(t(s[1],a[0]),t(-a[1],s[0])),l[2]))),-n[3]),r(e(r(e(t(n[1],l[0]),t(-l[1],n[0])),s[2]),e(r(e(t(s[1],l[0]),t(-l[1],s[0])),-n[2]),r(e(t(s[1],n[0]),t(-n[1],s[0])),l[2]))),a[3]))),e(r(e(r(e(t(n[1],a[0]),t(-a[1],n[0])),s[2]),e(r(e(t(s[1],a[0]),t(-a[1],s[0])),-n[2]),r(e(t(s[1],n[0]),t(-n[1],s[0])),a[2]))),-l[3]),e(r(e(r(e(t(a[1],l[0]),t(-l[1],a[0])),s[2]),e(r(e(t(s[1],l[0]),t(-l[1],s[0])),-a[2]),r(e(t(s[1],a[0]),t(-a[1],s[0])),l[2]))),o[3]),r(e(r(e(t(a[1],l[0]),t(-l[1],a[0])),o[2]),e(r(e(t(o[1],l[0]),t(-l[1],o[0])),-a[2]),r(e(t(o[1],a[0]),t(-a[1],o[0])),l[2]))),-s[3])))),e(e(r(e(r(e(t(s[1],l[0]),t(-l[1],s[0])),o[2]),e(r(e(t(o[1],l[0]),t(-l[1],o[0])),-s[2]),r(e(t(o[1],s[0]),t(-s[1],o[0])),l[2]))),a[3]),e(r(e(r(e(t(s[1],a[0]),t(-a[1],s[0])),o[2]),e(r(e(t(o[1],a[0]),t(-a[1],o[0])),-s[2]),r(e(t(o[1],s[0]),t(-s[1],o[0])),a[2]))),-l[3]),r(e(r(e(t(n[1],a[0]),t(-a[1],n[0])),s[2]),e(r(e(t(s[1],a[0]),t(-a[1],s[0])),-n[2]),r(e(t(s[1],n[0]),t(-n[1],s[0])),a[2]))),o[3]))),e(r(e(r(e(t(n[1],a[0]),t(-a[1],n[0])),o[2]),e(r(e(t(o[1],a[0]),t(-a[1],o[0])),-n[2]),r(e(t(o[1],n[0]),t(-n[1],o[0])),a[2]))),-s[3]),e(r(e(r(e(t(s[1],a[0]),t(-a[1],s[0])),o[2]),e(r(e(t(o[1],a[0]),t(-a[1],o[0])),-s[2]),r(e(t(o[1],s[0]),t(-s[1],o[0])),a[2]))),n[3]),r(e(r(e(t(s[1],n[0]),t(-n[1],s[0])),o[2]),e(r(e(t(o[1],n[0]),t(-n[1],o[0])),-s[2]),r(e(t(o[1],s[0]),t(-s[1],o[0])),n[2]))),-a[3]))))),e(e(e(r(e(r(e(t(a[1],l[0]),t(-l[1],a[0])),n[2]),e(r(e(t(n[1],l[0]),t(-l[1],n[0])),-a[2]),r(e(t(n[1],a[0]),t(-a[1],n[0])),l[2]))),o[3]),r(e(r(e(t(a[1],l[0]),t(-l[1],a[0])),o[2]),e(r(e(t(o[1],l[0]),t(-l[1],o[0])),-a[2]),r(e(t(o[1],a[0]),t(-a[1],o[0])),l[2]))),-n[3])),e(r(e(r(e(t(n[1],l[0]),t(-l[1],n[0])),o[2]),e(r(e(t(o[1],l[0]),t(-l[1],o[0])),-n[2]),r(e(t(o[1],n[0]),t(-n[1],o[0])),l[2]))),a[3]),r(e(r(e(t(n[1],a[0]),t(-a[1],n[0])),o[2]),e(r(e(t(o[1],a[0]),t(-a[1],o[0])),-n[2]),r(e(t(o[1],n[0]),t(-n[1],o[0])),a[2]))),-l[3]))),e(e(r(e(r(e(t(n[1],l[0]),t(-l[1],n[0])),s[2]),e(r(e(t(s[1],l[0]),t(-l[1],s[0])),-n[2]),r(e(t(s[1],n[0]),t(-n[1],s[0])),l[2]))),o[3]),r(e(r(e(t(n[1],l[0]),t(-l[1],n[0])),o[2]),e(r(e(t(o[1],l[0]),t(-l[1],o[0])),-n[2]),r(e(t(o[1],n[0]),t(-n[1],o[0])),l[2]))),-s[3])),e(r(e(r(e(t(s[1],l[0]),t(-l[1],s[0])),o[2]),e(r(e(t(o[1],l[0]),t(-l[1],o[0])),-s[2]),r(e(t(o[1],s[0]),t(-s[1],o[0])),l[2]))),n[3]),r(e(r(e(t(s[1],n[0]),t(-n[1],s[0])),o[2]),e(r(e(t(o[1],n[0]),t(-n[1],o[0])),-s[2]),r(e(t(o[1],s[0]),t(-s[1],o[0])),n[2]))),-l[3])))));return h[h.length-1]}})(oC,oI,oL,oj)}for(var o=i(3),s=i(4),n=[function(){return 0},function(){return 0},function(e,t){return t[0]-e[0]},function(e,r,i){var s,n=(e[1]-i[1])*(r[0]-i[0]),a=(e[0]-i[0])*(r[1]-i[1]),l=n-a;if(n>0){if(a<=0)return l;s=n+a}else{if(!(n<0)||a>=0)return l;s=-(n+a)}var h=t*s;return l>=h||l<=-h?l:o(e,r,i)},function(e,t,i,o){var n=e[0]-o[0],a=t[0]-o[0],l=i[0]-o[0],h=e[1]-o[1],u=t[1]-o[1],c=i[1]-o[1],d=e[2]-o[2],p=t[2]-o[2],f=i[2]-o[2],m=a*c,g=l*u,v=l*h,y=n*c,w=n*u,x=a*h,_=d*(m-g)+p*(v-y)+f*(w-x),b=r*((Math.abs(m)+Math.abs(g))*Math.abs(d)+(Math.abs(v)+Math.abs(y))*Math.abs(p)+(Math.abs(w)+Math.abs(x))*Math.abs(f));return _>b||-_>b?_:s(e,t,i,o)}];n.length<=5;)n.push(i(n.length));e.exports=(function(e,t,r,i,o,s,n){return function(t,r,a,l,h){switch(arguments.length){case 0:case 1:return 0;case 2:return i(t,r);case 3:return o(t,r,a);case 4:return s(t,r,a,l);case 5:return n(t,r,a,l,h)}for(var u=Array(arguments.length),c=0;c<arguments.length;++c)u[c]=arguments[c];return e(u)}}).apply(void 0,[function(e){var t=n[e.length];return t||(t=n[e.length]=i(e.length)),t.apply(void 0,e)}].concat(n));for(var a=0;a<=5;++a)e.exports[a]=n[a]}(oR);var ok=oR.exports;let oF=function(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}(function(e,t){for(var r=t[0],i=t[1],o=e.length,s=1,n=o,a=0,l=o-1;a<n;l=a++){var h=e[a],u=e[l],c=h[1],d=u[1];if(d<c){if(d<i&&i<c){var p=ok(h,u,t);if(0===p)return 0;s^=0<p}else if(i===c){var f=e[(a+1)%o],m=f[1];if(c<m){var p=ok(h,u,t);if(0===p)return 0;s^=0<p}}}else if(c<d){if(c<i&&i<d){var p=ok(h,u,t);if(0===p)return 0;s^=p<0}else if(i===c){var f=e[(a+1)%o],m=f[1];if(m<c){var p=ok(h,u,t);if(0===p)return 0;s^=p<0}}}else if(i===c){var g=Math.min(h[0],u[0]),v=Math.max(h[0],u[0]);if(0===a){for(;l>0;){var y=(l+o-1)%o,w=e[y];if(w[1]!==i)break;var x=w[0];g=Math.min(g,x),v=Math.max(v,x),l=y}if(0===l)return g<=r&&r<=v?0:1;n=l+1}for(var _=e[(l+o-1)%o][1];a+1<n;){var w=e[a+1];if(w[1]!==i)break;var x=w[0];g=Math.min(g,x),v=Math.max(v,x),a+=1}if(g<=r&&r<=v)return 0;var b=e[(a+1)%o][1];r<g&&_<i!=b<i&&(s^=1)}}return 2*s-1});var oO={};let oD={version:"1.5.0"};function oG(e){return"("+e.x+";"+e.y+")"}var oN={toString:function(e){var t=e.toString();return"[object Object]"===t?oG(e):t},toStringBase:oG,compare:function(e,t){return e.y===t.y?e.x-t.x:e.y-t.y},equals:function(e,t){return e.x===t.x&&e.y===t.y}},oz=function(e,t){this.name="PointError",this.points=t=t||[],this.message=e||"Invalid Points!";for(var r=0;r<t.length;r++)this.message+=" "+oN.toString(t[r])};oz.prototype=Error(),oz.prototype.constructor=oz;var oB=function(e,t){this.x=+e||0,this.y=+t||0,this._p2t_edge_list=null};oB.prototype.toString=function(){return oN.toStringBase(this)},oB.prototype.toJSON=function(){return{x:this.x,y:this.y}},oB.prototype.clone=function(){return new oB(this.x,this.y)},oB.prototype.set_zero=function(){return this.x=0,this.y=0,this},oB.prototype.set=function(e,t){return this.x=+e||0,this.y=+t||0,this},oB.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this},oB.prototype.add=function(e){return this.x+=e.x,this.y+=e.y,this},oB.prototype.sub=function(e){return this.x-=e.x,this.y-=e.y,this},oB.prototype.mul=function(e){return this.x*=e,this.y*=e,this},oB.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},oB.prototype.normalize=function(){var e=this.length();return this.x/=e,this.y/=e,e},oB.prototype.equals=function(e){return this.x===e.x&&this.y===e.y},oB.negate=function(e){return new oB(-e.x,-e.y)},oB.add=function(e,t){return new oB(e.x+t.x,e.y+t.y)},oB.sub=function(e,t){return new oB(e.x-t.x,e.y-t.y)},oB.mul=function(e,t){return new oB(e*t.x,e*t.y)},oB.cross=function(e,t){return"number"==typeof e?"number"==typeof t?e*t:new oB(-e*t.y,e*t.x):"number"==typeof t?new oB(t*e.y,-t*e.x):e.x*t.y-e.y*t.x},oB.toString=oN.toString,oB.compare=oN.compare,oB.cmp=oN.compare,oB.equals=oN.equals,oB.dot=function(e,t){return e.x*t.x+e.y*t.y};var oU=function(e,t,r){this.points_=[e,t,r],this.neighbors_=[null,null,null],this.interior_=!1,this.constrained_edge=[!1,!1,!1],this.delaunay_edge=[!1,!1,!1]},oV=oN.toString;oU.prototype.toString=function(){return"["+oV(this.points_[0])+oV(this.points_[1])+oV(this.points_[2])+"]"},oU.prototype.getPoint=function(e){return this.points_[e]},oU.prototype.GetPoint=oU.prototype.getPoint,oU.prototype.getPoints=function(){return this.points_},oU.prototype.getNeighbor=function(e){return this.neighbors_[e]},oU.prototype.containsPoint=function(e){var t=this.points_;return e===t[0]||e===t[1]||e===t[2]},oU.prototype.containsEdge=function(e){return this.containsPoint(e.p)&&this.containsPoint(e.q)},oU.prototype.containsPoints=function(e,t){return this.containsPoint(e)&&this.containsPoint(t)},oU.prototype.isInterior=function(){return this.interior_},oU.prototype.setInterior=function(e){return this.interior_=e,this},oU.prototype.markNeighborPointers=function(e,t,r){var i=this.points_;if(e===i[2]&&t===i[1]||e===i[1]&&t===i[2])this.neighbors_[0]=r;else if(e===i[0]&&t===i[2]||e===i[2]&&t===i[0])this.neighbors_[1]=r;else if(e===i[0]&&t===i[1]||e===i[1]&&t===i[0])this.neighbors_[2]=r;else throw Error("poly2tri Invalid Triangle.markNeighborPointers() call")},oU.prototype.markNeighbor=function(e){var t=this.points_;e.containsPoints(t[1],t[2])?(this.neighbors_[0]=e,e.markNeighborPointers(t[1],t[2],this)):e.containsPoints(t[0],t[2])?(this.neighbors_[1]=e,e.markNeighborPointers(t[0],t[2],this)):e.containsPoints(t[0],t[1])&&(this.neighbors_[2]=e,e.markNeighborPointers(t[0],t[1],this))},oU.prototype.clearNeighbors=function(){this.neighbors_[0]=null,this.neighbors_[1]=null,this.neighbors_[2]=null},oU.prototype.clearDelaunayEdges=function(){this.delaunay_edge[0]=!1,this.delaunay_edge[1]=!1,this.delaunay_edge[2]=!1},oU.prototype.pointCW=function(e){var t=this.points_;return e===t[0]?t[2]:e===t[1]?t[0]:e===t[2]?t[1]:null},oU.prototype.pointCCW=function(e){var t=this.points_;return e===t[0]?t[1]:e===t[1]?t[2]:e===t[2]?t[0]:null},oU.prototype.neighborCW=function(e){return e===this.points_[0]?this.neighbors_[1]:e===this.points_[1]?this.neighbors_[2]:this.neighbors_[0]},oU.prototype.neighborCCW=function(e){return e===this.points_[0]?this.neighbors_[2]:e===this.points_[1]?this.neighbors_[0]:this.neighbors_[1]},oU.prototype.getConstrainedEdgeCW=function(e){return e===this.points_[0]?this.constrained_edge[1]:e===this.points_[1]?this.constrained_edge[2]:this.constrained_edge[0]},oU.prototype.getConstrainedEdgeCCW=function(e){return e===this.points_[0]?this.constrained_edge[2]:e===this.points_[1]?this.constrained_edge[0]:this.constrained_edge[1]},oU.prototype.getConstrainedEdgeAcross=function(e){return e===this.points_[0]?this.constrained_edge[0]:e===this.points_[1]?this.constrained_edge[1]:this.constrained_edge[2]},oU.prototype.setConstrainedEdgeCW=function(e,t){e===this.points_[0]?this.constrained_edge[1]=t:e===this.points_[1]?this.constrained_edge[2]=t:this.constrained_edge[0]=t},oU.prototype.setConstrainedEdgeCCW=function(e,t){e===this.points_[0]?this.constrained_edge[2]=t:e===this.points_[1]?this.constrained_edge[0]=t:this.constrained_edge[1]=t},oU.prototype.getDelaunayEdgeCW=function(e){return e===this.points_[0]?this.delaunay_edge[1]:e===this.points_[1]?this.delaunay_edge[2]:this.delaunay_edge[0]},oU.prototype.getDelaunayEdgeCCW=function(e){return e===this.points_[0]?this.delaunay_edge[2]:e===this.points_[1]?this.delaunay_edge[0]:this.delaunay_edge[1]},oU.prototype.setDelaunayEdgeCW=function(e,t){e===this.points_[0]?this.delaunay_edge[1]=t:e===this.points_[1]?this.delaunay_edge[2]=t:this.delaunay_edge[0]=t},oU.prototype.setDelaunayEdgeCCW=function(e,t){e===this.points_[0]?this.delaunay_edge[2]=t:e===this.points_[1]?this.delaunay_edge[0]=t:this.delaunay_edge[1]=t},oU.prototype.neighborAcross=function(e){return e===this.points_[0]?this.neighbors_[0]:e===this.points_[1]?this.neighbors_[1]:this.neighbors_[2]},oU.prototype.oppositePoint=function(e,t){var r=e.pointCW(t);return this.pointCW(r)},oU.prototype.legalize=function(e,t){var r=this.points_;if(e===r[0])r[1]=r[0],r[0]=r[2],r[2]=t;else if(e===r[1])r[2]=r[1],r[1]=r[0],r[0]=t;else if(e===r[2])r[0]=r[2],r[2]=r[1],r[1]=t;else throw Error("poly2tri Invalid Triangle.legalize() call")},oU.prototype.index=function(e){var t=this.points_;if(e===t[0])return 0;if(e===t[1])return 1;if(e===t[2])return 2;throw Error("poly2tri Invalid Triangle.index() call")},oU.prototype.edgeIndex=function(e,t){var r=this.points_;if(e===r[0]){if(t===r[1])return 2;if(t===r[2])return 1}else if(e===r[1]){if(t===r[2])return 0;if(t===r[0])return 2}else if(e===r[2]){if(t===r[0])return 1;if(t===r[1])return 0}return -1},oU.prototype.markConstrainedEdgeByIndex=function(e){this.constrained_edge[e]=!0},oU.prototype.markConstrainedEdgeByEdge=function(e){this.markConstrainedEdgeByPoints(e.p,e.q)},oU.prototype.markConstrainedEdgeByPoints=function(e,t){var r=this.points_;t===r[0]&&e===r[1]||t===r[1]&&e===r[0]?this.constrained_edge[2]=!0:t===r[0]&&e===r[2]||t===r[2]&&e===r[0]?this.constrained_edge[1]=!0:(t===r[1]&&e===r[2]||t===r[2]&&e===r[1])&&(this.constrained_edge[0]=!0)};var oW={},oZ={exports:{}},oq=function(e,t){this.head_=e,this.tail_=t,this.search_node_=e};oq.prototype.head=function(){return this.head_},oq.prototype.setHead=function(e){this.head_=e},oq.prototype.tail=function(){return this.tail_},oq.prototype.setTail=function(e){this.tail_=e},oq.prototype.search=function(){return this.search_node_},oq.prototype.setSearch=function(e){this.search_node_=e},oq.prototype.findSearchNode=function(){return this.search_node_},oq.prototype.locateNode=function(e){var t=this.search_node_;if(e<t.value){for(;t=t.prev;)if(e>=t.value)return this.search_node_=t,t}else for(;t=t.next;)if(e<t.value)return this.search_node_=t.prev,t.prev;return null},oq.prototype.locatePoint=function(e){var t=e.x,r=this.findSearchNode(t),i=r.point.x;if(t===i){if(e!==r.point)if(e===r.prev.point)r=r.prev;else if(e===r.next.point)r=r.next;else throw Error("poly2tri Invalid AdvancingFront.locatePoint() call")}else if(t<i)for(;(r=r.prev)&&e!==r.point;);else for(;(r=r.next)&&e!==r.point;);return r&&(this.search_node_=r),r},oZ.exports=oq,oZ.exports.Node=function(e,t){this.point=e,this.triangle=t||null,this.next=null,this.prev=null,this.value=e.x};var o$=oZ.exports,oX={};oX.EPSILON=1e-12;var oH={CW:1,CCW:-1,COLLINEAR:0};oX.Orientation=oH,oX.orient2d=function(e,t,r){var i=(e.x-r.x)*(t.y-r.y)-(e.y-r.y)*(t.x-r.x);return i>-1e-12&&i<1e-12?oH.COLLINEAR:i>0?oH.CCW:oH.CW},oX.inScanArea=function(e,t,r,i){return!((e.x-t.x)*(i.y-t.y)-(i.x-t.x)*(e.y-t.y)>=-1e-12)&&!((e.x-r.x)*(i.y-r.y)-(i.x-r.x)*(e.y-r.y)<=1e-12)},oX.isAngleObtuse=function(e,t,r){var i=t.x-e.x,o=t.y-e.y;return i*(r.x-e.x)+o*(r.y-e.y)<0};var oY=function(e,t){if(!e)throw Error(t||"Assert Failed")},oK=o$.Node,oJ=oX.EPSILON,oQ=oX.Orientation,o0=oX.orient2d,o1=oX.inScanArea,o2=oX.isAngleObtuse;function o3(e,t,r,i,o){if(!o4(i,t,r)){var s=i.pointCCW(o),n=o0(r,s,t);if(n===oQ.COLLINEAR)throw new oz("poly2tri EdgeEvent: Collinear not supported!",[r,s,t]);var a=i.pointCW(o),l=o0(r,a,t);if(l===oQ.COLLINEAR)throw new oz("poly2tri EdgeEvent: Collinear not supported!",[r,a,t]);n===l?o3(e,t,r,i=n===oQ.CW?i.neighborCCW(o):i.neighborCW(o),o):function e(t,r,i,o,s){var n,a,l,h,u,c,d,p=o.neighborAcross(s);oY(p,"FLIP failed due to missing triangle!");var f=p.oppositePoint(o,s);if(o.getConstrainedEdgeAcross(s)){var m=o.index(s);throw new oz("poly2tri Intersecting Constraints",[s,f,o.getPoint((m+1)%3),o.getPoint((m+2)%3)])}if(o1(s,o.pointCCW(s),o.pointCW(s),f)){(o6(o,s,p,f),t.mapTriangleToNodes(o),t.mapTriangleToNodes(p),s===i&&f===r)?i===t.edge_event.constrained_edge.q&&r===t.edge_event.constrained_edge.p&&(o.markConstrainedEdgeByPoints(r,i),p.markConstrainedEdgeByPoints(r,i),o9(t,o),o9(t,p)):(n=t,a=o0(i,f,r),l=o,h=p,u=s,c=f,e(t,r,i,o=a===oQ.CCW?(d=h.edgeIndex(u,c),h.delaunay_edge[d]=!0,o9(n,h),h.clearDelaunayEdges(),l):(d=l.edgeIndex(u,c),l.delaunay_edge[d]=!0,o9(n,l),l.clearDelaunayEdges(),h),s))}else{var g=se(r,i,p,f);(function t(r,i,o,s,n,a){var l=n.neighborAcross(a);oY(l,"FLIP failed due to missing triangle");var h=l.oppositePoint(n,a);if(o1(o,s.pointCCW(o),s.pointCW(o),h))e(r,o,h,l,h);else{var u=se(i,o,l,h);t(r,i,o,s,l,u)}})(t,r,i,o,p,g),o3(t,r,i,o,s)}}(e,t,r,i,o)}}function o4(e,t,r){var i=e.edgeIndex(t,r);if(-1!==i){e.markConstrainedEdgeByIndex(i);var o=e.getNeighbor(i);return o&&o.markConstrainedEdgeByPoints(t,r),!0}return!1}function o5(e,t){var r=new oU(t.prev.point,t.point,t.next.point);r.markNeighbor(t.prev.triangle),r.markNeighbor(t.triangle),e.addToMap(r),t.prev.next=t.next,t.next.prev=t.prev,o9(e,r)||e.mapTriangleToNodes(r)}function o9(e,t){for(var r=0;r<3;++r)if(!t.delaunay_edge[r]){var i=t.getNeighbor(r);if(i){var o=t.getPoint(r),s=i.oppositePoint(t,o),n=i.index(s);if(i.constrained_edge[n]||i.delaunay_edge[n]){t.constrained_edge[r]=i.constrained_edge[n];continue}if(function(e,t,r,i){var o=e.x-i.x,s=e.y-i.y,n=t.x-i.x,a=t.y-i.y,l=o*a-n*s;if(l<=0)return!1;var h=r.x-i.x,u=r.y-i.y,c=h*s-o*u;return!(c<=0)&&(o*o+s*s)*(n*u-h*a)+(n*n+a*a)*c+(h*h+u*u)*l>0}(o,t.pointCCW(o),t.pointCW(o),s)){t.delaunay_edge[r]=!0,i.delaunay_edge[n]=!0,o6(t,o,i,s);var a=!o9(e,t);return a&&e.mapTriangleToNodes(t),(a=!o9(e,i))&&e.mapTriangleToNodes(i),t.delaunay_edge[r]=!1,i.delaunay_edge[n]=!1,!0}}}return!1}function o6(e,t,r,i){var o,s,n,a,l,h,u,c,d,p,f,m;o=e.neighborCCW(t),s=e.neighborCW(t),n=r.neighborCCW(i),a=r.neighborCW(i),l=e.getConstrainedEdgeCCW(t),h=e.getConstrainedEdgeCW(t),u=r.getConstrainedEdgeCCW(i),c=r.getConstrainedEdgeCW(i),d=e.getDelaunayEdgeCCW(t),p=e.getDelaunayEdgeCW(t),f=r.getDelaunayEdgeCCW(i),m=r.getDelaunayEdgeCW(i),e.legalize(t,i),r.legalize(i,t),r.setDelaunayEdgeCCW(t,d),e.setDelaunayEdgeCW(t,p),e.setDelaunayEdgeCCW(i,f),r.setDelaunayEdgeCW(i,m),r.setConstrainedEdgeCCW(t,l),e.setConstrainedEdgeCW(t,h),e.setConstrainedEdgeCCW(i,u),r.setConstrainedEdgeCW(i,c),e.clearNeighbors(),r.clearNeighbors(),o&&r.markNeighbor(o),s&&e.markNeighbor(s),n&&e.markNeighbor(n),a&&r.markNeighbor(a),e.markNeighbor(r)}function o8(e,t,r){o5(e,r.next),r.next.point!==t.p&&o0(t.q,r.next.point,t.p)===oQ.CCW&&o0(r.point,r.next.point,r.next.next.point)===oQ.CCW&&o8(e,t,r)}function o7(e,t,r){o5(e,r.prev),r.prev.point!==t.p&&o0(t.q,r.prev.point,t.p)===oQ.CW&&o0(r.point,r.prev.point,r.prev.prev.point)===oQ.CW&&o7(e,t,r)}function se(e,t,r,i){var o=o0(t,i,e);if(o===oQ.CW)return r.pointCCW(i);if(o===oQ.CCW)return r.pointCW(i);throw new oz("poly2tri [Unsupported] nextFlipPoint: opposing point on constrained edge!",[t,i,e])}oW.triangulate=function(e){e.initTriangulation(),e.createAdvancingFront(),function(e){var t,r=e.pointCount();for(t=1;t<r;++t)for(var i=e.getPoint(t),o=function(e,t){var r=e.locateNode(t),i=function(e,t,r){var i=new oU(t,r.point,r.next.point);i.markNeighbor(r.triangle),e.addToMap(i);var o=new oK(t);return o.next=r.next,o.prev=r,r.next.prev=o,r.next=o,o9(e,i)||e.mapTriangleToNodes(i),o}(e,t,r);return t.x<=r.point.x+oJ&&o5(e,r),function(e,t){for(var r=t.next;r.next&&!o2(r.point,r.next.point,r.prev.point);)o5(e,r),r=r.next;for(r=t.prev;r.prev&&!o2(r.point,r.next.point,r.prev.point);)o5(e,r),r=r.prev;t.next&&t.next.next&&function(e){var t=e.point.x-e.next.next.point.x,r=e.point.y-e.next.next.point.y;return oY(r>=0,"unordered y"),t>=0||Math.abs(t)<r}(t)&&function(e,t){for(o0(t.point,t.next.point,t.next.next.point)===oQ.CCW?e.basin.left_node=t.next.next:e.basin.left_node=t.next,e.basin.bottom_node=e.basin.left_node;e.basin.bottom_node.next&&e.basin.bottom_node.point.y>=e.basin.bottom_node.next.point.y;)e.basin.bottom_node=e.basin.bottom_node.next;if(e.basin.bottom_node!==e.basin.left_node){for(e.basin.right_node=e.basin.bottom_node;e.basin.right_node.next&&e.basin.right_node.point.y<e.basin.right_node.next.point.y;)e.basin.right_node=e.basin.right_node.next;e.basin.right_node!==e.basin.bottom_node&&(e.basin.width=e.basin.right_node.point.x-e.basin.left_node.point.x,e.basin.left_highest=e.basin.left_node.point.y>e.basin.right_node.point.y,function e(t,r){if(!function(e,t){var r;return r=e.basin.left_highest?e.basin.left_node.point.y-t.point.y:e.basin.right_node.point.y-t.point.y,e.basin.width>r}(t,r)){var i;if(o5(t,r),r.prev!==t.basin.left_node||r.next!==t.basin.right_node){if(r.prev===t.basin.left_node){if(o0(r.point,r.next.point,r.next.next.point)===oQ.CW)return;r=r.next}else if(r.next===t.basin.right_node){if(o0(r.point,r.prev.point,r.prev.prev.point)===oQ.CCW)return;r=r.prev}else r=r.prev.point.y<r.next.point.y?r.prev:r.next;e(t,r)}}}(e,e.basin.bottom_node))}}(e,t)}(e,i),i}(e,i),s=i._p2t_edge_list,n=0;s&&n<s.length;++n)!function(e,t,r){var i,o,s;e.edge_event.constrained_edge=t,e.edge_event.right=t.p.x>t.q.x,o4(r.triangle,t.p,t.q)||(i=e,o=t,s=r,i.edge_event.right?function(e,t,r){for(;r.next.point.x<t.p.x;)o0(t.q,r.next.point,t.p)===oQ.CCW?function e(t,r,i){i.point.x<r.p.x&&(o0(i.point,i.next.point,i.next.next.point)===oQ.CCW?o8(t,r,i):(function e(t,r,i){o0(i.next.point,i.next.next.point,i.next.next.next.point)===oQ.CCW?o8(t,r,i.next):o0(r.q,i.next.next.point,r.p)===oQ.CCW&&e(t,r,i.next)}(t,r,i),e(t,r,i)))}(e,t,r):r=r.next}(i,o,s):function(e,t,r){for(;r.prev.point.x>t.p.x;)o0(t.q,r.prev.point,t.p)===oQ.CW?function e(t,r,i){i.point.x>r.p.x&&(o0(i.point,i.prev.point,i.prev.prev.point)===oQ.CW?o7(t,r,i):(function e(t,r,i){o0(i.prev.point,i.prev.prev.point,i.prev.prev.prev.point)===oQ.CW?o7(t,r,i.prev):o0(r.q,i.prev.prev.point,r.p)===oQ.CW&&e(t,r,i.prev)}(t,r,i),e(t,r,i)))}(e,t,r):r=r.prev}(i,o,s),o3(e,t.p,t.q,r.triangle,t.q))}(e,s[n],o)}(e),function(e){for(var t=e.front().head().next.triangle,r=e.front().head().next.point;!t.getConstrainedEdgeCW(r);)t=t.neighborCCW(r);e.meshClean(t)}(e)};var st=o$.Node,sr=function(e,t){if(this.p=e,this.q=t,e.y>t.y)this.q=e,this.p=t;else if(e.y===t.y){if(e.x>t.x)this.q=e,this.p=t;else if(e.x===t.x)throw new oz("poly2tri Invalid Edge constructor: repeated points!",[e])}this.q._p2t_edge_list||(this.q._p2t_edge_list=[]),this.q._p2t_edge_list.push(this)},si=function(){this.left_node=null,this.bottom_node=null,this.right_node=null,this.width=0,this.left_highest=!1};si.prototype.clear=function(){this.left_node=null,this.bottom_node=null,this.right_node=null,this.width=0,this.left_highest=!1};var so=function(){this.constrained_edge=null,this.right=!1},ss=function(e,t){t=t||{},this.triangles_=[],this.map_=[],this.points_=t.cloneArrays?e.slice(0):e,this.edge_list=[],this.pmin_=this.pmax_=null,this.front_=null,this.head_=null,this.tail_=null,this.af_head_=null,this.af_middle_=null,this.af_tail_=null,this.basin=new si,this.edge_event=new so,this.initEdges(this.points_)};ss.prototype.addHole=function(e){this.initEdges(e);var t,r=e.length;for(t=0;t<r;t++)this.points_.push(e[t]);return this},ss.prototype.AddHole=ss.prototype.addHole,ss.prototype.addHoles=function(e){var t,r=e.length;for(t=0;t<r;t++)this.initEdges(e[t]);return this.points_=this.points_.concat.apply(this.points_,e),this},ss.prototype.addPoint=function(e){return this.points_.push(e),this},ss.prototype.AddPoint=ss.prototype.addPoint,ss.prototype.addPoints=function(e){return this.points_=this.points_.concat(e),this},ss.prototype.triangulate=function(){return oW.triangulate(this),this},ss.prototype.getBoundingBox=function(){return{min:this.pmin_,max:this.pmax_}},ss.prototype.getTriangles=function(){return this.triangles_},ss.prototype.GetTriangles=ss.prototype.getTriangles,ss.prototype.front=function(){return this.front_},ss.prototype.pointCount=function(){return this.points_.length},ss.prototype.head=function(){return this.head_},ss.prototype.setHead=function(e){this.head_=e},ss.prototype.tail=function(){return this.tail_},ss.prototype.setTail=function(e){this.tail_=e},ss.prototype.getMap=function(){return this.map_},ss.prototype.initTriangulation=function(){var e,t=this.points_[0].x,r=this.points_[0].x,i=this.points_[0].y,o=this.points_[0].y,s=this.points_.length;for(e=1;e<s;e++){var n=this.points_[e];n.x>t&&(t=n.x),n.x<r&&(r=n.x),n.y>i&&(i=n.y),n.y<o&&(o=n.y)}this.pmin_=new oB(r,o),this.pmax_=new oB(t,i);var a=.3*(t-r),l=.3*(i-o);this.head_=new oB(t+a,o-l),this.tail_=new oB(r-a,o-l),this.points_.sort(oB.compare)},ss.prototype.initEdges=function(e){var t,r=e.length;for(t=0;t<r;++t)this.edge_list.push(new sr(e[t],e[(t+1)%r]))},ss.prototype.getPoint=function(e){return this.points_[e]},ss.prototype.addToMap=function(e){this.map_.push(e)},ss.prototype.locateNode=function(e){return this.front_.locateNode(e.x)},ss.prototype.createAdvancingFront=function(){var e,t,r,i=new oU(this.points_[0],this.tail_,this.head_);this.map_.push(i),e=new st(i.getPoint(1),i),t=new st(i.getPoint(0),i),r=new st(i.getPoint(2)),this.front_=new o$(e,r),e.next=t,t.next=r,t.prev=e,r.prev=t},ss.prototype.removeNode=function(e){},ss.prototype.mapTriangleToNodes=function(e){for(var t=0;t<3;++t)if(!e.getNeighbor(t)){var r=this.front_.locatePoint(e.pointCW(e.getPoint(t)));r&&(r.triangle=e)}},ss.prototype.removeFromMap=function(e){var t,r=this.map_,i=r.length;for(t=0;t<i;t++)if(r[t]===e){r.splice(t,1);break}},ss.prototype.meshClean=function(e){for(var t,r,i=[e];t=i.pop();)if(!t.isInterior())for(t.setInterior(!0),this.triangles_.push(t),r=0;r<3;r++)t.constrained_edge[r]||i.push(t.getNeighbor(r))},!function(e){var t=globalThis.poly2tri;e.noConflict=function(){return globalThis.poly2tri=t,e},e.VERSION=oD.version,e.PointError=oz,e.Point=oB,e.Triangle=oU,e.SweepContext=ss,e.triangulate=oW.triangulate,e.sweep={Triangulate:oW.triangulate}}(oO);let sn=class extends oS{resourceTrianglePoints=[];resourceUniquePoints=[];trianglePointsUniquePointsIndex=[];triangulationByBestScaleFactor=new Map;triangulateErrorCount=0;projectedGeoPreviousTrianglePoints=[];projectedGeoTrianglePoints=[];projectedGeoUniquePoints=[];projectedGeoUniquePointsByBestScaleFactorAndTransformationType=new Map;projectedGeoUniquePointsPartialDerivativeX=[];projectedGeoUniquePointsPartialDerivativeY=[];projectedGeoUniquePointsPartialDerivativeXByBestScaleFactorAndTransformationType=new Map;projectedGeoUniquePointsPartialDerivativeYByBestScaleFactorAndTransformationType=new Map;previousTrianglePointsDistortion=[];trianglePointsDistortion=[];uniquePointsDistortion=[];constructor(e,t,r){super(e,t,r={...r})}setResourceMask(e){super.setResourceMask(e),this.triangulationByBestScaleFactor=new Map,this.projectedGeoUniquePointsByBestScaleFactorAndTransformationType=new Map,this.projectedGeoUniquePointsPartialDerivativeXByBestScaleFactorAndTransformationType=new Map,this.projectedGeoUniquePointsPartialDerivativeYByBestScaleFactorAndTransformationType=new Map,this.updateTriangulation()}setCurrentBestScaleFactor(e){let t=super.setCurrentBestScaleFactor(e);return t&&this.updateTriangulation(!0),t}resetPrevious(){super.resetPrevious(),this.projectedGeoPreviousTrianglePoints=this.projectedGeoTrianglePoints,this.previousTrianglePointsDistortion=this.trianglePointsDistortion}mixPreviousAndNew(e){super.mixPreviousAndNew(e),this.projectedGeoPreviousTrianglePoints=this.projectedGeoTrianglePoints.map((t,r)=>I(t,this.projectedGeoPreviousTrianglePoints[r],e)),this.previousTrianglePointsDistortion=this.trianglePointsDistortion.map((t,r)=>t*(1-e)+this.previousTrianglePointsDistortion[r]*e)}updateTriangulation(e=!1){if(!this.currentBestScaleFactor)return;let{trianglePointsUniquePointsIndex:t,resourceUniquePoints:r}=eo(this.triangulationByBestScaleFactor,this.currentBestScaleFactor,()=>{let e=C(Q(H(this.resourceMask)))*this.currentBestScaleFactor/80;try{let{uniquePointsIndexTriangles:t,uniquePoints:r}=function(e,t){let r=(function(e,t){let r=0,i=new oO.SweepContext((function(e,t){e=[...e,e[0]];let r=[];for(let i=0;i<e.length-1;i++)r=r.concat(function(e,t){var r,i,o;let s=e[0],n=[s];for(;Math.sqrt(Math.pow((r=[s,e[1]])[1][0]-r[0][0],2)+Math.pow(r[1][1]-r[0][1],2))>t;){let r=(i=s,o=Math.atan2(e[1][1]-e[0][1],e[1][0]-e[0][0]),[i[0]+Math.cos(o)*t,i[1]+Math.sin(o)*t]);n.push(r),s=r}return n}([e[i],e[i+1]],t));return r})(e,t).map(e=>({x:e[0],y:e[1],type:"p",item:r++})));i.addPoints((function(e,t){let r=[],i=H(e);for(let e=i[0]+t,o=0;e<=i[2];o++,e+=t)for(let o=i[1]+t,s=0;o<=i[3];s++,o+=t)r.push([e,o]);return r})(e,t).filter(t=>-1===oF(e,t)).map(e=>({x:e[0],y:e[1],type:"g",item:r++})));try{i.triangulate()}catch{throw Error("A Point Error occured during resource mask triangulation. This is typically because the resource mask contains duplicate or collinear points, or is self-intersecting.")}return i.getTriangles()})(e,t).map(e=>e.getPoints().map(e=>e)),i=[...new Map(r.flat().map(e=>[e.item,e])).values()].sort((e,t)=>e.item-t.item).map(e=>[e.x,e.y]);return{uniquePointsIndexTriangles:r.map(e=>e.map(e=>e.item)),uniquePoints:i}}(this.resourceMask,e);return{trianglePointsUniquePointsIndex:t.flat(),resourceUniquePoints:r}}catch(e){return this.triangulateErrorCount++,this.triangulateErrorCount<=10&&(console.error(`Error computing triangulation for map ${this.mapId}.`,`Fix this map with Allmaps Editor: https://editor.allmaps.org/#/collection?url=${this.parsedImage?.uri}/info.json`),1===this.triangulateErrorCount&&console.error(e)),{trianglePointsUniquePointsIndex:this.trianglePointsUniquePointsIndex,resourceUniquePoints:this.resourceUniquePoints}}});this.resourceTrianglePoints=t.map(e=>r[e]),this.resourceUniquePoints=r,this.trianglePointsUniquePointsIndex=t,this.updateProjectedGeoTrianglePoints(e)}updateProjectedGeoTrianglePoints(e=!1){this.currentBestScaleFactor&&(this.projectedGeoUniquePoints=es(this.projectedGeoUniquePointsByBestScaleFactorAndTransformationType,this.currentBestScaleFactor,this.transformationType,()=>this.resourceUniquePoints.map(e=>this.projectedTransformer.transformToGeo(e))),this.projectedGeoTrianglePoints=this.trianglePointsUniquePointsIndex.map(e=>this.projectedGeoUniquePoints[e]),(e||!this.projectedGeoPreviousTrianglePoints.length)&&(this.projectedGeoPreviousTrianglePoints=this.projectedGeoTrianglePoints),this.updateTrianglePointsDistortion(e))}updateTrianglePointsDistortion(e=!1){this.currentBestScaleFactor&&(this.distortionMeasure&&(this.projectedGeoUniquePointsPartialDerivativeX=es(this.projectedGeoUniquePointsPartialDerivativeXByBestScaleFactorAndTransformationType,this.currentBestScaleFactor,this.transformationType,()=>this.resourceUniquePoints.map(e=>this.projectedTransformer.transformToGeo(e,{evaluationType:"partialDerivativeX"}))),this.projectedGeoUniquePointsPartialDerivativeY=es(this.projectedGeoUniquePointsPartialDerivativeYByBestScaleFactorAndTransformationType,this.currentBestScaleFactor,this.transformationType,()=>this.resourceUniquePoints.map(e=>this.projectedTransformer.transformToGeo(e,{evaluationType:"partialDerivativeY"})))),this.uniquePointsDistortion=this.projectedGeoUniquePoints.map((e,t)=>(function(e,t,r,i=1){if(!r)return 0;let o=e[0]**2+e[1]**2,s=t[0]**2+t[1]**2,n=e[0]*t[0]+e[1]*t[1],a=Math.sqrt(.5*(o+s+Math.sqrt((o-s)**2+4*n**2))),l=Math.sqrt(.5*(o+s-Math.sqrt((o-s)**2+4*n**2))),h=Math.atan(e[1]/e[0]),u=Math.sign(-n)*Math.asin(Math.sqrt((1-a**2/o)/(1-(a/l)**2)));switch(oM.indexOf(r)){case 0:return(Math.log(a*l)-2*Math.log(i))/Math.log(2);case 1:return 2*Math.asin((a-l)/(a+l));case 2:return .5*(Math.log(a/i)**2+Math.log(l/i)**2);case 3:return Math.sign(e[0]*t[1]-e[1]*t[0]);case 4:return h-u;default:throw Error("Distortion "+r+" not supported")}})(this.projectedGeoUniquePointsPartialDerivativeX[t],this.projectedGeoUniquePointsPartialDerivativeY[t],this.distortionMeasure,this.getReferenceScale())),this.trianglePointsDistortion=this.trianglePointsUniquePointsIndex.map(e=>this.uniquePointsDistortion[e]),(e||!this.previousTrianglePointsDistortion.length)&&(this.previousTrianglePointsDistortion=this.trianglePointsDistortion))}updateTransformerProperties(e=!0){super.updateTransformerProperties(e),this.updateProjectedGeoTrianglePoints(!1)}updateDistortionProperties(){super.updateDistortionProperties(),this.updateTrianglePointsDistortion(!1)}};var sa="object"==typeof globalThis&&globalThis&&globalThis.Object===Object&&globalThis,sl="object"==typeof self&&self&&self.Object===Object&&self,sh=sa||sl||Function("return this")(),su=sh.Symbol,sc=Object.prototype,sd=sc.hasOwnProperty,sp=sc.toString,sf=su?su.toStringTag:void 0,sm=Object.prototype.toString,sg=su?su.toStringTag:void 0,sv=/\s/,sy=/^\s+/;function sw(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}var sx=NaN,s_=/^[-+]0x[0-9a-f]+$/i,sb=/^0b[01]+$/i,sM=/^0o[0-7]+$/i,sT=parseInt;function sE(e){if("number"==typeof e)return e;if("symbol"==typeof(t=e)||null!=t&&"object"==typeof t&&(null==t?void 0===t?"[object Undefined]":"[object Null]":sg&&sg in Object(t)?function(e){var t=sd.call(e,sf),r=e[sf];try{e[sf]=void 0;var i=!0}catch{}var o=sp.call(e);return i&&(t?e[sf]=r:delete e[sf]),o}(t):sm.call(t))=="[object Symbol]")return sx;if(sw(e)){var t,r,i="function"==typeof e.valueOf?e.valueOf():e;e=sw(i)?i+"":i}if("string"!=typeof e)return 0===e?e:+e;e=(r=e)&&r.slice(0,function(e){for(var t=e.length;t--&&sv.test(e.charAt(t)););return t}(r)+1).replace(sy,"");var o=sb.test(e);return o||sM.test(e)?sT(e.slice(2),o?2:8):s_.test(e)?sx:+e}var sP=function(){return sh.Date.now()},sS=Math.max,sR=Math.min;function sI(e,t,r){var i=!0,o=!0;if("function"!=typeof e)throw TypeError("Expected a function");return sw(r)&&(i="leading"in r?!!r.leading:i,o="trailing"in r?!!r.trailing:o),function(e,t,r){var i,o,s,n,a,l,h=0,u=!1,c=!1,d=!0;if("function"!=typeof e)throw TypeError("Expected a function");function p(t){var r=i,s=o;return i=o=void 0,h=t,n=e.apply(s,r)}function f(e){var r=e-l,i=e-h;return void 0===l||r>=t||r<0||c&&i>=s}function m(){var e,r,i,o=sP();if(f(o))return g(o);a=setTimeout(m,(e=o-l,r=o-h,i=t-e,c?sR(i,s-r):i))}function g(e){return a=void 0,d&&i?p(e):(i=o=void 0,n)}function v(){var e,r=sP(),s=f(r);if(i=arguments,o=this,l=r,s){if(void 0===a)return h=e=l,a=setTimeout(m,t),u?p(e):n;if(c)return clearTimeout(a),a=setTimeout(m,t),p(l)}return void 0===a&&(a=setTimeout(m,t)),n}return t=sE(t)||0,sw(r)&&(u=!!r.leading,s=(c="maxWait"in r)?sS(sE(r.maxWait)||0,t):s,d="trailing"in r?!!r.trailing:d),v.cancel=function(){void 0!==a&&clearTimeout(a),h=0,i=l=o=a=void 0},v.flush=function(){return void 0===a?n:g(sP())},v}(e,t,{leading:i,maxWait:t,trailing:o})}let sC="#222222",sA="#ffffff",sL=["#dff7fa","#c0eff5","#a1e7f0","#82dfeb","#63d8e6","#4facb8","#3b818a","#27565c","#132b2d"],sj=["#d7d9ee","#b0b4de","#898ecd","#6269bd","#3b44ad","#2f368a","#232867","#171b45","#0b0d22"],sk=["#f3dcf0","#e7b9e1","#dc97d2","#d074c3","#c552b5","#9d4190","#76316c","#4e2048","#271024"],sF=["#ffddf1","#ffbbe3","#ff99d5","#ff77c7","#ff56ba","#cc4494","#99336f","#66224a","#321125"],sO=["#ffe3d0","#ffc7a1","#ffab72","#ff8f43","#ff7415","#cc5c10","#99450c","#662e08","#321704"],sD=["#fededf","#febebf","#fe9e9f","#fe7e7f","#fe5e60","#cb4b4c","#983839","#652526","#321213"],sG=["#e0f2e8","#c1e6d2","#a2d9bb","#83cda5","#64c18f","#509a72","#3c7355","#284d39","#13261c"],sN=["#fff3d9","#ffe8b3","#ffdd8d","#ffd267","#ffc742","#cc9f34","#997727","#664f1a","#32270d"],sz=["#efefef","#e0e0e0","#d0d0d0","#c1c1c1","#b2b2b2","#8e8e8e","#6a6a6a","#474747","#232323"],sB={blue:sL,darkblue:sj,purple:sk,pink:sF,orange:sO,red:sD,green:sG,yellow:sN,gray:sz},sU=sL[4],sV=sj[4],sW=(sk[4],sF[4]),sZ=(sO[4],sD[4]),sq=sG[4],s$=sN[4];function sX(e,t){return t.reduce((t,r,i)=>(t[`${e}-${(i+1)*100}`]=r,t),{})}function sH(e,t,r){let i=e.createShader(t);if(i){if(e.shaderSource(i,r),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS))return i;{let t=e.getShaderInfoLog(i);throw e.deleteShader(i),Error("Failed to compile shader: "+t)}}throw Error("Failed to create shader")}function sY(e,t,r){let i=e.createProgram();if(i){if(e.attachShader(i,t),e.attachShader(i,r),e.linkProgram(i),e.getProgramParameter(i,e.LINK_STATUS))return i;{let t=e.getProgramInfoLog(i);throw e.deleteProgram(i),Error("Failed to link program: "+t)}}throw Error("Failed to create program")}function sK(e,t,r,i,o){let s=e.createBuffer();if(!s)throw Error("Failed to create buffer");e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,r,e.STATIC_DRAW);let n=e.FLOAT,a=e.getAttribLocation(t,o);return e.vertexAttribPointer(a,i,n,!1,0,0),e.enableVertexAttribArray(a),s}function sJ(e,t,r,i){let o=Math.floor(e.column*e.tileZoomLevel.scaleFactor/r);o=o>=0?o:0;let s=Math.ceil((e.column+1)*e.tileZoomLevel.scaleFactor/r),n=Math.floor(e.row*e.tileZoomLevel.scaleFactor/r);n=n>=0?n:0;let a=Math.ceil((e.row+1)*e.tileZoomLevel.scaleFactor/r);return sQ(r,t,o,s,n,a,i)}function sQ(e,t,r,i,o,s,n=e=>!0){let a=t.tileZoomLevels.find(t=>t.scaleFactor==e),l=[t.width,t.height];if(!a)return[];r=r||0,i=i||a.columns,o=o||0,s=s||a.rows;let h=[];for(let e=r;e<i;e++)for(let t=o;t<s;t++){let r={column:e,row:t,tileZoomLevel:a,imageSize:l};n(r)&&h.push(r)}return h}sz[4],sX("blue",sB.blue),sX("darkblue",sB.darkblue),sX("purple",sB.purple),sX("pink",sB.pink),sX("orange",sB.orange),sX("red",sB.red),sX("green",sB.green),sX("yellow",sB.yellow),sX("gray",sB.gray);function s0(e){let t=s1(e);return[(t[2]-t[0])/2+t[0],(t[3]-t[1])/2+t[1]]}function s1(e){var t;let r=[(t=e).column*t.tileZoomLevel.originalWidth,t.row*t.tileZoomLevel.originalHeight],i=Math.min(r[0]+e.tileZoomLevel.originalWidth,e.imageSize[0]),o=Math.min(r[1]+e.tileZoomLevel.originalHeight,e.imageSize[1]);return[r[0],r[1],i,o]}function s2(e){var t,r,i;return t=e.tileZoomLevel.scaleFactor,r=e.row,i=e.column,`${t}:${r}:${i}`}let s3={leading:!0,trailing:!0},s4=[...en(sC),1],s5=[...en(sA),1],s9=[...en(sC),1],s6=[...en(sA),1];class s8 extends sn{gl;mapsProgram;linesProgram;pointsProgram;mapsVao=null;linesVao=null;pointsVao=null;lineLayers=[];pointLayers=[];cachedTilesByTileKey=new Map;cachedTilesByTileUrl=new Map;cachedTilesForTexture=[];previousCachedTilesForTexture=[];textureWidth=0;textureHeight=0;textureDepth=0;opacity=1;saturation=1;renderOptions={};cachedTilesTextureArray=null;cachedTilesResourcePositionsAndDimensionsTexture=null;cachedTilesScaleFactorsTexture=null;projectedGeoToClipTransform;throttledUpdateTextures;constructor(e,t,r,i,o,s,n){super(e,t,n),this.gl=r,this.initializeWebGL(i,o,s),this.throttledUpdateTextures=sI(this.updateTextures.bind(this),200,s3)}initializeWebGL(e,t,r){this.mapsProgram=e,this.linesProgram=t,this.pointsProgram=r,this.mapsVao=this.gl.createVertexArray(),this.linesVao=this.gl.createVertexArray(),this.pointsVao=this.gl.createVertexArray(),this.cachedTilesTextureArray=this.gl.createTexture(),this.cachedTilesScaleFactorsTexture=this.gl.createTexture(),this.cachedTilesResourcePositionsAndDimensionsTexture=this.gl.createTexture()}updateVertexBuffers(e){this.projectedGeoToClipTransform=e,this.updateVertexBuffersMaps()}clearTextures(){this.throttledUpdateTextures()}addCachedTileAndUpdateTextures(e){this.cachedTilesByTileKey.set(e.tileKey,e),this.cachedTilesByTileUrl.set(e.tileUrl,e),this.throttledUpdateTextures()}removeCachedTileAndUpdateTextures(e){let t=this.cachedTilesByTileUrl.get(e);t&&this.cachedTilesByTileKey.delete(t.tileKey),this.cachedTilesByTileUrl.delete(e),this.throttledUpdateTextures()}cancelThrottledFunctions(){this.throttledUpdateTextures.cancel()}destroy(){this.gl.deleteVertexArray(this.mapsVao),this.gl.deleteVertexArray(this.linesVao),this.gl.deleteVertexArray(this.pointsVao),this.gl.deleteTexture(this.cachedTilesTextureArray),this.gl.deleteTexture(this.cachedTilesScaleFactorsTexture),this.gl.deleteTexture(this.cachedTilesResourcePositionsAndDimensionsTexture),this.cancelThrottledFunctions(),super.destroy()}setLineLayers(){this.lineLayers=[{projectedGeoLines:S(this.projectedGeoLongerMask),projectedGeoPreviousLines:S(this.projectedGeoPreviousLongerMask),viewportSize:8,color:[...en(sW),1]},{projectedGeoLines:P(this.projectedGeoPoints,this.projectedGeoTransformedResourcePoints),projectedGeoPreviousLines:P(this.projectedGeoPoints,this.projectedGeoPreviousTransformedResourcePoints),color:[...en(sC),1],borderColor:[...en(sA),1]}]}setPointLayers(){this.pointLayers=[{projectedGeoPoints:this.projectedGeoPoints,color:[...en(sU),1]},{projectedGeoPoints:this.projectedGeoTransformedResourcePoints,projectedGeoPreviousPoints:this.projectedGeoPreviousTransformedResourcePoints,color:[...en(sW),1]}]}updateVertexBuffersMaps(){if(!this.mapsVao||!this.projectedGeoToClipTransform)return;let e=this.gl,t=this.mapsProgram;e.bindVertexArray(this.mapsVao),sK(e,t,new Float32Array(this.resourceTrianglePoints.flat()),2,"a_resourceTrianglePoint"),sK(e,t,new Float32Array(this.projectedGeoPreviousTrianglePoints.map(e=>o(this.projectedGeoToClipTransform,e)).flat()),2,"a_clipPreviousTrianglePoint"),sK(e,t,new Float32Array(this.projectedGeoTrianglePoints.map(e=>o(this.projectedGeoToClipTransform,e)).flat()),2,"a_clipTrianglePoint"),sK(e,t,new Float32Array(this.previousTrianglePointsDistortion),1,"a_previousTrianglePointDistortion"),sK(e,t,new Float32Array(this.trianglePointsDistortion),1,"a_trianglePointDistortion"),sK(e,t,new Float32Array(this.resourceTrianglePoints.length).map((e,t)=>t),1,"a_trianglePointIndex")}updateVertexBuffersLines(){if(!this.linesVao)return;let e=this.gl,t=this.linesProgram;e.bindVertexArray(this.linesVao),this.setLineLayers(),sK(e,t,new Float32Array(this.lineLayers.reduce((e,t)=>e.concat(t.projectedGeoLines),[]).map(e=>[e[0],e[0],e[0],e[1],e[1],e[1]]).flat().flat()),2,"a_projectedGeoPoint"),sK(e,t,new Float32Array(this.lineLayers.reduce((e,t)=>e.concat(t.projectedGeoLines),[]).map(e=>[e[1],e[1],e[1],e[0],e[0],e[0]]).flat().flat()),2,"a_projectedGeoOtherPoint"),sK(e,t,new Float32Array(this.lineLayers.reduce((e,t)=>e.concat(t.projectedGeoPreviousLines||t.projectedGeoLines),[]).map(e=>[e[0],e[0],e[0],e[1],e[1],e[1]]).flat().flat()),2,"a_projectedGeoPreviousPoint"),sK(e,t,new Float32Array(this.lineLayers.reduce((e,t)=>e.concat(t.projectedGeoPreviousLines||t.projectedGeoLines),[]).map(e=>[e[1],e[1],e[1],e[0],e[0],e[0]]).flat().flat()),2,"a_projectedGeoPreviousOtherPoint"),sK(e,t,new Float32Array(this.lineLayers.reduce((e,t)=>e.concat(t.projectedGeoLines.flatMap(e=>[0,0,1,0,0,1])),[])),1,"a_isOtherPoint"),sK(e,t,new Float32Array(this.lineLayers.reduce((e,t)=>e.concat(t.projectedGeoLines.flatMap(e=>[1,-1,1,1,-1,1])),[])),1,"a_normalSign"),sK(e,t,new Float32Array(this.lineLayers.reduce((e,t)=>e.concat(t.projectedGeoLines.flatMap(e=>Array(6).fill(Object.prototype.hasOwnProperty.call(t,"viewportSize")?t.viewportSize:6))),[])),1,"a_viewportSize"),sK(e,t,new Float32Array(this.lineLayers.reduce((e,t)=>e.concat(t.projectedGeoLines.flatMap(e=>Array(6).fill(Object.prototype.hasOwnProperty.call(t,"color")?t.color:s4))),[]).flat()),4,"a_color"),sK(e,t,new Float32Array(this.lineLayers.reduce((e,t)=>e.concat(t.projectedGeoLines.flatMap(e=>Array(6).fill(t.viewportBorderSize||0))),[])),1,"a_viewportBorderSize"),sK(e,t,new Float32Array(this.lineLayers.reduce((e,t)=>e.concat(t.projectedGeoLines.flatMap(e=>Array(6).fill(Object.prototype.hasOwnProperty.call(t,"borderColor")?t.borderColor:s5))),[]).flat()),4,"a_borderColor")}updateVertexBuffersPoints(){if(!this.pointsVao)return;let e=this.gl,t=this.pointsProgram;e.bindVertexArray(this.pointsVao),this.setPointLayers(),sK(e,t,new Float32Array(this.pointLayers.reduce((e,t)=>e.concat(t.projectedGeoPoints),[]).flat()),2,"a_projectedGeoPoint"),sK(e,t,new Float32Array(this.pointLayers.reduce((e,t)=>e.concat(t.projectedGeoPreviousPoints||t.projectedGeoPoints),[]).flat()),2,"a_projectedGeoPreviousPoint"),sK(e,t,new Float32Array(this.pointLayers.reduce((e,t)=>e.concat(t.projectedGeoPoints.map(e=>Object.prototype.hasOwnProperty.call(t,"viewportSize")?t.viewportSize:16)),[])),1,"a_viewportSize"),sK(e,t,new Float32Array(this.pointLayers.reduce((e,t)=>e.concat(t.projectedGeoPoints.map(e=>Object.prototype.hasOwnProperty.call(t,"color")?t.color:s9)),[]).flat()),4,"a_color"),sK(e,t,new Float32Array(this.pointLayers.reduce((e,t)=>e.concat(t.projectedGeoPoints.map(e=>t.viewportBorderSize||1)),[])),1,"a_viewportBorderSize"),sK(e,t,new Float32Array(this.pointLayers.reduce((e,t)=>e.concat(t.projectedGeoPoints.map(e=>Object.prototype.hasOwnProperty.call(t,"borderColor")?t.borderColor:s6)),[]).flat()),4,"a_borderColor")}async updateTextures(){let e=this.gl;if(this.updateCachedTilesForTextures(),0!=this.cachedTilesForTexture.length&&function(e,t){for(let r=0;r<t.length;r++)if(-1==e.indexOf(t[r]))return!1;return!0}(this.previousCachedTilesForTexture.map(e=>e.tileUrl),this.cachedTilesForTexture.map(e=>e.tileUrl)))return;let t=Math.max(...this.parsedImage.tileZoomLevels.map(e=>e.width)),r=Math.max(...this.parsedImage.tileZoomLevels.map(e=>e.height)),i=this.cachedTilesForTexture.length;e.pixelStorei(e.UNPACK_ALIGNMENT,4),e.bindTexture(e.TEXTURE_2D_ARRAY,this.cachedTilesTextureArray),e.texImage3D(e.TEXTURE_2D_ARRAY,0,e.RGBA,t,r,i,0,e.RGBA,e.UNSIGNED_BYTE,null);for(let t=0;t<this.cachedTilesForTexture.length;t++){let r=this.cachedTilesForTexture[t].data;e.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,t,r.width,r.height,1,e.RGBA,e.UNSIGNED_BYTE,r)}e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);let o=this.cachedTilesForTexture.map(e=>{if(e&&e.imageRequest&&e.imageRequest.region)return[e.imageRequest.region.x,e.imageRequest.region.y,e.imageRequest.region.width,e.imageRequest.region.height]});e.bindTexture(e.TEXTURE_2D,this.cachedTilesResourcePositionsAndDimensionsTexture),e.texImage2D(e.TEXTURE_2D,0,e.R32I,1,4*this.cachedTilesForTexture.length,0,e.RED_INTEGER,e.INT,new Int32Array(o.flat())),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);let s=this.cachedTilesForTexture.map(e=>e.tile.tileZoomLevel.scaleFactor);e.bindTexture(e.TEXTURE_2D,this.cachedTilesScaleFactorsTexture),e.texImage2D(e.TEXTURE_2D,0,e.R32I,1,this.cachedTilesForTexture.length,0,e.RED_INTEGER,e.INT,new Int32Array(s)),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),this.dispatchEvent(new oE(oT.TEXTURESUPDATED))}updateCachedTilesForTextures(){let e=[],t=[],r=[];for(let r of this.currentFetchableTiles){let i=this.cachedTilesByTileUrl.get(r.tileUrl);if(i)e.push(i);else for(let e of this.getCachedTilesAtOtherScaleFactors(r.tile))t.push(e)}for(let t of this.currentOverviewFetchableTiles){let i=this.cachedTilesByTileUrl.get(t.tileUrl);if(i){let t=this.currentTileZoomLevel?this.currentTileZoomLevel.rows*this.currentTileZoomLevel.columns:void 0;(0==e.length||t&&e.length<t)&&r.push(i)}}let i=[...e,...t,...r],o=new Map;i.forEach(e=>o.set(e.tileUrl,e)),i=[...o.values()],this.previousCachedTilesForTexture=this.cachedTilesForTexture,this.cachedTilesForTexture=i}getCachedTilesAtOtherScaleFactors(e){if(0==this.cachedTilesByTileUrl.size)return[];let t=[];for(e of function(e,t,r,i,o,s){let n=[];for(let i of function e(t,r,i,o,s){let n=2**(Math.log2(i)-1);if(n<=0||0==o)return[];let a=sJ(t,r,n,s),l=sJ(t,r,n,e=>!0);return a.length==l.length?a:[...a,...e(t,r,n,o--,s)]}(e,t,r,1,s))i&&n.push(i);if(0==n.length){let i=function e(t,r,i,o,s){let n=2**(Math.log2(i)+1);return n>r.tileZoomLevels.map(e=>e.scaleFactor).reduce((e,t)=>e+t,0)-i||0==o?void 0:function(e,t,r,i){let o=sJ(e,t,r,i);if(0!=o.length)return o[0]}(t,r,n,s)??e(t,r,n,o--,s)}(e,t,r,5,s);i&&n.push(i)}return n}(e,this.parsedImage,this.currentBestScaleFactor,0,0,this.tileInCachedTiles.bind(this))){let r=this.tileToCachedTile(e);if(r)t.push(r);else throw Error("Tile supposed to be in cache isn't.")}return t}tileToCachedTile(e){return this.cachedTilesByTileKey.get(s2(e))}tileInCachedTiles(e){return this.cachedTilesByTileKey.has(s2(e))}}let s7=rp.string().or(rp.number()).or(rp.boolean()),ne=rp.record(rp.string(),s7.array()),nt=rp.tuple([rp.number(),rp.number()]),nr=rp.object({type:rp.literal("Point"),coordinates:nt}),ni=nt.array().min(3),no=rp.enum(["ImageService1","ImageService2","ImageService3"]),ns=rp.object({id:rp.string().url(),type:rp.string(),label:ne.optional()}).extend({partOf:rp.lazy(()=>ns.array()).optional()}),nn=rp.union([rp.any(),rp.object({type:rp.enum(["helmert","polynomial","thinPlateSpline","projective"]).or(rp.string()),options:rp.object({}).optional()})]).transform(e=>{if(e&&"object"==typeof e&&"type"in e)return e}),na=rp.union([rp.string().url().array(),rp.string().url()]),nl=rp.object({type:rp.literal("SvgSelector"),value:rp.string().regex(/^<svg\s+width="\d+"\s+height="\d+"\s*>\s*<polygon\s+points="\s*(-?\d+(\.\d+)?,-?\d+(\.\d+)?\s+){2,}-?\d+(\.\d+)?,-?\d+(\.\d+)?\s*"\s*\/>\s*<\/svg>$/)}),nh=rp.object({source:rp.string().url(),service:rp.array(rp.object({"@id":rp.string().url(),type:no})).length(1),selector:nl}),nu=rp.object({pixelCoords:nt}),nc=rp.object({type:rp.literal("FeatureCollection"),transformation:nn.optional(),features:rp.array(rp.object({type:rp.literal("Feature"),properties:nu,geometry:nr}))}),nd=rp.object({id:rp.string().optional(),type:rp.literal("Annotation"),"@context":na.optional(),motivation:rp.string().default("georeferencing").optional(),target:nh,body:nc}),np=rp.object({id:rp.string().optional(),type:rp.literal("AnnotationPage"),"@context":na.optional(),items:rp.array(nd)}),nf=/<polygon\s+points="\s*(-?\d+(\.\d+)?,-?\d+(\.\d+)?\s+){2,}-?\d+(\.\d+)?,-?\d+(\.\d+)?\s*"\s*\/>/,nm=RegExp(`^<svg\\s+width="\\d+"\\s+height="\\d+"\\s*>\\s*${nf.source}\\s*</svg>$`),ng=RegExp(`^<svg\\s+height="\\d+"\\s+width="\\d+"\\s*>\\s*${nf.source}\\s*</svg>$`),nv=RegExp(`^<svg\\s*>\\s*${nf.source}\\s*</svg>$`),ny=rp.string().regex(nv),nw=rp.string().regex(nm),nx=rp.string().regex(ng),n_=rp.object({type:rp.literal("SvgSelector"),value:ny.or(nw).or(nx)}),nb=rp.object({"@id":rp.string().url(),type:no,height:rp.number().positive(),width:rp.number().positive(),partOf:ns.array().optional()}),nM=rp.object({id:rp.string().url(),type:no,height:rp.number().positive(),width:rp.number().positive(),partOf:ns.array().optional()}),nT=rp.object({type:rp.literal("SpecificResource"),source:nb.or(nM),selector:n_}),nE=rp.object({resourceCoords:nt}),nP=rp.object({type:rp.literal("FeatureCollection"),transformation:nn.optional(),features:rp.array(rp.object({type:rp.literal("Feature"),properties:nE,geometry:nr}))}),nS=rp.object({id:rp.string().optional(),type:rp.literal("Annotation"),"@context":na.optional(),motivation:rp.string().default("georeferencing").optional(),created:rp.string().datetime().optional(),modified:rp.string().datetime().optional(),target:nT,body:nP}),nR=rp.object({id:rp.string().optional(),type:rp.literal("AnnotationPage"),"@context":na.optional(),items:rp.array(nS)});function nI(e){return Array.isArray(e)}function nC(e){return!!(e&&"object"==typeof e&&"type"in e&&"GeoreferencedMap"===e.type)}function nA(e){return!!(e&&"object"==typeof e&&"target"in e&&e.target&&"object"==typeof e.target&&"source"in e.target&&"string"==typeof e.target.source)}function nL(e){return"type"in e&&"GeoreferencedMap"===e.type}function nj(e){return"source"in e.target&&"object"==typeof e.target.source}function nk(e){var t;return{"@context":"https://schemas.allmaps.org/map/2/context.json",type:"GeoreferencedMap",id:e.id,...function(e){if(nj(e))return{created:e.created,modified:e.modified}}(e),resource:{id:function(e){if(!nj(e))return e.target.service[0]["@id"];{let t=e.target.source;return"id"in t?t.id:t["@id"]}}(e),...function(e){if(nj(e))return{width:e.target.source.width,height:e.target.source.height};let t=e.target.selector.value,r=/width="(?<width>\d+)"/.exec(t),i=/height="(?<height>\d+)"/.exec(t),o=r?.groups?.width,s=i?.groups?.height;if(!o||!s)throw Error("Could not parse image dimensions");return{width:parseInt(o),height:parseInt(s)}}(e),type:"service"in(t=e).target?t.target.service[0].type:t.target.source.type,partOf:function(e){if(nj(e))return e.target.source.partOf}(e)},gcps:e.body.features.map(e=>{var t;return{resource:"pixelCoords"in(t=e.properties)?t.pixelCoords:t.resourceCoords,geo:e.geometry.coordinates}}),resourceMask:function(e){let t=e.target.selector.value,r=/points="(?<points>.+)"/.exec(t)?.groups;if(r&&r.points){let e=r.points.trim().split(/\s+/);if(e[0]===e[e.length-1]&&e.splice(-1),e.length>=3)return e.map(e=>{let t=e.split(",");if(2===t.length)return[parseFloat(t[0]),parseFloat(t[1])];throw Error("Could not parse resource mask")})}throw Error("Could not parse resource mask")}(e),transformation:e.body.transformation}}function nF(e){if(!(e&&"object"==typeof e&&"type"in e&&"AnnotationPage"===e.type)){let t;return[nk(nA(e)?nd.parse(e):nS.parse(e))]}{let t;return("items"in e&&Array.isArray(e.items)&&nA(e.items[0])?np.parse(e):nR.parse(e)).items.map(e=>nk(e))}}nd.or(nS),np.or(nR),nu.or(nE);let nO=rp.object({image:nt,world:nt}),nD=rp.object({uri:rp.string().url(),width:rp.number(),height:rp.number(),type:no}),nG=rp.object({id:rp.string().optional(),version:rp.number().min(1).max(1).default(1),image:nD,gcps:nO.array(),pixelMask:ni,transformation:nn.optional()}),nN=rp.array(nG),nz=rp.object({resource:nt,geo:nt}),nB=rp.object({id:rp.string().url(),width:rp.number(),height:rp.number(),type:no,partOf:ns.array().optional()}),nU=rp.object({"@context":rp.literal("https://schemas.allmaps.org/map/2/context.json").optional(),type:rp.literal("GeoreferencedMap"),id:rp.string().optional(),created:rp.string().datetime().optional(),modified:rp.string().datetime().optional(),resource:nB,gcps:nz.array(),resourceMask:ni,transformation:nn.optional()}),nV=rp.array(nU);function nW(e){let t,r,i,o,s,n,a,l,h={type:"SpecificResource",source:(nL(e)?(t=e.resource.id,r=e.resource.type,i=e.resource.width,o=e.resource.height,s=e.resource.partOf):(t=e.image.uri,r=e.image.type,i=e.image.width,o=e.image.height),{id:t,type:r,height:o,width:i,partOf:s}),selector:(nL(e)?(n=e.resource.width,a=e.resource.height,l=e.resourceMask):(n=e.image.width,a=e.image.height,l=e.pixelMask),{type:"SvgSelector",value:`<svg width="${n}" height="${a}"><polygon points="${l.map(e=>e.join(",")).join(" ")}" /></svg>`})},u={type:"FeatureCollection",transformation:e.transformation,features:e.gcps.map(e=>{let t,r;return"resource"in e?(t=e.resource,r=e.geo):(t=e.image,r=e.world),{type:"Feature",properties:{resourceCoords:t},geometry:{type:"Point",coordinates:r}}})};return{id:e.id,type:"Annotation","@context":["http://iiif.io/api/extension/georef/1/context.json","http://iiif.io/api/presentation/3/context.json"],...function(e){if(nL(e))return{created:e.created,modified:e.modified}}(e),motivation:"georeferencing",target:h,body:u}}function nZ(e){return nL(e)?e:nF(function(e){if(nI(e)){let t;return{type:"AnnotationPage","@context":"http://www.w3.org/ns/anno.jsonld",items:(nC(e[0])?nV.parse(e):nN.parse(e)).map(e=>nW(e))}}{let t;return nW(nC(e)?nU.parse(e):nG.parse(e))}}(e))[0]}function nq(e){if(nI(e)){let t;return(nC(e[0])?nV.parse(e):nN.parse(e)).map(nZ)}{let t;return nZ(nC(e)?nU.parse(e):nG.parse(e))}}function n$(e,t,r){var i=e[t];e[t]=e[r],e[r]=i}function nX(e,t){return e<t?-1:+(e>t)}nG.or(nU),nN.or(nV),nO.or(nz);class nH{constructor(e=9){this._maxEntries=Math.max(4,e),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()}all(){return this._all(this.data,[])}search(e){let t=this.data,r=[];if(!n4(e,t))return r;let i=this.toBBox,o=[];for(;t;){for(let s=0;s<t.children.length;s++){let n=t.children[s],a=t.leaf?i(n):n;n4(e,a)&&(t.leaf?r.push(n):n3(e,a)?this._all(n,r):o.push(n))}t=o.pop()}return r}collides(e){let t=this.data;if(!n4(e,t))return!1;let r=[];for(;t;){for(let i=0;i<t.children.length;i++){let o=t.children[i],s=t.leaf?this.toBBox(o):o;if(n4(e,s)){if(t.leaf||n3(e,s))return!0;r.push(o)}}t=r.pop()}return!1}load(e){if(!(e&&e.length))return this;if(e.length<this._minEntries){for(let t=0;t<e.length;t++)this.insert(e[t]);return this}let t=this._build(e.slice(),0,e.length-1,0);if(this.data.children.length)if(this.data.height===t.height)this._splitRoot(this.data,t);else{if(this.data.height<t.height){let e=this.data;this.data=t,t=e}this._insert(t,this.data.height-t.height-1,!0)}else this.data=t;return this}insert(e){return e&&this._insert(e,this.data.height-1),this}clear(){return this.data=n5([]),this}remove(e,t){let r,i,o;if(!e)return this;let s=this.data,n=this.toBBox(e),a=[],l=[];for(;s||a.length;){if(s||(s=a.pop(),i=a[a.length-1],r=l.pop(),o=!0),s.leaf){let r=function(e,t,r){if(!r)return t.indexOf(e);for(let i=0;i<t.length;i++)if(r(e,t[i]))return i;return -1}(e,s.children,t);if(-1!==r)return s.children.splice(r,1),a.push(s),this._condense(a),this}!o&&!s.leaf&&n3(s,n)?(a.push(s),l.push(r),r=0,i=s,s=s.children[0]):i?(r++,s=i.children[r],o=!1):s=null}return this}toBBox(e){return e}compareMinX(e,t){return e.minX-t.minX}compareMinY(e,t){return e.minY-t.minY}toJSON(){return this.data}fromJSON(e){return this.data=e,this}_all(e,t){let r=[];for(;e;)e.leaf?t.push(...e.children):r.push(...e.children),e=r.pop();return t}_build(e,t,r,i){let o=r-t+1,s=this._maxEntries,n;if(o<=s)return nY(n=n5(e.slice(t,r+1)),this.toBBox),n;i||(i=Math.ceil(Math.log(o)/Math.log(s)),s=Math.ceil(o/Math.pow(s,i-1))),(n=n5([])).leaf=!1,n.height=i;let a=Math.ceil(o/s),l=a*Math.ceil(Math.sqrt(s));n9(e,t,r,l,this.compareMinX);for(let o=t;o<=r;o+=l){let t=Math.min(o+l-1,r);n9(e,o,t,a,this.compareMinY);for(let r=o;r<=t;r+=a){let o=Math.min(r+a-1,t);n.children.push(this._build(e,r,o,i-1))}}return nY(n,this.toBBox),n}_chooseSubtree(e,t,r,i){for(;i.push(t),!(t.leaf||i.length-1===r);){let r=1/0,i=1/0,n;for(let a=0;a<t.children.length;a++){var o,s;let l=t.children[a],h=n1(l),u=(o=e,(Math.max((s=l).maxX,o.maxX)-Math.min(s.minX,o.minX))*(Math.max(s.maxY,o.maxY)-Math.min(s.minY,o.minY))-h);u<i?(i=u,r=h<r?h:r,n=l):u===i&&h<r&&(r=h,n=l)}t=n||t.children[0]}return t}_insert(e,t,r){let i=r?e:this.toBBox(e),o=[],s=this._chooseSubtree(i,this.data,t,o);for(s.children.push(e),nJ(s,i);t>=0&&o[t].children.length>this._maxEntries;)this._split(o,t),t--;this._adjustParentBBoxes(i,o,t)}_split(e,t){let r=e[t],i=r.children.length,o=this._minEntries;this._chooseSplitAxis(r,o,i);let s=this._chooseSplitIndex(r,o,i),n=n5(r.children.splice(s,r.children.length-s));n.height=r.height,n.leaf=r.leaf,nY(r,this.toBBox),nY(n,this.toBBox),t?e[t-1].children.push(n):this._splitRoot(r,n)}_splitRoot(e,t){this.data=n5([e,t]),this.data.height=e.height+1,this.data.leaf=!1,nY(this.data,this.toBBox)}_chooseSplitIndex(e,t,r){let i,o=1/0,s=1/0;for(let n=t;n<=r-t;n++){let t=nK(e,0,n,this.toBBox),a=nK(e,n,r,this.toBBox),l=function(e,t){let r=Math.max(e.minX,t.minX),i=Math.max(e.minY,t.minY);return Math.max(0,Math.min(e.maxX,t.maxX)-r)*Math.max(0,Math.min(e.maxY,t.maxY)-i)}(t,a),h=n1(t)+n1(a);l<o?(o=l,i=n,s=h<s?h:s):l===o&&h<s&&(s=h,i=n)}return i||r-t}_chooseSplitAxis(e,t,r){let i=e.leaf?this.compareMinX:nQ,o=e.leaf?this.compareMinY:n0;this._allDistMargin(e,t,r,i)<this._allDistMargin(e,t,r,o)&&e.children.sort(i)}_allDistMargin(e,t,r,i){e.children.sort(i);let o=this.toBBox,s=nK(e,0,t,o),n=nK(e,r-t,r,o),a=n2(s)+n2(n);for(let i=t;i<r-t;i++){let t=e.children[i];nJ(s,e.leaf?o(t):t),a+=n2(s)}for(let i=r-t-1;i>=t;i--){let t=e.children[i];nJ(n,e.leaf?o(t):t),a+=n2(n)}return a}_adjustParentBBoxes(e,t,r){for(let i=r;i>=0;i--)nJ(t[i],e)}_condense(e){for(let t=e.length-1,r;t>=0;t--)0===e[t].children.length?t>0?(r=e[t-1].children).splice(r.indexOf(e[t]),1):this.clear():nY(e[t],this.toBBox)}}function nY(e,t){nK(e,0,e.children.length,t,e)}function nK(e,t,r,i,o){o||(o=n5(null)),o.minX=1/0,o.minY=1/0,o.maxX=-1/0,o.maxY=-1/0;for(let s=t;s<r;s++){let t=e.children[s];nJ(o,e.leaf?i(t):t)}return o}function nJ(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function nQ(e,t){return e.minX-t.minX}function n0(e,t){return e.minY-t.minY}function n1(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function n2(e){return e.maxX-e.minX+(e.maxY-e.minY)}function n3(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function n4(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function n5(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function n9(e,t,r,i,o){let s=[t,r];for(;s.length;){if((r=s.pop())-(t=s.pop())<=i)continue;let n=t+Math.ceil((r-t)/i/2)*i;(function e(t,r,i,o,s){for(;o>i;){if(o-i>600){var n=o-i+1,a=r-i+1,l=Math.log(n),h=.5*Math.exp(2*l/3),u=.5*Math.sqrt(l*h*(n-h)/n)*(a-n/2<0?-1:1),c=Math.max(i,Math.floor(r-a*h/n+u)),d=Math.min(o,Math.floor(r+(n-a)*h/n+u));e(t,r,c,d,s)}var p=t[r],f=i,m=o;for(n$(t,i,r),s(t[o],p)>0&&n$(t,i,o);f<m;){for(n$(t,f,m),f++,m--;0>s(t[f],p);)f++;for(;s(t[m],p)>0;)m--}0===s(t[i],p)?n$(t,i,m):n$(t,++m,o),m<=r&&(i=m+1),r<=m&&(o=m-1)}})(e,n,t||0,r||e.length-1,o||nX),s.push(t,n,n,r)}}function n6(e,t,r){var i=!1;t[0][0]===t[t.length-1][0]&&t[0][1]===t[t.length-1][1]&&(t=t.slice(0,t.length-1));for(var o=0,s=t.length-1;o<t.length;s=o++){var n=t[o][0],a=t[o][1],l=t[s][0],h=t[s][1];if(e[1]*(n-l)+a*(l-e[0])+h*(e[0]-n)==0&&(n-e[0])*(l-e[0])<=0&&(a-e[1])*(h-e[1])<=0)return!r;a>e[1]!=h>e[1]&&e[0]<(l-n)*(e[1]-a)/(h-a)+n&&(i=!i)}return i}class n8{rbush=new nH;polygonsById=new Map;bboxesById=new Map;itemsById=new Map;addItem(e,t){this.removeItem(e);let r=H(t),i={minX:r[0],minY:r[1],maxX:r[2],maxY:r[3],id:e};this.polygonsById.set(e,t),this.bboxesById.set(e,r),this.itemsById.set(e,i),this.rbush.insert(i)}removeItem(e){let t=this.itemsById.get(e);t&&(this.rbush.remove(t),this.polygonsById.delete(e),this.bboxesById.delete(e),this.itemsById.delete(e))}clear(){this.polygonsById.clear(),this.bboxesById.clear(),this.itemsById.clear(),this.rbush.clear()}search(e,t,r,i){return this.rbush.search({minX:e,minY:t,maxX:r,maxY:i})}getBbox(e){return this.bboxesById.get(e)}getPolygon(e){return this.polygonsById.get(e)}searchFromBbox(e){let[t,r,i,o]=e;return this.search(t,r,i,o).map(e=>e.id)}searchFromPoint(e,t=!0){let[r,i,o,s]=[e[0],e[1],e[0],e[1]],n=this.search(r,i,o,s);return t?n.filter(t=>{let r=this.polygonsById.get(t.id);return!!r&&function(e,t,r){if(void 0===r&&(r={}),!e)throw Error("point is required");if(!t)throw Error("polygon is required");var i,o,s=iu(e),n="Feature"===t.type?t.geometry:t,a=n.type,l=t.bbox,h=n.coordinates;if(l&&!1==(i=s,(o=l)[0]<=i[0]&&o[1]<=i[1]&&o[2]>=i[0]&&o[3]>=i[1]))return!1;"Polygon"===a&&(h=[h]);for(var u=!1,c=0;c<h.length&&!u;c++)if(n6(s,h[c][0],r.ignoreBoundary)){for(var d=!1,p=1;p<h[c].length&&!d;)n6(s,h[c][p],!r.ignoreBoundary)&&(d=!0),p++;d||(u=!0)}return u}(e,r)}).map(e=>e.id):n.map(e=>e.id)}}class n7 extends EventTarget{warpedMapFactory;warpedMapsById=new Map;zIndices=new Map;rtree;imageInformations;transformation;fetchFn;constructor(e,t){super(),this.warpedMapFactory=e,t={...{createRTree:!0,imageInformations:new Map},...t},this.fetchFn=t?.fetchFn,this.imageInformations=t.imageInformations,this.transformation=t.transformation,t.createRTree&&(this.rtree=new n8)}getMapIds(){return this.warpedMapsById.keys()}getWarpedMaps(e){if(void 0===e)return this.warpedMapsById.values();{let t=[];for(let r of e){let e=this.warpedMapsById.get(r);e&&t.push(e)}return t}}getWarpedMap(e){return this.warpedMapsById.get(e)}getMapZIndex(e){return this.zIndices.get(e)}getCenter(){let e=this.getBbox();if(e)return ee(e)}getProjectedCenter(){let e=this.getProjectedBbox();if(e)return ee(e)}getBbox(){let e;for(let t of this.getWarpedMaps())t.visible&&(e=e?Y(e,t.geoMaskBbox):t.geoMaskBbox);return e}getProjectedBbox(){let e;for(let t of this.getWarpedMaps())t.visible&&(e=e?Y(e,t.projectedGeoMaskBbox):t.projectedGeoMaskBbox);return e}getMapsByGeoBbox(e){return this.rtree?this.rtree.searchFromBbox(e):Array.from(this.warpedMapsById.keys())}setImageInformations(e){this.imageInformations=e}setMapResourceMask(e,t){let r=this.warpedMapsById.get(e);r&&(r.setResourceMask(t),this.addToOrUpdateRtree(r),this.dispatchEvent(new oE(oT.RESOURCEMASKUPDATED,e)))}setMapsTransformationType(e,t){let r=[];for(let i of e){let e=this.warpedMapsById.get(i);e&&e.transformationType!=t&&r.push(i)}r.length>0&&(this.dispatchEvent(new oE(oT.PRECHANGE,r)),r.forEach(e=>{let r=this.warpedMapsById.get(e);r&&(r.setTransformationType(t),this.addToOrUpdateRtree(r))}),this.dispatchEvent(new oE(oT.TRANSFORMATIONCHANGED,r)))}setMapsDistortionMeasure(e,t){let r=[];for(let i of e){let e=this.warpedMapsById.get(i);e&&e.distortionMeasure!=t&&r.push(i)}r.length>0&&(this.dispatchEvent(new oE(oT.PRECHANGE,r)),r.forEach(e=>{let r=this.warpedMapsById.get(e);r&&(r.setDistortionMeasure(t),this.addToOrUpdateRtree(r))}),this.dispatchEvent(new oE(oT.DISTORTIONCHANGED,r)))}bringMapsToFront(e){let t=this.warpedMapsById.size;for(let r of e)this.zIndices.has(r)&&(this.zIndices.set(r,t),t++);this.removeZIndexHoles(),this.dispatchEvent(new oE(oT.ZINDICESCHANGED))}sendMapsToBack(e){let t=-Array.from(e).length;for(let r of e)this.zIndices.has(r)&&(this.zIndices.set(r,t),t++);this.removeZIndexHoles(),this.dispatchEvent(new oE(oT.ZINDICESCHANGED))}bringMapsForward(e){for(let[e,t]of this.zIndices.entries())this.zIndices.set(e,2*t);for(let t of e){let e=this.zIndices.get(t);void 0!==e&&this.zIndices.set(t,e+3)}this.removeZIndexHoles(),this.dispatchEvent(new oE(oT.ZINDICESCHANGED))}sendMapsBackward(e){for(let[e,t]of this.zIndices.entries())this.zIndices.set(e,2*t);for(let t of e){let e=this.zIndices.get(t);void 0!==e&&this.zIndices.set(t,e-3)}this.removeZIndexHoles(),this.dispatchEvent(new oE(oT.ZINDICESCHANGED))}showMaps(e){for(let t of e){let e=this.warpedMapsById.get(t);e&&(e.visible=!0)}this.dispatchEvent(new oE(oT.VISIBILITYCHANGED,e))}hideMaps(e){for(let t of e){let e=this.warpedMapsById.get(t);e&&(e.visible=!1)}this.dispatchEvent(new oE(oT.VISIBILITYCHANGED,e))}async addGeoreferencedMap(e){let t=nq(e),r=Array.isArray(t)?t[0]:t;return this.addGeoreferencedMapInternal(r)}async removeGeoreferencedMap(e){let t=nq(e),r=Array.isArray(t)?t[0]:t;return this.removeGeoreferencedMapInternal(r)}async addGeoreferenceAnnotation(e){let t=[],r=nF(e);for(let e of(await Promise.allSettled(r.map(e=>this.addGeoreferencedMapInternal(e)))))"fulfilled"===e.status?t.push(e.value):t.push(e.reason);return this.dispatchEvent(new oE(oT.GEOREFERENCEANNOTATIONADDED)),this.dispatchEvent(new oE(oT.ZINDICESCHANGED)),t}async removeGeoreferenceAnnotation(e){let t=[];for(let r of nF(e)){let e=await this.removeGeoreferencedMapInternal(r);t.push(e)}return this.dispatchEvent(new oE(oT.GEOREFERENCEANNOTATIONREMOVED)),t}clear(){this.warpedMapsById=new Map,this.zIndices=new Map,this.rtree?.clear(),this.dispatchEvent(new oE(oT.CLEARED))}destroy(){for(let e of this.getWarpedMaps())this.removeEventListenersFromWarpedMap(e),e.destroy();this.clear()}async addGeoreferencedMapInternal(e){let t=await this.getOrComputeMapId(e),r=this.warpedMapFactory(t,e,{imageInformations:this.imageInformations,fetchFn:this.fetchFn,transformation:this.transformation});return this.warpedMapsById.set(t,r),this.zIndices.set(t,this.warpedMapsById.size-1),this.addToOrUpdateRtree(r),this.addEventListenersToWarpedMap(r),this.dispatchEvent(new oE(oT.WARPEDMAPADDED,t)),t}async removeGeoreferencedMapInternal(e){let t=await this.getOrComputeMapId(e),r=this.warpedMapsById.get(t);if(r)this.warpedMapsById.delete(t),this.zIndices.delete(t),this.removeFromRtree(r),this.dispatchEvent(new oE(oT.WARPEDMAPREMOVED,t)),this.removeZIndexHoles(),this.dispatchEvent(new oE(oT.ZINDICESCHANGED)),r.destroy();else throw Error(`No map found with ID ${t}`);return t}async getOrComputeMapId(e){return e.id||await eR(e)}addToOrUpdateRtree(e){this.rtree&&(this.rtree.removeItem(e.mapId),this.rtree.addItem(e.mapId,e.geoMask))}removeFromRtree(e){this.rtree&&this.rtree.removeItem(e.mapId)}removeZIndexHoles(){let e=[...this.zIndices.entries()].sort((e,t)=>e[1]-t[1]),t=0;for(let r of e){let e=r[0];this.zIndices.set(e,t),t++}}imageInfoLoaded(){this.dispatchEvent(new oE(oT.IMAGEINFOLOADED))}addEventListenersToWarpedMap(e){e.addEventListener(oT.IMAGEINFOLOADED,this.imageInfoLoaded.bind(this))}removeEventListenersFromWarpedMap(e){e.removeEventListener(oT.IMAGEINFOLOADED,this.imageInfoLoaded.bind(this))}}class ae extends EventTarget{tile;imageRequest;tileUrl;tileKey;fetchFn;abortController;data;constructor(e,t){super(),this.tile=e.tile,this.imageRequest=e.imageRequest,this.tileUrl=e.tileUrl,this.tileKey=e.tileKey,this.fetchFn=t,this.abortController=new AbortController}isCachedTile(){return void 0!==this.data}abort(){this.abortController.signal.aborted||this.abortController.abort()}}class at{mapId;tile;imageRequest;tileUrl;tileKey;fetchableTileKey;constructor(e,t){this.mapId=t.mapId,this.tile=e;let r=t.parsedImage.getIiifTile(e.tileZoomLevel,e.column,e.row);this.imageRequest=r,this.tileUrl=t.parsedImage.getImageUrl(r),this.tileKey=s2(e),this.fetchableTileKey=function(e){var t,r;return t=e.mapId,r=e.tileUrl,`${t}:${r}`}(this)}}class ar extends ae{async fetch(){try{let e=await (await l(this.tileUrl,{signal:this.abortController.signal},this.fetchFn)).blob();this.data=await createImageBitmap(e,0,0,this.tile.tileZoomLevel.width,this.tile.tileZoomLevel.height),this.dispatchEvent(new oE(oT.TILEFETCHED,this.tileUrl))}catch(e){e instanceof Error&&"AbortError"===e.name||this.dispatchEvent(new oE(oT.TILEFETCHERROR,this.tileUrl))}return this.data}static createFactory(){return(e,t)=>new ar(e,t)}}let ai=class extends EventTarget{cachableTileFactory;fetchFn;tilesByTileUrl=new Map;mapIdsByTileUrl=new Map;tileUrlsByMapId=new Map;tilesFetchingCount=0;fetchableTiles=[];constructor(e,t){super(),this.cachableTileFactory=e,this.fetchFn=t?.fetchFn}getCacheableTiles(){return this.tilesByTileUrl.values()}getCacheableTile(e){return this.tilesByTileUrl.get(e)}getMapCacheableTiles(e){let t=[];for(let r of this.tilesByTileUrl.values())this.tileUrlsByMapId.get(e)?.has(r.tileUrl)&&t.push(r);return t}getCachedTiles(){let e=[];for(let t of this.tilesByTileUrl.values())t.isCachedTile()&&e.push(t);return e}getCachedTile(e){let t=this.tilesByTileUrl.get(e);if(t&&t.isCachedTile())return t}getMapCachedTiles(e){let t=[];for(let r of this.tilesByTileUrl.values())r.isCachedTile()&&this.tileUrlsByMapId.get(e)?.has(r.tileUrl)&&t.push(r);return t}getTileUrls(){return this.tilesByTileUrl.keys()}getMapTileUrls(e){return this.tileUrlsByMapId.get(e)||new Set}requestFetchableTiles(e){let t=new Set(this.fetchableTiles.map(e=>e.fetchableTileKey)),r=new Set(e.map(e=>e.fetchableTileKey));if(!(t&&r&&t.size===r.size&&[...t].every(e=>r.has(e)))){for(let t of e)this.requestFetchableTile(t);this.fetchableTiles=e}}async allRequestedTilesLoaded(){return new Promise(e=>{if(this.finished)e();else{let t=()=>{this.removeEventListener(oT.ALLREQUESTEDTILESLOADED,t),e()};this.addEventListener(oT.ALLREQUESTEDTILESLOADED,t)}})}prune(e){for(let[t,r]of this.mapIdsByTileUrl.entries())for(let i of r){let r=e.get(i),o=this.tilesByTileUrl.get(t)?.tile;o&&(!r||function(e,t,r){if(t.currentOverviewTileZoomLevel&&e.tileZoomLevel.scaleFactor==t.currentOverviewTileZoomLevel.scaleFactor)return!1;if(null==t.currentResourceViewportRingBbox||null==t.currentTileZoomLevel)return!0;let i=Math.log2(e.tileZoomLevel.scaleFactor)-Math.log2(t.currentTileZoomLevel.scaleFactor);return i>r.maxHigherLog2ScaleFactorDiff||-i>r.maxLowerLog2ScaleFactorDiff||!function(e,t){let r=e[2]>=t[0]&&t[2]>=e[0],i=e[3]>=t[1]&&t[3]>=e[1];return r&&i}(K(s1(e),Math.max(0,i)),t.currentResourceViewportRingBbox)}(o,r,{maxHigherLog2ScaleFactorDiff:4,maxLowerLog2ScaleFactorDiff:2}))&&this.removeCacheableTileForMapId(t,i)}}clear(){for(let e of this.getCacheableTiles())e.abort(),this.removeEventListenersFromCacheableTile(e);this.tilesByTileUrl=new Map,this.mapIdsByTileUrl=new Map,this.tileUrlsByMapId=new Map,this.tilesFetchingCount=0}destroy(){this.clear()}requestFetchableTile(e){let t=e.mapId,r=e.tileUrl;if(this.tilesByTileUrl.has(r))this.tilesByTileUrl.get(r)?.isCachedTile()&&this.dispatchEvent(new oE(oT.MAPTILELOADED,{mapId:t,tileUrl:r}));else{let t=this.cachableTileFactory(e,this.fetchFn);this.addEventListenersToCacheableTile(t),this.addCacheableTile(t)}this.addTileUrlForMapId(r,t),this.addMapIdForTileUrl(t,r)}addCacheableTile(e){this.tilesByTileUrl.set(e.tileUrl,e),e.fetch(),this.updateTilesFetchingCount(1)}removeCacheableTileForMapId(e,t){let r=this.tilesByTileUrl.get(e);if(!r)return;let i=this.removeMapIdForTileUrl(t,e);this.removeTileUrlForMapId(e,t),i.size||(r.isCachedTile()||(r.abort(),this.updateTilesFetchingCount(-1)),this.tilesByTileUrl.delete(e)),this.dispatchEvent(new oE(oT.MAPTILEREMOVED,{mapId:t,tileUrl:e}))}tileFetched(e){if(e instanceof oE){let t=e.data;for(let e of(this.updateTilesFetchingCount(-1),this.mapIdsByTileUrl.get(t)||[]))this.dispatchEvent(new oE(oT.MAPTILELOADED,{mapId:e,tileUrl:t})),this.tileUrlsByMapId.get(e)?.values().next().value===t&&this.dispatchEvent(new oE(oT.FIRSTMAPTILELOADED,{mapId:e,tileUrl:t}))}}tileFetchError(e){if(e instanceof oE){let t=e.data;this.tilesByTileUrl.has(t)||this.updateTilesFetchingCount(-1)}}addMapIdForTileUrl(e,t){let r=this.mapIdsByTileUrl.get(t);return r?r.add(e):r=new Set([e]),this.mapIdsByTileUrl.set(t,r),r}removeMapIdForTileUrl(e,t){let r=this.mapIdsByTileUrl.get(t);return r?(r.delete(e),r.size?this.mapIdsByTileUrl.set(t,r):this.mapIdsByTileUrl.delete(t),r):new Set}addTileUrlForMapId(e,t){let r=this.tileUrlsByMapId.get(t);return r?r.add(e):r=new Set([e]),this.tileUrlsByMapId.set(t,r),r}removeTileUrlForMapId(e,t){let r=this.tileUrlsByMapId.get(t);return r?(r.delete(e),r.size?this.tileUrlsByMapId.set(t,r):this.tileUrlsByMapId.delete(t),r):new Set}get finished(){return 0===this.tilesFetchingCount}updateTilesFetchingCount(e){this.tilesFetchingCount+=e,0===this.tilesFetchingCount&&this.dispatchEvent(new oE(oT.ALLREQUESTEDTILESLOADED))}addEventListenersToCacheableTile(e){e.addEventListener(oT.TILEFETCHED,this.tileFetched.bind(this)),e.addEventListener(oT.TILEFETCHERROR,this.tileFetchError.bind(this))}removeEventListenersFromCacheableTile(e){e.removeEventListener(oT.TILEFETCHED,this.tileFetched.bind(this)),e.removeEventListener(oT.TILEFETCHERROR,this.tileFetchError.bind(this))}};class ao extends EventTarget{warpedMapList;tileCache;mapsInViewport=new Set;mapsWithRequestedTilesForViewport=new Set;viewport;constructor(e,t,r){super(),this.tileCache=new ai(e,r),this.warpedMapList=new n7(t,r)}async addGeoreferenceAnnotation(e){return this.warpedMapList.addGeoreferenceAnnotation(e)}async addGeoreferencedMap(e){return this.warpedMapList.addGeoreferencedMap(e)}loadMissingImageInfosInViewport(){return this.viewport?Array.from(this.warpedMapList.getMapsByGeoBbox(this.viewport.geoRectangleBbox)).map(e=>this.warpedMapList.getWarpedMap(e)).filter(e=>!e.hasImageInfo()&&!e.loadingImageInfo).map(e=>e.loadImageInfo()):[]}someImageInfosInViewport(){return!!this.viewport&&Array.from(this.findMapsInViewport(10*!!this.shouldAnticipateInteraction())).map(e=>this.warpedMapList.getWarpedMap(e)).map(e=>e.hasImageInfo()).some(Boolean)}shouldRequestFetchableTiles(){return!0}shouldAnticipateInteraction(){return!1}requestFetchableTiles(){if(!this.shouldRequestFetchableTiles())return;let e=[],t=[],r=this.findMapsInViewport((this.shouldAnticipateInteraction(),0)),i=this.findMapsInViewport(2*!!this.shouldAnticipateInteraction()),o=this.findMapsInViewport(4*!!this.shouldAnticipateInteraction()),s=this.findMapsInViewport(10*!!this.shouldAnticipateInteraction());for(let e of this.warpedMapList.getWarpedMaps())e.resetCurrent();for(let t of o)e.push(...this.getMapFetchableTilesForViewport(t,r));if(this.shouldAnticipateInteraction())for(let r of s)t.push(...this.getMapOverviewFetchableTilesForViewport(r,[...e,...t],i));this.tileCache.requestFetchableTiles([...e,...t]),this.updateMapsForViewport([...e,...t]),this.pruneTileCache(s)}findMapsInViewport(e=0){if(!this.viewport)return new Set;let t=this.viewport,r=H(this.viewport.getProjectedGeoBufferedRectangle(e).map(e=>eT(e)));return new Set(Array.from(this.warpedMapList.getMapsByGeoBbox(r)).sort((e,r)=>{let i=this.warpedMapList.getWarpedMap(e),o=this.warpedMapList.getWarpedMap(r);return i&&o?A(ee(i.geoMaskBbox),t.geoCenter)-A(ee(o.geoMaskBbox),t.geoCenter):0}))}getMapFetchableTilesForViewport(e,t){if(!this.viewport)return[];let r=this.viewport,i=this.warpedMapList.getWarpedMap(e);if(!i||!i.visible||!i.hasImageInfo()||5>C(Q(i.getViewportMaskBbox(r))))return[];let o=function(e,t,r,i){let o=Number.POSITIVE_INFINITY,s=e.at(-1);for(let r of e){let e=Math.abs(Math.log2(r.scaleFactor)-(Math.log2(t+0)+.4));e<o&&(o=e,s=r)}return s}(i.parsedImage.tileZoomLevels,i.getResourceToCanvasScale(r),0,0);i.setCurrentTileZoomLevel(o),i.setCurrentBestScaleFactor(o.scaleFactor);let s=i.projectedTransformer.transformBackward([r.getProjectedGeoBufferedRectangle((this.shouldAnticipateInteraction(),0))],{maxDepth:0,sourceIsGeographic:!1,destinationIsGeographic:!0})[0];if(i.setCurrentResourceViewportRing(s),!t.has(e))return[];let n=(function(e,t,r){var i,o;let s=function(e,t,r){let i=[];for(let o in e){let s=parseInt(o);if(s<0||s>=t.columns)break;let n=Math.max(e[s][0],0),a=Math.min(e[s][1],t.rows-1);for(let e=n;e<=a;e++)i.push({column:s,row:e,tileZoomLevel:t,imageSize:r})}return i}(function(e){let t={};for(let r=0;r<e.length;r++)(function([e,t]){let r=Math.floor(e[0]),i=Math.floor(e[1]),o=Math.floor(t[0]),s=Math.floor(t[1]),n=[[r,i]];if(r===o&&i===s)return n;let a=Math.sign(t[0]-e[0]),l=Math.sign(t[1]-e[1]),h=Math.abs(e[0]-r-Math.max(0,a)),u=Math.abs(e[1]-i-Math.max(0,l)),c=Math.abs(e[0]-t[0]),d=Math.abs(e[1]-t[1]),p=h/c,f=u/d,m=1/c,g=1/d;for(;r!==o||i!==s;)p<f?(p+=m,r+=a):(f+=g,i+=l),n.push([r,i]);return n})([e[r],e[(r+1)%e.length]]).forEach(([e,r])=>{t[e]||(t[e]=[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY]),r<t[e][0]&&(t[e][0]=r),r>t[e][1]&&(t[e][1]=r)});return t}((i=e,o=t,i.map(e=>[e[0]/o.originalWidth,e[1]/o.originalHeight]))),t,r),n=ee(H(e));return s.sort((e,t)=>{var r,i,o,s;return r=e,i=n,A(s0(r),i)-(o=t,s=n,A(s0(o),s))}),s})(s,o,[i.parsedImage.width,i.parsedImage.height]).map(e=>new at(e,i));return i.setCurrentFetchableTiles(n),n}getMapOverviewFetchableTilesForViewport(e,t,r){if(!this.viewport)return[];let i=this.warpedMapList.getWarpedMap(e);if(!i||!i.visible||!i.hasImageInfo()||t.map(e=>e.tile).map(e=>e.tileZoomLevel.width*e.tileZoomLevel.height).reduce((e,t)=>e+t,0)>10*this.viewport.canvasResolution)return[];let o=i.parsedImage.tileZoomLevels.filter(e=>e.rows*e.width*e.columns*e.height<=1048576).sort((e,t)=>e.scaleFactor-t.scaleFactor).at(-1);if(i.setCurrentOverviewTileZoomLevel(o),!r.has(e)||!o||i.currentTileZoomLevel&&o.scaleFactor<=i.currentTileZoomLevel.scaleFactor)return[];let s=sQ(o.scaleFactor,i.parsedImage).map(e=>new at(e,i));return i.setCurrentOverviewFetchableTiles(s),s}updateMapsForViewport(e){this.mapsWithRequestedTilesForViewport=new Set(e.map(e=>e.mapId).filter((e,t,r)=>r.indexOf(e)===t).sort((e,t)=>{let r=this.warpedMapList.getMapZIndex(e),i=this.warpedMapList.getMapZIndex(t);return void 0!==r&&void 0!==i?r-i:0})),this.mapsInViewport=this.findMapsInViewport();let t=Array.from(this.mapsInViewport),r=Array.from(this.mapsInViewport),i=r.filter(e=>!t.includes(e)),o=t.filter(e=>!r.includes(e));for(let e of i)this.dispatchEvent(new oE(oT.WARPEDMAPENTER,e));for(let e of o)this.clearMap(e),this.dispatchEvent(new oE(oT.WARPEDMAPLEAVE,e))}pruneTileCache(e){let t=new Map;for(let r of this.warpedMapList.getWarpedMaps(e))t.set(r.mapId,{currentTileZoomLevel:r.currentTileZoomLevel,currentOverviewTileZoomLevel:r.currentOverviewTileZoomLevel,currentResourceViewportRingBbox:r.currentResourceViewportRingBbox});this.tileCache.prune(t)}destroy(){this.tileCache.destroy(),this.warpedMapList.destroy()}clearMap(e){}mapTileLoaded(e){}mapTileRemoved(e){}imageInfoLoaded(e){}warpedMapAdded(e){}warpedMapRemoved(e){}preChange(e){}transformationChanged(e){}distortionChanged(e){}addEventListeners(){this.tileCache.addEventListener(oT.MAPTILELOADED,this.mapTileLoaded.bind(this)),this.tileCache.addEventListener(oT.MAPTILEREMOVED,this.mapTileRemoved.bind(this)),this.warpedMapList.addEventListener(oT.IMAGEINFOLOADED,this.imageInfoLoaded.bind(this)),this.warpedMapList.addEventListener(oT.WARPEDMAPADDED,this.warpedMapAdded.bind(this)),this.warpedMapList.addEventListener(oT.WARPEDMAPREMOVED,this.warpedMapRemoved.bind(this)),this.warpedMapList.addEventListener(oT.PRECHANGE,this.preChange.bind(this)),this.warpedMapList.addEventListener(oT.TRANSFORMATIONCHANGED,this.transformationChanged.bind(this)),this.warpedMapList.addEventListener(oT.DISTORTIONCHANGED,this.distortionChanged.bind(this))}removeEventListeners(){this.tileCache.removeEventListener(oT.MAPTILELOADED,this.mapTileLoaded.bind(this)),this.tileCache.removeEventListener(oT.MAPTILEREMOVED,this.mapTileRemoved.bind(this)),this.warpedMapList.removeEventListener(oT.IMAGEINFOLOADED,this.imageInfoLoaded.bind(this)),this.warpedMapList.removeEventListener(oT.WARPEDMAPADDED,this.warpedMapAdded.bind(this)),this.warpedMapList.removeEventListener(oT.WARPEDMAPREMOVED,this.warpedMapRemoved.bind(this)),this.warpedMapList.removeEventListener(oT.PRECHANGE,this.preChange.bind(this)),this.warpedMapList.removeEventListener(oT.TRANSFORMATIONCHANGED,this.transformationChanged.bind(this)),this.warpedMapList.removeEventListener(oT.DISTORTIONCHANGED,this.distortionChanged.bind(this))}}var as=`#version 300 es

precision highp float;

float easing(float t) {
  return t;

  
  
}

uniform mat4 u_renderTransform;
uniform float u_animationProgress;

in vec2 a_resourceTrianglePoint;
in vec2 a_clipPreviousTrianglePoint;
in vec2 a_clipTrianglePoint;
in float a_previousTrianglePointDistortion;
in float a_trianglePointDistortion;
in float a_trianglePointIndex;

out vec2 v_resourceTrianglePoint;
out float v_trianglePointDistortion;
out float v_trianglePointIndex;
out vec4 v_trianglePointBarycentric;

void main() {
  
  vec2 clipTrianglePoint = mix(a_clipPreviousTrianglePoint, a_clipTrianglePoint, easing(u_animationProgress));
  float trianglePointDistortion = mix(a_previousTrianglePointDistortion, a_trianglePointDistortion, easing(u_animationProgress));

  
  
  

  gl_Position = u_renderTransform * vec4(clipTrianglePoint, 0.0f, 1.0f);

  
  v_resourceTrianglePoint = a_resourceTrianglePoint;
  v_trianglePointDistortion = trianglePointDistortion;
  v_trianglePointIndex = a_trianglePointIndex;

  float trianglePointLocalIndex = mod(a_trianglePointIndex, 3.0);
  if(trianglePointLocalIndex == 0.0) v_trianglePointBarycentric = vec4(1.0, 0, 0, 1.0);
  if(trianglePointLocalIndex == 1.0) v_trianglePointBarycentric = vec4(0.0, 1.0, 0, 1.0);
  if(trianglePointLocalIndex == 2.0) v_trianglePointBarycentric = vec4(0.0, 0, 1.0, 1.0);
}`,an=`#version 300 es

precision highp float;
precision highp isampler2D;

#ifndef SPECTRAL
#define SPECTRAL

const int SPECTRAL_SIZE = 38;
const float SPECTRAL_GAMMA = 2.4;
const float SPECTRAL_EPSILON = 0.0001;

float spectral_uncompand(float x) {
  return (x < 0.04045) ? x / 12.92 : pow((x + 0.055) / 1.055, SPECTRAL_GAMMA);
}

float spectral_compand(float x) {
  return (x < 0.0031308) ? x * 12.92 : 1.055 * pow(x, 1.0 / SPECTRAL_GAMMA) - 0.055;
}

vec3 spectral_srgb_to_linear(vec3 srgb) {
    return vec3(spectral_uncompand(srgb[0]), spectral_uncompand(srgb[1]), spectral_uncompand(srgb[2]));
}

vec3 spectral_linear_to_srgb(vec3 lrgb) {
    return clamp(vec3(spectral_compand(lrgb[0]), spectral_compand(lrgb[1]), spectral_compand(lrgb[2])), 0.0, 1.0);
}

void spectral_upsampling(vec3 lrgb, out float w, out float c, out float m, out float y, out float r, out float g, out float b) {
    w = min(lrgb.r, min(lrgb.g, lrgb.b));

    lrgb -= w;

    c = min(lrgb.g, lrgb.b);
    m = min(lrgb.r, lrgb.b);
    y = min(lrgb.r, lrgb.g);
    r = min(max(0., lrgb.r - lrgb.b), max(0., lrgb.r - lrgb.g));
    g = min(max(0., lrgb.g - lrgb.b), max(0., lrgb.g - lrgb.r));
    b = min(max(0., lrgb.b - lrgb.g), max(0., lrgb.b - lrgb.r));
}

void spectral_linear_to_reflectance(vec3 lrgb, inout float R[SPECTRAL_SIZE]) {
    float w, c, m, y, r, g, b;

    spectral_upsampling(lrgb, w, c, m, y, r, g, b);

     R[0] = max(SPECTRAL_EPSILON, w + c * 0.96853629 + m * 0.51567122 + y * 0.02055257 + r * 0.03147571 + g * 0.49108579 + b * 0.97901834);
     R[1] = max(SPECTRAL_EPSILON, w + c * 0.96855103 + m * 0.54015520 + y * 0.02059936 + r * 0.03146636 + g * 0.46944057 + b * 0.97901649);
     R[2] = max(SPECTRAL_EPSILON, w + c * 0.96859338 + m * 0.62645502 + y * 0.02062723 + r * 0.03140624 + g * 0.40165780 + b * 0.97901118);
     R[3] = max(SPECTRAL_EPSILON, w + c * 0.96877345 + m * 0.75595012 + y * 0.02073387 + r * 0.03119611 + g * 0.24490420 + b * 0.97892146);
     R[4] = max(SPECTRAL_EPSILON, w + c * 0.96942204 + m * 0.92826996 + y * 0.02114202 + r * 0.03053888 + g * 0.06826880 + b * 0.97858555);
     R[5] = max(SPECTRAL_EPSILON, w + c * 0.97143709 + m * 0.97223624 + y * 0.02233154 + r * 0.02856855 + g * 0.02732883 + b * 0.97743705);
     R[6] = max(SPECTRAL_EPSILON, w + c * 0.97541862 + m * 0.98616174 + y * 0.02556857 + r * 0.02459485 + g * 0.01360600 + b * 0.97428075);
     R[7] = max(SPECTRAL_EPSILON, w + c * 0.98074186 + m * 0.98955255 + y * 0.03330189 + r * 0.01929520 + g * 0.01000187 + b * 0.96663223);
     R[8] = max(SPECTRAL_EPSILON, w + c * 0.98580992 + m * 0.98676237 + y * 0.05185294 + r * 0.01423112 + g * 0.01284127 + b * 0.94822893);
     R[9] = max(SPECTRAL_EPSILON, w + c * 0.98971194 + m * 0.97312575 + y * 0.10087639 + r * 0.01033111 + g * 0.02636635 + b * 0.89937713);
    R[10] = max(SPECTRAL_EPSILON, w + c * 0.99238027 + m * 0.91944277 + y * 0.24000413 + r * 0.00765876 + g * 0.07058713 + b * 0.76070164);
    R[11] = max(SPECTRAL_EPSILON, w + c * 0.99409844 + m * 0.32564851 + y * 0.53589066 + r * 0.00593693 + g * 0.70421692 + b * 0.46420440);
    R[12] = max(SPECTRAL_EPSILON, w + c * 0.99517200 + m * 0.13820628 + y * 0.79874659 + r * 0.00485616 + g * 0.85473994 + b * 0.20123039);
    R[13] = max(SPECTRAL_EPSILON, w + c * 0.99576545 + m * 0.05015143 + y * 0.91186529 + r * 0.00426186 + g * 0.95081565 + b * 0.08808402);
    R[14] = max(SPECTRAL_EPSILON, w + c * 0.99593552 + m * 0.02912336 + y * 0.95399623 + r * 0.00409039 + g * 0.97170370 + b * 0.04592894);
    R[15] = max(SPECTRAL_EPSILON, w + c * 0.99564041 + m * 0.02421691 + y * 0.97137099 + r * 0.00438375 + g * 0.97651888 + b * 0.02860373);
    R[16] = max(SPECTRAL_EPSILON, w + c * 0.99464769 + m * 0.02660696 + y * 0.97939505 + r * 0.00537525 + g * 0.97429245 + b * 0.02060067);
    R[17] = max(SPECTRAL_EPSILON, w + c * 0.99229579 + m * 0.03407586 + y * 0.98345207 + r * 0.00772962 + g * 0.97012917 + b * 0.01656701);
    R[18] = max(SPECTRAL_EPSILON, w + c * 0.98638762 + m * 0.04835936 + y * 0.98553736 + r * 0.01366120 + g * 0.94258630 + b * 0.01451549);
    R[19] = max(SPECTRAL_EPSILON, w + c * 0.96829712 + m * 0.00011720 + y * 0.98648905 + r * 0.03181352 + g * 0.99989207 + b * 0.01357964);
    R[20] = max(SPECTRAL_EPSILON, w + c * 0.89228016 + m * 0.00008554 + y * 0.98674535 + r * 0.10791525 + g * 0.99989891 + b * 0.01331243);
    R[21] = max(SPECTRAL_EPSILON, w + c * 0.53740239 + m * 0.85267882 + y * 0.98657555 + r * 0.46249516 + g * 0.13823139 + b * 0.01347661);
    R[22] = max(SPECTRAL_EPSILON, w + c * 0.15360445 + m * 0.93188793 + y * 0.98611877 + r * 0.84604333 + g * 0.06968113 + b * 0.01387181);
    R[23] = max(SPECTRAL_EPSILON, w + c * 0.05705719 + m * 0.94810268 + y * 0.98559942 + r * 0.94275572 + g * 0.05628787 + b * 0.01435472);
    R[24] = max(SPECTRAL_EPSILON, w + c * 0.03126539 + m * 0.94200977 + y * 0.98507063 + r * 0.96860996 + g * 0.06111561 + b * 0.01479836);
    R[25] = max(SPECTRAL_EPSILON, w + c * 0.02205445 + m * 0.91478045 + y * 0.98460039 + r * 0.97783966 + g * 0.08987709 + b * 0.01515250);
    R[26] = max(SPECTRAL_EPSILON, w + c * 0.01802271 + m * 0.87065445 + y * 0.98425301 + r * 0.98187757 + g * 0.13656016 + b * 0.01540513);
    R[27] = max(SPECTRAL_EPSILON, w + c * 0.01613460 + m * 0.78827548 + y * 0.98403909 + r * 0.98377315 + g * 0.22169624 + b * 0.01557233);
    R[28] = max(SPECTRAL_EPSILON, w + c * 0.01520947 + m * 0.65738359 + y * 0.98388535 + r * 0.98470202 + g * 0.32176956 + b * 0.01565710);
    R[29] = max(SPECTRAL_EPSILON, w + c * 0.01475977 + m * 0.59909403 + y * 0.98376116 + r * 0.98515481 + g * 0.36157329 + b * 0.01571025);
    R[30] = max(SPECTRAL_EPSILON, w + c * 0.01454263 + m * 0.56817268 + y * 0.98368246 + r * 0.98537114 + g * 0.48361920 + b * 0.01571916);
    R[31] = max(SPECTRAL_EPSILON, w + c * 0.01444459 + m * 0.54031997 + y * 0.98365023 + r * 0.98546685 + g * 0.46488579 + b * 0.01572133);
    R[32] = max(SPECTRAL_EPSILON, w + c * 0.01439897 + m * 0.52110241 + y * 0.98361309 + r * 0.98550011 + g * 0.47440306 + b * 0.01572502);
    R[33] = max(SPECTRAL_EPSILON, w + c * 0.01437620 + m * 0.51041094 + y * 0.98357259 + r * 0.98551031 + g * 0.48576990 + b * 0.01571717);
    R[34] = max(SPECTRAL_EPSILON, w + c * 0.01436343 + m * 0.50526577 + y * 0.98353856 + r * 0.98550741 + g * 0.49267971 + b * 0.01571905);
    R[35] = max(SPECTRAL_EPSILON, w + c * 0.01435687 + m * 0.50255080 + y * 0.98351247 + r * 0.98551323 + g * 0.49625685 + b * 0.01571059);
    R[36] = max(SPECTRAL_EPSILON, w + c * 0.01435370 + m * 0.50126452 + y * 0.98350101 + r * 0.98551563 + g * 0.49807754 + b * 0.01569728);
    R[37] = max(SPECTRAL_EPSILON, w + c * 0.01435408 + m * 0.50083021 + y * 0.98350852 + r * 0.98551547 + g * 0.49889859 + b * 0.01570020);
}

vec3 spectral_xyz_to_srgb(vec3 xyz) {
    mat3 XYZ_RGB;

    XYZ_RGB[0] = vec3( 3.24306333, -1.53837619, -0.49893282);
    XYZ_RGB[1] = vec3(-0.96896309,  1.87542451,  0.04154303);
    XYZ_RGB[2] = vec3( 0.05568392, -0.20417438,  1.05799454);

    float r = dot(XYZ_RGB[0], xyz);
    float g = dot(XYZ_RGB[1], xyz);
    float b = dot(XYZ_RGB[2], xyz);

    return spectral_linear_to_srgb(vec3(r, g, b));
}

vec3 spectral_reflectance_to_xyz(float R[SPECTRAL_SIZE]) {
    vec3 xyz = vec3(0.0);

    xyz +=  R[0] * vec3(0.00006469, 0.00000184, 0.00030502);
    xyz +=  R[1] * vec3(0.00021941, 0.00000621, 0.00103681);
    xyz +=  R[2] * vec3(0.00112057, 0.00003101, 0.00531314);
    xyz +=  R[3] * vec3(0.00376661, 0.00010475, 0.01795439);
    xyz +=  R[4] * vec3(0.01188055, 0.00035364, 0.05707758);
    xyz +=  R[5] * vec3(0.02328644, 0.00095147, 0.11365162);
    xyz +=  R[6] * vec3(0.03455942, 0.00228226, 0.17335873);
    xyz +=  R[7] * vec3(0.03722379, 0.00420733, 0.19620658);
    xyz +=  R[8] * vec3(0.03241838, 0.00668880, 0.18608237);
    xyz +=  R[9] * vec3(0.02123321, 0.00988840, 0.13995048);
    xyz += R[10] * vec3(0.01049099, 0.01524945, 0.08917453);
    xyz += R[11] * vec3(0.00329584, 0.02141831, 0.04789621);
    xyz += R[12] * vec3(0.00050704, 0.03342293, 0.02814563);
    xyz += R[13] * vec3(0.00094867, 0.05131001, 0.01613766);
    xyz += R[14] * vec3(0.00627372, 0.07040208, 0.00775910);
    xyz += R[15] * vec3(0.01686462, 0.08783871, 0.00429615);
    xyz += R[16] * vec3(0.02868965, 0.09424905, 0.00200551);
    xyz += R[17] * vec3(0.04267481, 0.09795667, 0.00086147);
    xyz += R[18] * vec3(0.05625475, 0.09415219, 0.00036904);
    xyz += R[19] * vec3(0.06947040, 0.08678102, 0.00019143);
    xyz += R[20] * vec3(0.08305315, 0.07885653, 0.00014956);
    xyz += R[21] * vec3(0.08612610, 0.06352670, 0.00009231);
    xyz += R[22] * vec3(0.09046614, 0.05374142, 0.00006813);
    xyz += R[23] * vec3(0.08500387, 0.04264606, 0.00002883);
    xyz += R[24] * vec3(0.07090667, 0.03161735, 0.00001577);
    xyz += R[25] * vec3(0.05062889, 0.02088521, 0.00000394);
    xyz += R[26] * vec3(0.03547396, 0.01386011, 0.00000158);
    xyz += R[27] * vec3(0.02146821, 0.00810264, 0.00000000);
    xyz += R[28] * vec3(0.01251646, 0.00463010, 0.00000000);
    xyz += R[29] * vec3(0.00680458, 0.00249138, 0.00000000);
    xyz += R[30] * vec3(0.00346457, 0.00125930, 0.00000000);
    xyz += R[31] * vec3(0.00149761, 0.00054165, 0.00000000);
    xyz += R[32] * vec3(0.00076970, 0.00027795, 0.00000000);
    xyz += R[33] * vec3(0.00040737, 0.00014711, 0.00000000);
    xyz += R[34] * vec3(0.00016901, 0.00006103, 0.00000000);
    xyz += R[35] * vec3(0.00009522, 0.00003439, 0.00000000);
    xyz += R[36] * vec3(0.00004903, 0.00001771, 0.00000000);
    xyz += R[37] * vec3(0.00002000, 0.00000722, 0.00000000);

    return xyz;
}

float spectral_linear_to_concentration(float l1, float l2, float t) {
    float t1 = l1 * pow(1.0 - t, 2.0);
    float t2 = l2 * pow(t, 2.0);

    return t2 / (t1 + t2);
}

vec3 spectral_mix(vec3 color1, vec3 color2, float t) {
    vec3 lrgb1 = spectral_srgb_to_linear(color1);
    vec3 lrgb2 = spectral_srgb_to_linear(color2);

    float R1[SPECTRAL_SIZE];
    float R2[SPECTRAL_SIZE];

    spectral_linear_to_reflectance(lrgb1, R1);
    spectral_linear_to_reflectance(lrgb2, R2);

    float l1 = spectral_reflectance_to_xyz(R1)[1];
    float l2 = spectral_reflectance_to_xyz(R2)[1];

    t = spectral_linear_to_concentration(l1, l2, t);

    float R[SPECTRAL_SIZE];

    for (int i = 0; i < SPECTRAL_SIZE; i++) {
      float KS = (1.0 - t) * (pow(1.0 - R1[i], 2.0) / (2.0 * R1[i])) + t * (pow(1.0 - R2[i], 2.0) / (2.0 * R2[i]));
      float KM = 1.0 + KS - sqrt(pow(KS, 2.0) + 2.0 * KS);

      
      

      R[i] = KM;
    }

    return spectral_xyz_to_srgb(spectral_reflectance_to_xyz(R));
}

vec4 spectral_mix(vec4 color1, vec4 color2, float t) {
    return vec4(spectral_mix(color1.rgb, color2.rgb, t), mix(color1.a, color2.a, t));
}

#endif
float easing(float t) {
  return t;

  
  
}

uniform float u_debug;

uniform bool u_removeColor;
uniform vec3 u_removeColorOptionsColor;
uniform float u_removeColorOptionsThreshold;
uniform float u_removeColorOptionsHardness;

uniform bool u_colorize;
uniform vec3 u_colorizeOptionsColor;

uniform bool u_grid;

uniform float u_opacity;
uniform float u_saturation;

uniform bool u_distortion;
uniform int u_distortionOptionsdistortionMeasure;

uniform int u_currentBestScaleFactor;

uniform lowp sampler2DArray u_cachedTilesTextureArray;
uniform isampler2D u_cachedTilesResourcePositionsAndDimensionsTexture;
uniform isampler2D u_cachedTilesScaleFactorsTexture;

uniform vec4 u_colorDistortion00;
uniform vec4 u_colorDistortion01;
uniform vec4 u_colorDistortion1;
uniform vec4 u_colorDistortion2;
uniform vec4 u_colorDistortion3;
uniform vec4 u_colorGrid;

in vec2 v_resourceTrianglePoint;
in float v_trianglePointDistortion;
in float v_trianglePointIndex;
in vec4 v_trianglePointBarycentric;

out vec4 color;

void main() {
  float resourceTrianglePointX = v_resourceTrianglePoint.x;
  float resourceTrianglePointY = v_resourceTrianglePoint.y;

  
  ivec3 cachedTilesTextureSize = textureSize(u_cachedTilesTextureArray, 0);
  int cachedTilesCount = cachedTilesTextureSize.z;

  
  int smallestScaleFactor = int(pow(2.0, 8.0)); 
  bool found = false;
  int foundIndex;

  
  vec3 cachedTilesTexturePoint = vec3(0.0f, 0.0f, 0.0f);

  
  color = vec4(0.0f, 0.0f, 0.0f, 0.0f);;

  
  for(int index = 0; index < cachedTilesCount; index += 1) {

    
    float cachedTileResourcePositionX = float(texelFetch(u_cachedTilesResourcePositionsAndDimensionsTexture, ivec2(0, (index * 4)), 0));
    float cachedTileResourcePositionY = float(texelFetch(u_cachedTilesResourcePositionsAndDimensionsTexture, ivec2(0, (index * 4) + 1), 0));
    float cachedTileDimensionWidth = float(texelFetch(u_cachedTilesResourcePositionsAndDimensionsTexture, ivec2(0, (index * 4) + 2), 0));
    float cachedTileDimensionHeight = float(texelFetch(u_cachedTilesResourcePositionsAndDimensionsTexture, ivec2(0, (index * 4) + 3), 0));

    int cachedTileScaleFactor = texelFetch(u_cachedTilesScaleFactorsTexture, ivec2(0, index), 0).r;

    
    if(resourceTrianglePointX >= cachedTileResourcePositionX &&
      resourceTrianglePointX < cachedTileResourcePositionX + cachedTileDimensionWidth &&
      resourceTrianglePointY >= cachedTileResourcePositionY &&
      resourceTrianglePointY < cachedTileResourcePositionY + cachedTileDimensionHeight) {

      
      
      
      
      if(cachedTileScaleFactor < smallestScaleFactor) {
        smallestScaleFactor = cachedTileScaleFactor;
        found = true;
        foundIndex = index;

        float cachedTilePointX = (resourceTrianglePointX - cachedTileResourcePositionX) / float(cachedTileScaleFactor);
        float cachedTilePointY = (resourceTrianglePointY - cachedTileResourcePositionY) / float(cachedTileScaleFactor);

        float cachedTilesTexturePointX = cachedTilePointX / float(cachedTilesTextureSize.x);
        float cachedTilesTexturePointY = cachedTilePointY / float(cachedTilesTextureSize.y);

        cachedTilesTexturePoint = vec3(cachedTilesTexturePointX, cachedTilesTexturePointY, index);
      }
    }
  }

  if(found == true) {
    
    color = texture(u_cachedTilesTextureArray, cachedTilesTexturePoint);

    if(u_removeColorOptionsThreshold > 0.0f) {
  vec3 backgroundColorDiff = color.rgb - u_removeColorOptionsColor.rgb;
  float backgroundColorDistance = length(backgroundColorDiff);
  if(u_removeColor && backgroundColorDistance < u_removeColorOptionsThreshold) {
    float amount = smoothstep(u_removeColorOptionsThreshold - u_removeColorOptionsThreshold * (1.0f - u_removeColorOptionsHardness), u_removeColorOptionsThreshold, backgroundColorDistance);
    color = vec4(color.rgb * amount, amount);
  }
}

float gray = 0.21f * color.r + 0.71f * color.g + 0.07f * color.b;
color = vec4(color.rgb * (u_saturation) + (gray * (1.0f - u_saturation)), color.a);

if(u_colorize) {
  color = vec4((u_colorizeOptionsColor + color.rgb) * color.a, color.a);
}

color = vec4(color.rgb * u_opacity, color.a * u_opacity);
    if(u_distortion) {
  
  

  float trianglePointDistortion = v_trianglePointDistortion;

  
  trianglePointDistortion = floor(trianglePointDistortion * 10.0f) / 10.0f;

  switch(u_distortionOptionsdistortionMeasure) {
    case 0:
      if(trianglePointDistortion > 0.0f) {
        color = spectral_mix(color, u_colorDistortion00, trianglePointDistortion);
      } else {
        color = spectral_mix(color, u_colorDistortion01, abs(trianglePointDistortion));
      }
      break;
    case 1:
      color = spectral_mix(color, u_colorDistortion1, trianglePointDistortion);
      break;
    case 2:
      color = spectral_mix(color, u_colorDistortion2, trianglePointDistortion);
      break;
    case 3:
      color = trianglePointDistortion == -1.0f ? u_colorDistortion3 : color;
      break;
    default:
      color = color;
  }
}

if(u_grid) {
  float gridSize = 20.0f * float(u_currentBestScaleFactor);
  float gridWidth = 2.0f * float(u_currentBestScaleFactor);
  if(mod(float(resourceTrianglePointX) + gridWidth / 2.0f, gridSize) < gridWidth || mod(float(resourceTrianglePointY) + gridWidth / 2.0f, gridSize) < gridWidth) {
    color = u_colorGrid;
  }
}
    if(bool(u_debug)) {
  
  

  float dist = 0.99; 
  if(
    v_trianglePointBarycentric.x + v_trianglePointBarycentric.y > dist ||
    v_trianglePointBarycentric.y + v_trianglePointBarycentric.z > dist ||
    v_trianglePointBarycentric.z + v_trianglePointBarycentric.x > dist
  )
  color = vec4(0, 0, 0, 1);
}
  }
}`,aa=`#version 300 es

precision highp float;

float easing(float t) {
  return t;

  
  
}

uniform mat4 u_projectedGeoToViewportTransform;
uniform mat4 u_viewportToClipTransform;
uniform float u_animationProgress;

in vec2 a_projectedGeoPoint;
in vec2 a_projectedGeoOtherPoint;
in vec2 a_projectedGeoPreviousPoint;
in vec2 a_projectedGeoPreviousOtherPoint;
in float a_isOtherPoint;
in float a_normalSign;
in float a_viewportSize;
in vec4 a_color;
in float a_viewportBorderSize;
in vec4 a_borderColor;

out float v_viewportLineLength;
out vec2 v_linePoint;
out float v_viewportSize;
out vec4 v_color;
out float v_viewportBorderSize;
out vec4 v_borderColor;
out float v_viewportFeatherSize;
out float v_viewportTotalSize;

void main() {
  vec2 projectedGeoPoint = mix(a_projectedGeoPreviousPoint, a_projectedGeoPoint, easing(u_animationProgress));
  vec2 projectedGeoOtherPoint = mix(a_projectedGeoPreviousOtherPoint, a_projectedGeoOtherPoint, easing(u_animationProgress));

  vec2 viewportPoint = (u_projectedGeoToViewportTransform * vec4(projectedGeoPoint, 0.0f, 1.0f)).xy;
  vec2 viewportOtherPoint = (u_projectedGeoToViewportTransform * vec4(projectedGeoOtherPoint, 0.0f, 1.0f)).xy;

  vec2 viewportLine = vec2(viewportOtherPoint.x-viewportPoint.x, viewportOtherPoint.y-viewportPoint.y);
  vec2 viewportNormalizedLine = normalize(viewportLine);
  vec2 viewportNormalizedLineNormal = vec2(viewportNormalizedLine.y, -viewportNormalizedLine.x);
  v_viewportLineLength = length(viewportLine);

  v_viewportFeatherSize = 1.0;

  
  
  
  float viewportSize = a_viewportSize / 2.0;
  float viewportBorderSize = a_viewportBorderSize / 2.0;
  v_viewportFeatherSize = v_viewportFeatherSize / 2.0;

  v_viewportTotalSize = viewportSize + viewportBorderSize + v_viewportFeatherSize;
  float lineX = -1.0 * v_viewportTotalSize / 2.0 + a_isOtherPoint * (v_viewportLineLength + 2.0 * (v_viewportTotalSize / 2.0));
  float lineY = a_normalSign * v_viewportTotalSize / 2.0;
  v_linePoint = vec2(lineX, lineY);
  
  
  
  
  
  

  v_viewportSize = viewportSize;
  v_color = a_color;
  v_viewportBorderSize = viewportBorderSize;
  v_borderColor = a_borderColor;

  gl_Position = u_viewportToClipTransform * vec4(viewportPoint + lineX * viewportNormalizedLine + lineY * viewportNormalizedLineNormal, 0, 1);
}`,al=`#version 300 es

precision highp float;
precision highp isampler2D;

in float v_viewportLineLength;
in vec2 v_linePoint;
in float v_viewportSize;
in vec4 v_color;
in float v_viewportBorderSize;
in vec4 v_borderColor;
in float v_viewportFeatherSize;
in float v_viewportTotalSize;

out vec4 color;

void main() {
  float distance;
  if (v_linePoint.x < 0.0) {
    distance = length(v_linePoint - vec2(0.0,0.0)) / (v_viewportTotalSize / 2.0);
  } else if (v_linePoint.x > v_viewportLineLength) {
    distance = length(v_linePoint - vec2(v_viewportLineLength,0.0)) / (v_viewportTotalSize / 2.0);
  } else {
    distance = abs(v_linePoint.y) / (v_viewportTotalSize / 2.0);
  }
  if (distance > 1.0) {
    discard;
  }
  float viewportDistance = distance * v_viewportTotalSize / 2.0;

  
  color = vec4(0, 0, 0, 0);
  if (v_viewportSize >= v_viewportFeatherSize) {
    color = v_color;
  }

  
  
  
  float borderSmoothStep;
  if(v_viewportBorderSize >= v_viewportFeatherSize) {
    borderSmoothStep = smoothstep(
      v_viewportSize / 2.0 - v_viewportBorderSize / 2.0 - v_viewportFeatherSize / 2.0,
      v_viewportSize / 2.0 - v_viewportBorderSize / 2.0 + v_viewportFeatherSize / 2.0,
      viewportDistance
    );
    color = ((1.0 - borderSmoothStep) * color) + (borderSmoothStep * v_borderColor);
  }

  
  
  
  borderSmoothStep = smoothstep(
      v_viewportSize / 2.0 + v_viewportBorderSize / 2.0 - v_viewportFeatherSize / 2.0,
      v_viewportSize / 2.0 + v_viewportBorderSize / 2.0 + v_viewportFeatherSize / 2.0,
      viewportDistance
  );
  color = ((1.0 - borderSmoothStep) * color) + (borderSmoothStep * vec4(0, 0, 0, 0));
}`,ah=`#version 300 es

precision highp float;

float easing(float t) {
  return t;

  
  
}

uniform mat4 u_projectedGeoToViewportTransform;
uniform mat4 u_viewportToClipTransform;
uniform float u_animationProgress;

in float a_viewportSize;
in vec4 a_color;
in float a_viewportBorderSize;
in vec4 a_borderColor;

in vec2 a_projectedGeoPoint;
in vec2 a_projectedGeoPreviousPoint;

out float v_viewportSize;
out vec4 v_color;
out float v_viewportBorderSize;
out vec4 v_borderColor;
out float v_viewportFeatherSize;
out float v_viewportTotalSize;

void main() {
  vec2 projectedGeoPoint = mix(a_projectedGeoPreviousPoint, a_projectedGeoPoint, easing(u_animationProgress));

  gl_Position = u_viewportToClipTransform * u_projectedGeoToViewportTransform * vec4(projectedGeoPoint, 0.0f, 1.0f);

  v_viewportFeatherSize = 1.0;

  v_viewportTotalSize = a_viewportSize + a_viewportBorderSize + v_viewportFeatherSize;
  gl_PointSize = v_viewportTotalSize;
  
  
  
  
  
  
  

  v_viewportSize = a_viewportSize;
  v_color = a_color;
  v_viewportBorderSize = a_viewportBorderSize;
  v_borderColor = a_borderColor;
}`,au=`#version 300 es

precision highp float;
precision highp isampler2D;

in float v_viewportSize;
in vec4 v_color;
in float v_viewportBorderSize;
in vec4 v_borderColor;
in float v_viewportFeatherSize;
in float v_viewportTotalSize;

out vec4 color;

void main() {
  
  float distance = length(2.0 * gl_PointCoord - 1.0);
  if (distance > 1.0) {
    discard;
  }
  float viewportDistance = distance * v_viewportTotalSize / 2.0;

  
  color = vec4(0, 0, 0, 0);
  if (v_viewportSize >= v_viewportFeatherSize) {
    color = v_color;
  }

  
  
  
  float borderSmoothStep;
  if(v_viewportBorderSize >= v_viewportFeatherSize) {
    borderSmoothStep = smoothstep(
      v_viewportSize / 2.0 - v_viewportBorderSize / 2.0 - v_viewportFeatherSize / 2.0,
      v_viewportSize / 2.0 - v_viewportBorderSize / 2.0 + v_viewportFeatherSize / 2.0,
      viewportDistance
    );
    color = ((1.0 - borderSmoothStep) * color) + (borderSmoothStep * v_borderColor);
  }

  
  
  
  borderSmoothStep = smoothstep(
      v_viewportSize / 2.0 + v_viewportBorderSize / 2.0 - v_viewportFeatherSize / 2.0,
      v_viewportSize / 2.0 + v_viewportBorderSize / 2.0 + v_viewportFeatherSize / 2.0,
      viewportDistance
  );
  color = ((1.0 - borderSmoothStep) * color) + (borderSmoothStep * vec4(0, 0, 0, 0));
}`;let ac={leading:!0,trailing:!0},ad={leading:!0,trailing:!0};class ap extends ao{gl;mapsProgram;pointsProgram;linesProgram;previousSignificantViewport;opacity=1;saturation=1;renderOptions={};invertedRenderTransform;lastAnimationFrameRequestId;animating=!1;transformationTransitionStart;animationProgress=0;disableRender=!1;throttledPrepareRenderInternal;throttledChanged;constructor(e,t){let r=sH(e,e.VERTEX_SHADER,as),i=sH(e,e.FRAGMENT_SHADER,an),o=sH(e,e.VERTEX_SHADER,ah),s=sH(e,e.FRAGMENT_SHADER,au),n=sH(e,e.VERTEX_SHADER,aa),a=sH(e,e.FRAGMENT_SHADER,al),l=sY(e,r,i),h=sY(e,o,s),u=sY(e,n,a);super(ar.createFactory(),(t,r,i)=>new s8(t,r,e,l,u,h,i),t),this.gl=e,this.mapsProgram=l,this.pointsProgram=h,this.linesProgram=u,e.deleteShader(r),e.deleteShader(i),e.deleteShader(r),e.deleteShader(i),e.deleteShader(r),e.deleteShader(i),e.disable(e.DEPTH_TEST),this.invertedRenderTransform=[1,0,0,1,0,0],this.addEventListeners(),this.throttledPrepareRenderInternal=sI(this.prepareRenderInternal.bind(this),200,ac),this.throttledChanged=sI(this.changed.bind(this),50,ad)}initializeWebGL(e){let t=sH(e,e.VERTEX_SHADER,as),r=sH(e,e.FRAGMENT_SHADER,an),i=sH(e,e.VERTEX_SHADER,ah),o=sH(e,e.FRAGMENT_SHADER,au),s=sH(e,e.VERTEX_SHADER,aa),n=sH(e,e.FRAGMENT_SHADER,al),a=sY(e,t,r),l=sY(e,i,o),h=sY(e,s,n);for(let t of(this.gl=e,this.mapsProgram=a,this.pointsProgram=l,this.linesProgram=h,e.disable(e.DEPTH_TEST),this.warpedMapList.getWarpedMaps()))t.initializeWebGL(a,l,h)}getOpacity(){return this.opacity}setOpacity(e){this.opacity=e}resetOpacity(){this.opacity=1}getMapOpacity(e){let t=this.warpedMapList.getWarpedMap(e);if(t)return t.opacity}setMapOpacity(e,t){let r=this.warpedMapList.getWarpedMap(e);r&&(r.opacity=Math.min(Math.max(t,0),1))}resetMapOpacity(e){let t=this.warpedMapList.getWarpedMap(e);t&&(t.opacity=1)}getRemoveColorOptions(){return this.renderOptions.removeColorOptions}setRemoveColorOptions(e){this.renderOptions.removeColorOptions=e}resetRemoveColorOptions(){this.renderOptions.removeColorOptions=void 0}getMapRemoveColorOptions(e){let t=this.warpedMapList.getWarpedMap(e);if(t)return t.renderOptions.removeColorOptions}setMapRemoveColorOptions(e,t){let r=this.warpedMapList.getWarpedMap(e);r&&(r.renderOptions.removeColorOptions=t)}resetMapRemoveColorOptions(e){let t=this.warpedMapList.getWarpedMap(e);t&&(t.renderOptions.removeColorOptions=void 0)}getColorizeOptions(){return this.renderOptions.colorizeOptions}setColorizeOptions(e){this.renderOptions.colorizeOptions=e}resetColorizeOptions(){this.renderOptions.colorizeOptions=void 0}getMapColorizeOptions(e){let t=this.warpedMapList.getWarpedMap(e);if(t)return t.renderOptions.colorizeOptions}setMapColorizeOptions(e,t){let r=this.warpedMapList.getWarpedMap(e);r&&(r.renderOptions.colorizeOptions=t)}resetMapColorizeOptions(e){let t=this.warpedMapList.getWarpedMap(e);t&&(t.renderOptions.colorizeOptions=void 0)}getGridOptions(){return this.renderOptions.gridOptions}setGridOptions(e){this.renderOptions.gridOptions=e}resetGridOptions(){this.renderOptions.gridOptions=void 0}getMapGridOptions(e){let t=this.warpedMapList.getWarpedMap(e);if(t)return t.renderOptions.gridOptions}setMapGridOptions(e,t){let r=this.warpedMapList.getWarpedMap(e);r&&(r.renderOptions.gridOptions=t)}resetMapGridOptions(e){let t=this.warpedMapList.getWarpedMap(e);t&&(t.renderOptions.gridOptions=void 0)}getSaturation(){return this.saturation}setSaturation(e){this.saturation=e}resetSaturation(){this.saturation=1}getMapSaturation(e){let t=this.warpedMapList.getWarpedMap(e);if(t)return t.saturation}setMapSaturation(e,t){let r=this.warpedMapList.getWarpedMap(e);r&&(r.saturation=t)}resetMapSaturation(e){let t=this.warpedMapList.getWarpedMap(e);t&&(t.saturation=1)}render(e){this.disableRender||(this.viewport=e,this.loadMissingImageInfosInViewport(),this.someImageInfosInViewport()&&this.throttledPrepareRenderInternal(),this.renderInternal())}clear(){this.warpedMapList.clear(),this.mapsInViewport=new Set,this.mapsWithRequestedTilesForViewport=new Set,this.gl.clear(this.gl.DEPTH_BUFFER_BIT|this.gl.COLOR_BUFFER_BIT),this.tileCache.clear()}cancelThrottledFunctions(){this.throttledPrepareRenderInternal.cancel(),this.throttledChanged.cancel()}destroy(){for(let e of(this.cancelThrottledFunctions(),this.warpedMapList.getWarpedMaps()))this.removeEventListenersFromWebGL2WarpedMap(e);this.removeEventListeners(),super.destroy(),this.gl.deleteProgram(this.mapsProgram)}prepareRenderInternal(){this.requestFetchableTiles(),this.updateVertexBuffers()}shouldRequestFetchableTiles(){if(!this.viewport||this.animating)return!1;if(!this.previousSignificantViewport)return this.previousSignificantViewport=this.viewport,!0;{let e=[];for(let t=0;t<4;t++)e.push(A(this.previousSignificantViewport.projectedGeoRectangle[t],this.viewport.projectedGeoRectangle[t])/Math.pow(this.viewport.projectedGeoPerViewportScale,2));let t=Math.max(...e);return 0===t||t>25&&(this.previousSignificantViewport=this.viewport,!0)}}shouldAnticipateInteraction(){return!0}updateVertexBuffers(){if(this.viewport)for(let e of(this.invertedRenderTransform=n(this.viewport.projectedGeoToClipTransform),this.mapsWithRequestedTilesForViewport)){let t=this.warpedMapList.getWarpedMap(e);if(!t)break;t.updateVertexBuffers(this.viewport.projectedGeoToClipTransform)}}renderInternal(){if(!this.viewport)return;let e=this.gl;e.viewport(0,0,e.canvas.width,e.canvas.height),e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),this.renderMapsInternal(),this.renderLinesInternal(),this.renderPointsInternal()}renderMapsInternal(){if(!this.viewport)return;let e=function(e,t){let r=e[0],i=e[1],o=e[2],s=e[3],n=e[4],a=e[5],l=t[0],h=t[1],u=t[2],c=t[3],d=t[4],p=t[5];return[r*l+o*h,i*l+s*h,r*u+o*c,i*u+s*c,r*d+o*p+n,i*d+s*p+a]}(this.viewport.projectedGeoToClipTransform,this.invertedRenderTransform),t=this.gl,r=this.mapsProgram;t.useProgram(r);let i=t.getUniformLocation(r,"u_debug");t.uniform1f(i,0);let o=t.getUniformLocation(r,"u_renderTransform");t.uniformMatrix4fv(o,!1,a(e));let s=t.getUniformLocation(r,"u_animationProgress");t.uniform1f(s,this.animationProgress);let n=t.getUniformLocation(r,"u_colorDistortion00");t.uniform4f(n,...en(sZ),1);let l=t.getUniformLocation(r,"u_colorDistortion01");t.uniform4f(l,...en(sV),1);let h=t.getUniformLocation(r,"u_colorDistortion1");t.uniform4f(h,...en(sq),1);let u=t.getUniformLocation(r,"u_colorDistortion2");t.uniform4f(u,...en(s$),1);let c=t.getUniformLocation(r,"u_colorDistortion3");t.uniform4f(c,...en(sZ),1);let d=t.getUniformLocation(r,"u_colorGrid");for(let e of(t.uniform4f(d,...en(sC),1),this.mapsWithRequestedTilesForViewport)){let i=this.warpedMapList.getWarpedMap(e);if(!i)continue;this.setRenderOptionsUniforms(this.renderOptions,i.renderOptions);let o=t.getUniformLocation(r,"u_opacity");t.uniform1f(o,this.opacity*i.opacity);let s=t.getUniformLocation(r,"u_saturation");t.uniform1f(s,this.saturation*i.saturation);let n=t.getUniformLocation(r,"u_distortion");if(t.uniform1f(n,+!!i.distortionMeasure),i.distortionMeasure){let e=t.getUniformLocation(r,"u_distortionOptionsdistortionMeasure");t.uniform1i(e,oM.indexOf(i.distortionMeasure))}let a=t.getUniformLocation(r,"u_currentBestScaleFactor"),l=i.currentBestScaleFactor;t.uniform1i(a,l);let h=t.getUniformLocation(r,"u_cachedTilesTextureArray");t.uniform1i(h,0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D_ARRAY,i.cachedTilesTextureArray);let u=t.getUniformLocation(r,"u_cachedTilesResourcePositionsAndDimensionsTexture");t.uniform1i(u,2),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,i.cachedTilesResourcePositionsAndDimensionsTexture);let c=t.getUniformLocation(r,"u_cachedTilesScaleFactorsTexture");t.uniform1i(c,3),t.activeTexture(t.TEXTURE3),t.bindTexture(t.TEXTURE_2D,i.cachedTilesScaleFactorsTexture);let d=i.resourceTrianglePoints.length,p=this.gl.TRIANGLES;t.bindVertexArray(i.mapsVao),t.drawArrays(p,0,d)}}renderLinesInternal(){if(!this.viewport)return;let e=this.gl,t=this.linesProgram;e.useProgram(t);let r=e.getUniformLocation(t,"u_projectedGeoToViewportTransform");e.uniformMatrix4fv(r,!1,a(this.viewport.projectedGeoToViewportTransform));let i=e.getUniformLocation(t,"u_viewportToClipTransform");e.uniformMatrix4fv(i,!1,a(this.viewport.viewportToClipTransform));let o=e.getUniformLocation(t,"u_animationProgress");for(let t of(e.uniform1f(o,this.animationProgress),this.mapsWithRequestedTilesForViewport)){let r=this.warpedMapList.getWarpedMap(t);if(!r)continue;let i=6*r.lineLayers.reduce((e,t)=>e+t.projectedGeoLines.length,0),o=this.gl.TRIANGLES;e.bindVertexArray(r.linesVao),e.drawArrays(o,0,i)}}renderPointsInternal(){if(!this.viewport)return;let e=this.gl,t=this.pointsProgram;e.useProgram(t);let r=e.getUniformLocation(t,"u_projectedGeoToViewportTransform");e.uniformMatrix4fv(r,!1,a(this.viewport.projectedGeoToViewportTransform));let i=e.getUniformLocation(t,"u_viewportToClipTransform");e.uniformMatrix4fv(i,!1,a(this.viewport.viewportToClipTransform));let o=e.getUniformLocation(t,"u_animationProgress");for(let t of(e.uniform1f(o,this.animationProgress),this.mapsWithRequestedTilesForViewport)){let r=this.warpedMapList.getWarpedMap(t);if(!r)continue;let i=r.pointLayers.reduce((e,t)=>e+t.projectedGeoPoints.length,0),o=this.gl.POINTS;e.bindVertexArray(r.pointsVao),e.drawArrays(o,0,i)}}setRenderOptionsUniforms(e,t){let r=this.gl,i=this.mapsProgram,o={removeColorOptions:{color:t.removeColorOptions?.color||e.removeColorOptions?.color,hardness:ea(t.removeColorOptions?.hardness,e.removeColorOptions?.hardness),threshold:ea(t.removeColorOptions?.threshold,e.removeColorOptions?.threshold)},colorizeOptions:{...e.colorizeOptions,...t.colorizeOptions},gridOptions:{...e.gridOptions,...t.gridOptions}},s=o.removeColorOptions?.color,n=r.getUniformLocation(i,"u_removeColor");if(r.uniform1f(n,+!!s),s){let e=r.getUniformLocation(i,"u_removeColorOptionsColor");r.uniform3fv(e,s);let t=r.getUniformLocation(i,"u_removeColorOptionsThreshold");r.uniform1f(t,o.removeColorOptions?.threshold||0);let n=r.getUniformLocation(i,"u_removeColorOptionsHardness");r.uniform1f(n,o.removeColorOptions?.hardness||.7)}let a=o.colorizeOptions?.color,l=r.getUniformLocation(i,"u_colorize");if(r.uniform1f(l,+!!a),a){let e=r.getUniformLocation(i,"u_colorizeOptionsColor");r.uniform3fv(e,a)}let h=o.gridOptions?.enabled,u=r.getUniformLocation(i,"u_grid");r.uniform1f(u,+!!h)}startTransformationTransition(){void 0!==this.lastAnimationFrameRequestId&&cancelAnimationFrame(this.lastAnimationFrameRequestId),this.animating=!0,this.transformationTransitionStart=void 0,this.lastAnimationFrameRequestId=requestAnimationFrame(this.transformationTransitionFrame.bind(this))}transformationTransitionFrame(e){if(this.transformationTransitionStart||(this.transformationTransitionStart=e),e-this.transformationTransitionStart<750)this.animationProgress=(e-this.transformationTransitionStart)/750,this.renderInternal(),this.lastAnimationFrameRequestId=requestAnimationFrame(this.transformationTransitionFrame.bind(this));else{for(let e of this.warpedMapList.getWarpedMaps())e.resetPrevious();this.updateVertexBuffers(),this.animating=!1,this.animationProgress=0,this.transformationTransitionStart=void 0,this.changed()}}changed(){this.dispatchEvent(new oE(oT.CHANGED))}imageInfoLoaded(e){e instanceof oE&&this.dispatchEvent(new oE(oT.IMAGEINFOLOADED))}clearMap(e){let t=this.warpedMapList.getWarpedMap(e);t&&t.clearTextures()}mapTileLoaded(e){if(e instanceof oE){let{mapId:t,tileUrl:r}=e.data,i=this.tileCache.getCacheableTile(r);if(!i||!i.isCachedTile())return;let o=this.warpedMapList.getWarpedMap(t);o&&o.addCachedTileAndUpdateTextures(i)}}mapTileRemoved(e){if(e instanceof oE){let{mapId:t,tileUrl:r}=e.data,i=this.warpedMapList.getWarpedMap(t);i&&i.removeCachedTileAndUpdateTextures(r)}}warpedMapAdded(e){if(e instanceof oE){let t=e.data,r=this.warpedMapList.getWarpedMap(t);r&&this.addEventListenersToWebGL2WarpedMap(r)}}preChange(e){if(e instanceof oE){let t=e.data;for(let e of this.warpedMapList.getWarpedMaps(t))this.animating&&e.mixPreviousAndNew(1-this.animationProgress)}}transformationChanged(e){e instanceof oE&&(this.updateVertexBuffers(),this.startTransformationTransition())}distortionChanged(e){e instanceof oE&&(this.updateVertexBuffers(),this.startTransformationTransition())}addEventListenersToWebGL2WarpedMap(e){e.addEventListener(oT.TEXTURESUPDATED,this.throttledChanged.bind(this))}removeEventListenersFromWebGL2WarpedMap(e){e.removeEventListener(oT.TEXTURESUPDATED,this.throttledChanged.bind(this))}contextLost(){for(let e of(this.disableRender=!0,this.cancelThrottledFunctions(),this.warpedMapList.getWarpedMaps()))e.cancelThrottledFunctions();this.tileCache.clear()}contextRestored(){this.initializeWebGL(this.gl),this.disableRender=!1}}function af(e){if(!e)throw Error("Renderer not defined. Add the layer to a map before calling this function.")}class am{id="warped-map-layer";type="custom";renderingMode="2d";map;renderer;options;constructor(e,t){e&&(this.id=e),this.options=t}onAdd(e,t){this.map=e,this.renderer=new ap(t,this.options),this.addEventListeners()}onRemove(){this.renderer&&(this.removeEventListeners(),this.renderer.destroy())}async addGeoreferenceAnnotation(e){af(this.renderer);let t=await this.renderer.warpedMapList.addGeoreferenceAnnotation(e);return this.map?.triggerRepaint(),t}async removeGeoreferenceAnnotation(e){af(this.renderer);let t=await this.renderer.warpedMapList.removeGeoreferenceAnnotation(e);return this.map?.triggerRepaint(),t}async addGeoreferenceAnnotationByUrl(e){let t=await fetch(e).then(e=>e.json());return this.addGeoreferenceAnnotation(t)}async removeGeoreferenceAnnotationByUrl(e){let t=await fetch(e).then(e=>e.json());return this.removeGeoreferenceAnnotation(t)}async addGeoreferencedMap(e){af(this.renderer);let t=this.renderer.warpedMapList.addGeoreferencedMap(e);return this.map?.triggerRepaint(),t}async removeGeoreferencedMap(e){af(this.renderer);let t=this.renderer.warpedMapList.removeGeoreferencedMap(e);return this.map?.triggerRepaint(),t}getWarpedMapList(){return af(this.renderer),this.renderer.warpedMapList}getWarpedMap(e){return af(this.renderer),this.renderer.warpedMapList.getWarpedMap(e)}showMap(e){af(this.renderer),this.renderer.warpedMapList.showMaps([e]),this.map?.triggerRepaint()}showMaps(e){af(this.renderer),this.renderer.warpedMapList.showMaps(e),this.map?.triggerRepaint()}hideMap(e){af(this.renderer),this.renderer.warpedMapList.hideMaps([e]),this.map?.triggerRepaint()}hideMaps(e){af(this.renderer),this.renderer.warpedMapList.hideMaps(e),this.map?.triggerRepaint()}isMapVisible(e){return af(this.renderer),this.renderer.warpedMapList.getWarpedMap(e)?.visible}setMapResourceMask(e,t){af(this.renderer),this.renderer.warpedMapList.setMapResourceMask(e,t),this.map?.triggerRepaint()}setMapsTransformationType(e,t){af(this.renderer),this.renderer.warpedMapList.setMapsTransformationType(e,t),this.map?.triggerRepaint()}setMapsDistortionMeasure(e,t){af(this.renderer),this.renderer.warpedMapList.setMapsDistortionMeasure(e,t),this.map?.triggerRepaint()}getBounds(){af(this.renderer);let e=this.renderer.warpedMapList.getBbox();if(e)return[[e[0],e[1]],[e[2],e[3]]]}bringMapsToFront(e){af(this.renderer),this.renderer.warpedMapList.bringMapsToFront(e),this.map?.triggerRepaint()}sendMapsToBack(e){af(this.renderer),this.renderer.warpedMapList.sendMapsToBack(e),this.map?.triggerRepaint()}bringMapsForward(e){af(this.renderer),this.renderer.warpedMapList.bringMapsForward(e),this.map?.triggerRepaint()}sendMapsBackward(e){af(this.renderer),this.renderer.warpedMapList.sendMapsBackward(e),this.map?.triggerRepaint()}getMapZIndex(e){return af(this.renderer),this.renderer.warpedMapList.getMapZIndex(e)}setImageInformations(e){af(this.renderer),this.renderer.warpedMapList.setImageInformations(e)}getOpacity(){return af(this.renderer),this.renderer.getOpacity()}setOpacity(e){af(this.renderer),this.renderer.setOpacity(e),this.map?.triggerRepaint()}resetOpacity(){af(this.renderer),this.renderer.resetOpacity(),this.map?.triggerRepaint()}getMapOpacity(e){return af(this.renderer),this.renderer.getMapOpacity(e)}setMapOpacity(e,t){af(this.renderer),this.renderer.setMapOpacity(e,t),this.map?.triggerRepaint()}resetMapOpacity(e){af(this.renderer),this.renderer.resetMapOpacity(e),this.map?.triggerRepaint()}setSaturation(e){af(this.renderer),this.renderer.setSaturation(e),this.map?.triggerRepaint()}resetSaturation(){af(this.renderer),this.renderer.resetSaturation(),this.map?.triggerRepaint()}setMapSaturation(e,t){af(this.renderer),this.renderer.setMapSaturation(e,t),this.map?.triggerRepaint()}resetMapSaturation(e){af(this.renderer),this.renderer.resetMapSaturation(e),this.map?.triggerRepaint()}setRemoveColor(e){af(this.renderer);let t=e.hexColor?en(e.hexColor):void 0;this.renderer.setRemoveColorOptions({color:t,threshold:e.threshold,hardness:e.hardness}),this.map?.triggerRepaint()}resetRemoveColor(){af(this.renderer),this.renderer.resetRemoveColorOptions(),this.map?.triggerRepaint()}setMapRemoveColor(e,t){af(this.renderer);let r=t.hexColor?en(t.hexColor):void 0;this.renderer.setMapRemoveColorOptions(e,{color:r,threshold:t.threshold,hardness:t.hardness}),this.map?.triggerRepaint()}resetMapRemoveColor(e){af(this.renderer),this.renderer.resetMapRemoveColorOptions(e)}setColorize(e){af(this.renderer);let t=en(e);t&&(this.renderer.setColorizeOptions({color:t}),this.map?.triggerRepaint())}resetColorize(){af(this.renderer),this.renderer.resetColorizeOptions(),this.map?.triggerRepaint()}setMapColorize(e,t){af(this.renderer);let r=en(t);r&&(this.renderer.setMapColorizeOptions(e,{color:r}),this.map?.triggerRepaint())}resetMapColorize(e){af(this.renderer),this.renderer.resetMapColorizeOptions(e),this.map?.triggerRepaint()}clear(){af(this.renderer),this.renderer.clear(),this.map?.triggerRepaint()}preparerender(){}render(){if(!this.map||!this.renderer)return;let e=this.map.getCanvas(),t=[e.width/window.devicePixelRatio,e.height/window.devicePixelRatio],r=this.map.getCenter(),i=eM([r.lng,r.lat]),o=this.map.unproject([0,t[1]]),s=this.map.unproject([t[0],t[1]]),n=this.map.unproject([t[0],0]),a=this.map.unproject([0,0]),l=eM([o.lng,o.lat]),h=eM([s.lng,s.lat]),u=ei(er([l,h,eM([n.lng,n.lat]),eM([a.lng,a.lat])]),t),c=new eE(t,i,u,-(this.map.getBearing()/180)*Math.PI,window.devicePixelRatio);this.renderer.render(c)}contextLost(){this.renderer?.contextLost()}contextRestored(){this.renderer?.contextRestored()}addEventListeners(){this.renderer&&this.map&&(this.map.on("webglcontextlost",this.contextLost.bind(this)),this.map.on("webglcontextrestored",this.contextRestored.bind(this)),this.renderer.addEventListener(oT.CHANGED,this.render.bind(this)),this.renderer.addEventListener(oT.IMAGEINFOLOADED,this.render.bind(this)),this.renderer.addEventListener(oT.WARPEDMAPENTER,this.passWarpedMapEvent.bind(this)),this.renderer.addEventListener(oT.WARPEDMAPLEAVE,this.passWarpedMapEvent.bind(this)),this.renderer.tileCache.addEventListener(oT.FIRSTMAPTILELOADED,this.passWarpedMapEvent.bind(this)),this.renderer.tileCache.addEventListener(oT.ALLREQUESTEDTILESLOADED,this.passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.addEventListener(oT.GEOREFERENCEANNOTATIONADDED,this.passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.addEventListener(oT.WARPEDMAPADDED,this.passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.addEventListener(oT.WARPEDMAPREMOVED,this.passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.addEventListener(oT.VISIBILITYCHANGED,this.render.bind(this)),this.renderer.warpedMapList.addEventListener(oT.CLEARED,this.render.bind(this)))}removeEventListeners(){this.renderer&&this.map&&(this.map.off("webglcontextlost",this.contextLost.bind(this)),this.map.off("webglcontextrestored",this.contextRestored.bind(this)),this.renderer.removeEventListener(oT.CHANGED,this.render.bind(this)),this.renderer.removeEventListener(oT.IMAGEINFOLOADED,this.render.bind(this)),this.renderer.removeEventListener(oT.WARPEDMAPENTER,this.passWarpedMapEvent.bind(this)),this.renderer.removeEventListener(oT.WARPEDMAPLEAVE,this.passWarpedMapEvent.bind(this)),this.renderer.tileCache.removeEventListener(oT.FIRSTMAPTILELOADED,this.passWarpedMapEvent.bind(this)),this.renderer.tileCache.removeEventListener(oT.ALLREQUESTEDTILESLOADED,this.passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.removeEventListener(oT.GEOREFERENCEANNOTATIONADDED,this.passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.removeEventListener(oT.WARPEDMAPADDED,this.passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.removeEventListener(oT.WARPEDMAPREMOVED,this.passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.removeEventListener(oT.VISIBILITYCHANGED,this.render.bind(this)),this.renderer.warpedMapList.removeEventListener(oT.CLEARED,this.render.bind(this)))}passWarpedMapEvent(e){e instanceof oE&&this.map&&this.map.fire(e.type,e.data)}}}}]);